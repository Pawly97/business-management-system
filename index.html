<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lindan Equities - Professional Banking Dashboard</title>
  
  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf/0.10.1/html2pdf.bundle.min.js"></script>
  
  <style>
    /* Professional Banking Color Palette - Money Green */
    :root {
      --primary-green: #1b5e20;
      --secondary-green: #2e7d32;
      --accent-green: #4caf50;
      --light-green: #c8e6c9;
      --dark-gray: #1a1a1a;
      --medium-gray: #424242;
      --light-gray: #f5f5f5;
      --text-dark: #212121;
      --text-light: #616161;
      --white: #ffffff;
      --border-color: #bdbdbd;
      --error-red: #c62828;
      --warning-orange: #f57c00;
      --success-green: #2e7d32;
      --accent-gold: #fbc02d;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--light-gray);
      color: var(--text-dark);
      line-height: 1.6;
    }

    .hidden {
      display: none !important;
    }

    /* ===== LOGIN SCREEN ===== */
    #loginScreen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .login-container {
      background: var(--white);
      border-radius: 12px;
      padding: 2rem;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .login-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .login-logo {
      max-width: 200px;
      height: auto;
      margin-bottom: 1rem;
    }

    .login-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary-green);
      margin-bottom: 0.5rem;
    }

    .login-subtitle {
      font-size: 0.9rem;
      color: var(--text-light);
    }

    .form-group {
      margin-bottom: 1.2rem;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-dark);
      font-size: 0.9rem;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-green);
      background: rgba(27, 94, 32, 0.05);
    }

    .btn {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
    }

    .btn-primary {
      background: var(--primary-green);
      color: var(--white);
      width: 100%;
    }

    .btn-primary:hover {
      background: var(--secondary-green);
      box-shadow: 0 4px 12px rgba(27, 94, 32, 0.3);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary-green);
      color: var(--primary-green);
    }

    .btn-outline:hover {
      background: var(--primary-green);
      color: var(--white);
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    .btn-danger {
      background: var(--error-red);
      color: var(--white);
    }

    .btn-danger:hover {
      background: #b71c1c;
    }

    .btn-warning {
      background: var(--warning-orange);
      color: var(--white);
    }

    .btn-success {
      background: var(--success-green);
      color: var(--white);
    }

    .login-error {
      background: #ffebee;
      color: var(--error-red);
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      display: none;
      border-left: 4px solid var(--error-red);
    }

    .login-error.show {
      display: block;
    }

    .login-help {
      background: #e8f5e9;
      padding: 1rem;
      border-radius: 6px;
      font-size: 0.85rem;
      color: var(--text-light);
      margin-top: 1rem;
      border-left: 4px solid var(--success-green);
    }

    /* ===== MAIN APPLICATION ===== */
    #mainApp {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--light-gray);
    }

    /* Header */
    header.app-header {
      background: linear-gradient(90deg, var(--primary-green) 0%, var(--secondary-green) 100%);
      color: var(--white);
      padding: 0.8rem 2rem;
      display: flex;
      align-items: center;
      gap: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 100;
    }

    header.app-header::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-gold) 0%, var(--accent-green) 100%);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      flex: 0;
    }

    select.app-switcher {
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      background: var(--white);
      color: var(--primary-green);
      transition: all 0.3s ease;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%231b5e20' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.7rem center;
      padding-right: 2.5rem;
    }

    select.app-switcher:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .logo-container {
      display: flex;
      align-items: center;
      height: 50px;
    }

    .logo-container img {
      height: 50px;
      width: auto;
      max-width: 250px;
      object-fit: contain;
      filter: brightness(1.1);
    }

    .header-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .prime-rate-display {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      padding: 0.6rem 1.2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
    }

    .prime-rate-display:hover {
      background: rgba(255, 255, 255, 0.25);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    button.btn-logout {
      background: transparent;
      border: 2px solid var(--white);
      border-radius: 6px;
      color: var(--white);
      padding: 0.5rem 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button.btn-logout:hover {
      background: var(--accent-gold);
      border-color: var(--accent-gold);
      color: var(--primary-green);
    }

    /* Main Layout */
    .app-main {
      display: flex;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    /* Sidebar */
    aside.sidebar {
      width: 280px;
      background: var(--white);
      border-right: 1px solid var(--border-color);
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
      overflow-y: auto;
      padding: 1rem 0;
    }

    .sidebar-nav {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .sidebar-nav li {
      margin: 0;
    }

    .nav-link {
      display: flex;
      align-items: center;
      padding: 1rem 1.5rem;
      cursor: pointer;
      gap: 1rem;
      color: var(--text-light);
      border-right: 4px solid transparent;
      font-weight: 500;
      user-select: none;
      transition: all 0.3s ease;
    }

    .nav-link:hover {
      background: rgba(46, 125, 50, 0.08);
      color: var(--primary-green);
      border-right-color: var(--accent-green);
    }

    .nav-link.active {
      background: var(--light-green);
      color: var(--primary-green);
      border-right-color: var(--primary-green);
      font-weight: 700;
    }

    .nav-icon {
      flex-shrink: 0;
      font-size: 1.3rem;
      width: 24px;
      text-align: center;
    }

    .nav-text {
      flex: 1;
    }

    /* Main Content */
    main.main-content {
      flex: 1;
      overflow-y: auto;
      background: var(--light-gray);
      padding: 2rem;
    }

    /* Views */
    .view {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .view.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .view-header {
      margin-bottom: 2rem;
    }

    .view-header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
    }

    .view-header p {
      color: var(--text-light);
      font-size: 0.9rem;
    }

    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .metric-card {
      background: var(--white);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--border-color);
      border-top: 4px solid var(--accent-green);
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }

    .metric-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .metric-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-green);
    }

    .metric-change {
      font-size: 0.8rem;
      margin-top: 0.5rem;
      padding: 0.4rem 0;
    }

    .change-positive {
      color: var(--success-green);
    }

    .change-negative {
      color: var(--error-red);
    }

    /* Tables */
    .table-wrapper {
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--border-color);
      overflow: hidden;
      margin-bottom: 2rem;
    }

    .table-header {
      background: var(--light-green);
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .table-header h3 {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary-green);
      margin: 0;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th {
      background: var(--light-green);
      padding: 1rem 1.5rem;
      text-align: left;
      font-weight: 700;
      color: var(--primary-green);
      border-bottom: 2px solid var(--border-color);
      white-space: nowrap;
    }

    td {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-dark);
    }

    tbody tr:hover {
      background: rgba(46, 125, 50, 0.03);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    /* Status Badges */
    .badge {
      display: inline-block;
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      white-space: nowrap;
    }

    .badge-paid {
      background: #c8e6c9;
      color: var(--primary-green);
    }

    .badge-pending {
      background: #fff9c4;
      color: #f57f17;
    }

    .badge-overdue {
      background: #ffcdd2;
      color: var(--error-red);
    }

    .badge-partial {
      background: #ffe0b2;
      color: #e65100;
    }

    .badge-active {
      background: #c8e6c9;
      color: var(--primary-green);
    }

    .badge-inactive {
      background: #eeeeee;
      color: var(--medium-gray);
    }

    .badge-fixed {
      background: #bbdefb;
      color: #1565c0;
    }

    .badge-variable {
      background: #f8bbd0;
      color: #c2185b;
    }

    /* Button Group */
    .btn-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn-group .btn {
      margin: 0;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal-content {
      background: var(--white);
      border-radius: 12px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      background: var(--light-green);
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary-green);
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-light);
      transition: color 0.3s ease;
    }

    .modal-close:hover {
      color: var(--text-dark);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    /* Form */
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-dark);
      font-size: 0.9rem;
    }

    .form-control, textarea, select {
      padding: 0.75rem;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.9rem;
      transition: border-color 0.3s ease;
      font-family: inherit;
    }

    .form-control:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary-green);
      background: rgba(27, 94, 32, 0.02);
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    /* Notifications */
    #notificationContainer {
      position: fixed;
      top: 2rem;
      right: 2rem;
      z-index: 2000;
      max-width: 400px;
    }

    .notification {
      background: var(--white);
      border-left: 4px solid var(--success-green);
      padding: 1rem 1.5rem;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-bottom: 1rem;
      animation: slideInRight 0.3s ease;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification.error {
      border-left-color: var(--error-red);
    }

    .notification.warning {
      border-left-color: var(--warning-orange);
    }

    /* Notes Section */
    .notes-section {
      background: #f5f5f5;
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 2rem;
    }

    .notes-section h3 {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary-green);
      margin-bottom: 1rem;
    }

    .note-item {
      background: var(--white);
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      border-left: 4px solid var(--accent-green);
    }

    .note-meta {
      font-size: 0.8rem;
      color: var(--text-light);
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
    }

    .note-text {
      color: var(--text-dark);
      line-height: 1.6;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .app-main {
        flex-direction: column;
      }

      aside.sidebar {
        width: 100%;
        height: auto;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
        padding: 0;
      }

      .sidebar-nav {
        display: flex;
        flex-direction: row;
        overflow-x: auto;
      }

      .sidebar-nav li {
        flex-shrink: 0;
      }

      .nav-link {
        padding: 1rem;
        border-right: none;
        border-bottom: 3px solid transparent;
      }

      .nav-link.active {
        border-right: none;
        border-bottom-color: var(--primary-green);
      }

      main.main-content {
        padding: 1rem;
      }

      header.app-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }

      .header-right {
        width: 100%;
        margin-left: 0;
        justify-content: space-between;
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .modal-content {
        max-width: 95%;
        max-height: 95vh;
      }

      #notificationContainer {
        left: 1rem;
        right: 1rem;
        top: 1rem;
        max-width: none;
      }
    }

    .calendar-container {
      background: var(--white);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-bottom: 2rem;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .calendar-header h3 {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary-green);
      margin: 0;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      background: var(--light-gray);
      position: relative;
    }

    .calendar-day.event {
      background: var(--light-green);
      color: var(--primary-green);
    }

    .calendar-day.today {
      border: 2px solid var(--primary-green);
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div id="loginScreen">
    <div class="login-container">
      <div class="login-header">
        <img src="Lindan Logo.jpg" alt="Lindan Equities" class="login-logo" />
        <h1 class="login-title">Lindan Equities</h1>
        <p class="login-subtitle">Professional Business Management System</p>
      </div>

      <div id="loginError" class="login-error"></div>

      <form id="loginForm">
        <div class="form-group">
          <label class="form-label">Username</label>
          <input id="username" class="form-control" type="text" value="admin" required />
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input id="password" class="form-control" type="password" value="admin123" required />
        </div>
        <button type="submit" class="btn btn-primary">Access System</button>
      </form>

      <div class="login-help">
        <strong>Demo Credentials:</strong><br>
        Username: admin | Password: admin123
      </div>
    </div>
  </div>

  <!-- MAIN APPLICATION -->
  <div id="mainApp" class="hidden">
    <header class="app-header">
      <div class="header-left">
        <select id="appModeSelector" class="app-switcher">
          <option value="loan">Loan Management</option>
          <option value="realestate">Real Estate Management</option>
        </select>
        <div class="logo-container">
          <img src="Lindan Logo.jpg" alt="Lindan Equities" />
        </div>
      </div>

      <div class="header-right">
        <div class="prime-rate-display" id="primeRateDisplay">
          Prime Rate: <span id="primeRateValue">5.50</span>%
        </div>
        <span id="userDisplay">Welcome, Admin</span>
        <button id="logoutBtn" class="btn btn-logout">Logout</button>
      </div>
    </header>

    <div class="app-main">
      <aside class="sidebar">
        <ul class="sidebar-nav" id="sidebarNav"></ul>
      </aside>

      <main class="main-content">
        <!-- Dashboard View -->
        <section id="dashboard" class="view active">
          <div class="view-header">
            <h1>Portfolio Dashboard</h1>
            <p>Real-time overview of your loans and properties</p>
          </div>
          <div id="dashboardMetrics" class="dashboard-grid"></div>
          <div id="calendarSection" class="calendar-container hidden">
            <div class="calendar-header">
              <h3>Upcoming Events</h3>
              <div>
                <button class="btn btn-sm btn-outline" id="prevMonthBtn">Previous</button>
                <button class="btn btn-sm btn-outline" id="nextMonthBtn">Next</button>
              </div>
            </div>
            <div id="calendarGrid" class="calendar-grid"></div>
          </div>
        </section>

        <!-- LOAN MANAGEMENT VIEWS -->

        <!-- All Loans View -->
        <section id="loans" class="view">
          <div class="view-header">
            <h1>All Loans</h1>
            <p>Manage your loan portfolio</p>
          </div>
          <div style="margin-bottom: 1rem;">
            <button class="btn btn-primary" id="addLoanBtn">Add New Loan</button>
            <button class="btn btn-outline" id="exportLoansExcelBtn">Export to Excel</button>
          </div>
          <div class="table-wrapper">
            <div class="table-container">
              <table id="loansTable">
                <thead>
                  <tr>
                    <th>Borrower</th>
                    <th>Amount</th>
                    <th>Balance</th>
                    <th>Rate</th>
                    <th>Type</th>
                    <th>Term</th>
                    <th>Payment</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="loansBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Payment Schedule View -->
        <section id="payment-schedule" class="view">
          <div class="view-header">
            <h1>Payment Schedule</h1>
            <p>Track loan payments and collections</p>
          </div>
          <div class="form-row" style="margin-bottom: 1.5rem;">
            <select id="loanFilterDropdown" class="form-control">
              <option value="">All Loans</option>
            </select>
            <select id="statusFilterDropdown" class="form-control">
              <option value="">All Statuses</option>
              <option value="upcoming">Upcoming</option>
              <option value="paid">Paid</option>
              <option value="overdue">Overdue</option>
              <option value="partial">Partial</option>
            </select>
            <button class="btn btn-outline" id="exportScheduleExcelBtn">Export Schedule</button>
          </div>
          <div class="table-wrapper">
            <div class="table-container">
              <table id="paymentScheduleTable">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Borrower</th>
                    <th>Principal</th>
                    <th>Interest</th>
                    <th>Payment</th>
                    <th>Balance</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="scheduleBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Loan Details/Edit View -->
        <section id="loan-details" class="view">
          <div class="view-header">
            <h1 id="loanDetailTitle">Loan Details</h1>
          </div>
          <div style="margin-bottom: 1rem;">
            <button class="btn btn-outline" id="backToLoansBtn">Back to Loans</button>
            <button class="btn btn-primary" id="exportLoanPdfBtn">Export Annual Statement</button>
          </div>
          <div class="table-wrapper">
            <div class="table-header">
              <h3>Loan Information</h3>
            </div>
            <div style="padding: 1.5rem;">
              <div class="form-row">
                <div>
                  <label class="form-label">Borrower Name</label>
                  <p id="detailBorrowerName">-</p>
                </div>
                <div>
                  <label class="form-label">Original Amount</label>
                  <p id="detailOriginalAmount">-</p>
                </div>
                <div>
                  <label class="form-label">Current Balance</label>
                  <p id="detailCurrentBalance">-</p>
                </div>
              </div>
              <div class="form-row">
                <div>
                  <label class="form-label">Interest Rate</label>
                  <p id="detailRate">-</p>
                </div>
                <div>
                  <label class="form-label">Rate Type</label>
                  <p id="detailRateType">-</p>
                </div>
                <div>
                  <label class="form-label">Term (Months)</label>
                  <p id="detailTerm">-</p>
                </div>
              </div>
              <div class="form-row">
                <div>
                  <label class="form-label">Monthly Payment</label>
                  <p id="detailMonthlyPayment">-</p>
                </div>
                <div>
                  <label class="form-label">Start Date</label>
                  <p id="detailStartDate">-</p>
                </div>
                <div>
                  <label class="form-label">Maturity Date</label>
                  <p id="detailMaturityDate">-</p>
                </div>
              </div>
            </div>
          </div>

          <div class="table-wrapper">
            <div class="table-header">
              <h3>Payment History & Schedule</h3>
            </div>
            <div class="table-container">
              <table id="loanScheduleDetailTable">
                <thead>
                  <tr>
                    <th>Payment #</th>
                    <th>Date</th>
                    <th>Principal</th>
                    <th>Interest</th>
                    <th>Payment</th>
                    <th>Balance</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="loanScheduleDetailBody"></tbody>
              </table>
            </div>
          </div>

          <div class="notes-section">
            <h3>Account Notes</h3>
            <div style="margin-bottom: 1rem;">
              <textarea id="noteInput" class="form-control" placeholder="Add a note..."></textarea>
              <button class="btn btn-primary" id="addNoteBtn" style="margin-top: 0.5rem;">Add Note</button>
            </div>
            <div id="notesList"></div>
          </div>
        </section>

        <!-- REAL ESTATE MANAGEMENT VIEWS -->

        <!-- Properties View -->
        <section id="properties" class="view">
          <div class="view-header">
            <h1>Properties</h1>
            <p>Manage your real estate portfolio</p>
          </div>
          <div style="margin-bottom: 1rem;">
            <button class="btn btn-primary" id="addPropertyBtn">Add Property</button>
            <button class="btn btn-outline" id="exportPropertiesExcelBtn">Export to Excel</button>
          </div>
          <div class="table-wrapper">
            <div class="table-container">
              <table id="propertiesTable">
                <thead>
                  <tr>
                    <th>Address</th>
                    <th>Type</th>
                    <th>Value</th>
                    <th>Tenants</th>
                    <th>Monthly Rent</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="propertiesBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Tenants View -->
        <section id="tenants" class="view">
          <div class="view-header">
            <h1>Tenants</h1>
            <p>Manage tenant information and leases</p>
          </div>
          <div style="margin-bottom: 1rem;">
            <button class="btn btn-primary" id="addTenantBtn">Add Tenant</button>
            <button class="btn btn-outline" id="exportTenantsExcelBtn">Export to Excel</button>
          </div>
          <div class="table-wrapper">
            <div class="table-container">
              <table id="tenantsTable">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Property</th>
                    <th>Unit</th>
                    <th>Lease Start</th>
                    <th>Lease End</th>
                    <th>Rent</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="tenantsBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Rent Schedule View -->
        <section id="rent-schedule" class="view">
          <div class="view-header">
            <h1>Rent Payment Schedule</h1>
            <p>Track rent collections and tenancy</p>
          </div>
          <div class="form-row" style="margin-bottom: 1.5rem;">
            <select id="propertyFilterDropdown" class="form-control">
              <option value="">All Properties</option>
            </select>
            <select id="rentStatusFilterDropdown" class="form-control">
              <option value="">All Statuses</option>
              <option value="upcoming">Upcoming</option>
              <option value="paid">Paid</option>
              <option value="overdue">Overdue</option>
            </select>
            <button class="btn btn-outline" id="exportRentScheduleExcelBtn">Export Schedule</button>
          </div>
          <div class="table-wrapper">
            <div class="table-container">
              <table id="rentScheduleTable">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Tenant</th>
                    <th>Property</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="rentScheduleBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Reports View -->
        <section id="reports" class="view">
          <div class="view-header">
            <h1>Reports & Analytics</h1>
            <p>Comprehensive financial reports and analysis</p>
          </div>
          
          <div class="table-wrapper">
            <div class="table-header">
              <h3>Prime Rate History</h3>
            </div>
            <div style="padding: 1.5rem;">
              <button class="btn btn-primary" id="updatePrimeRateBtn">Update Prime Rate</button>
            </div>
            <div class="table-container">
              <table id="primeHistoryTable">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Rate</th>
                    <th>Previous Rate</th>
                    <th>Change</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tbody id="primeHistoryBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Settings View -->
        <section id="settings" class="view">
          <div class="view-header">
            <h1>System Settings</h1>
            <p>Configure system parameters and preferences</p>
          </div>
          <div class="table-wrapper">
            <div class="table-header">
              <h3>System Configuration</h3>
            </div>
            <div style="padding: 1.5rem;">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Current Prime Rate (%)</label>
                  <input type="number" id="settingsPrimeRate" class="form-control" step="0.01" min="0" max="50" />
                </div>
              </div>
              <button class="btn btn-primary" id="savePrimeRateBtn">Save Changes</button>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal Container -->
  <div id="modalContainer"></div>

  <!-- Notification Container -->
  <div id="notificationContainer"></div>

  <script>
    // ===== PROFESSIONAL BANKING SYSTEM =====
    // Production-ready code with comprehensive features

    class BankingSystem {
      constructor() {
        this.currentUser = null;
        this.currentMode = 'loan';
        this.currentView = 'dashboard';

        // Initialize data
        this.primeRate = parseFloat(localStorage.getItem('primeRate')) || 5.50;
        this.primeRateHistory = JSON.parse(localStorage.getItem('primeRateHistory')) || [];

        this.loans = JSON.parse(localStorage.getItem('loans')) || [];
        this.payments = JSON.parse(localStorage.getItem('payments')) || [];
        this.properties = JSON.parse(localStorage.getItem('properties')) || [];
        this.tenants = JSON.parse(localStorage.getItem('tenants')) || [];
        this.rentPayments = JSON.parse(localStorage.getItem('rentPayments')) || [];
        this.tranches = JSON.parse(localStorage.getItem('tranches')) || [];
        this.notes = JSON.parse(localStorage.getItem('notes')) || [];
        this.users = JSON.parse(localStorage.getItem('users')) || this.getDefaultUsers();

        this.initEventListeners();
      }

      getDefaultUsers() {
        return [
          { id: 1, username: 'admin', password: 'admin123', name: 'Administrator', role: 'admin', email: 'admin@lindan.com' },
          { id: 2, username: 'manager', password: 'manager123', name: 'Manager', role: 'manager', email: 'manager@lindan.com' },
          { id: 3, username: 'user', password: 'user123', name: 'User', role: 'user', email: 'user@lindan.com' },
        ];
      }

      initEventListeners() {
        // Login
        document.getElementById('loginForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleLogin();
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => this.handleLogout());

        // Mode switching
        document.getElementById('appModeSelector').addEventListener('change', (e) => {
          this.switchMode(e.target.value);
        });

        // Navigation
        document.addEventListener('click', (e) => {
          if (e.target.closest('.nav-link')) {
            const view = e.target.closest('.nav-link').getAttribute('data-view');
            this.showView(view);
          }
        });

        // Loan Management
        document.getElementById('addLoanBtn')?.addEventListener('click', () => this.showAddLoanModal());
        document.getElementById('exportLoansExcelBtn')?.addEventListener('click', () => this.exportLoansExcel());
        document.getElementById('exportScheduleExcelBtn')?.addEventListener('click', () => this.exportPaymentScheduleExcel());
        document.getElementById('exportLoanPdfBtn')?.addEventListener('click', () => this.showPdfExportModal());
        document.getElementById('backToLoansBtn')?.addEventListener('click', () => this.showView('loans'));

        // Real Estate Management
        document.getElementById('addPropertyBtn')?.addEventListener('click', () => this.showAddPropertyModal());
        document.getElementById('addTenantBtn')?.addEventListener('click', () => this.showAddTenantModal());
        document.getElementById('exportPropertiesExcelBtn')?.addEventListener('click', () => this.exportPropertiesExcel());
        document.getElementById('exportTenantsExcelBtn')?.addEventListener('click', () => this.exportTenantsExcel());
        document.getElementById('exportRentScheduleExcelBtn')?.addEventListener('click', () => this.exportRentScheduleExcel());

        // Reports
        document.getElementById('updatePrimeRateBtn')?.addEventListener('click', () => this.showUpdatePrimeRateModal());
        document.getElementById('savePrimeRateBtn')?.addEventListener('click', () => this.savePrimeRateFromSettings());

        // Prime Rate Display
        document.getElementById('primeRateDisplay')?.addEventListener('click', () => this.showUpdatePrimeRateModal());

        // Action handlers
        document.addEventListener('click', (e) => {
          if (e.target.classList.contains('btn-edit-loan')) {
            this.editLoan(parseInt(e.target.getAttribute('data-loan-id')));
          }
          if (e.target.classList.contains('btn-delete-loan')) {
            this.deleteLoan(parseInt(e.target.getAttribute('data-loan-id')));
          }
          if (e.target.classList.contains('btn-tranche')) {
            this.showTrancheModal(parseInt(e.target.getAttribute('data-loan-id')));
          }
          if (e.target.classList.contains('btn-pay')) {
            const paymentId = parseInt(e.target.getAttribute('data-payment-id'));
            this.recordPayment(paymentId, 'paid');
          }
          if (e.target.classList.contains('btn-miss')) {
            const paymentId = parseInt(e.target.getAttribute('data-payment-id'));
            this.recordPayment(paymentId, 'overdue');
          }
          if (e.target.classList.contains('btn-partial')) {
            const paymentId = parseInt(e.target.getAttribute('data-payment-id'));
            this.showPartialPaymentModal(paymentId);
          }
          if (e.target.classList.contains('btn-edit-property')) {
            this.editProperty(parseInt(e.target.getAttribute('data-property-id')));
          }
          if (e.target.classList.contains('btn-delete-property')) {
            this.deleteProperty(parseInt(e.target.getAttribute('data-property-id')));
          }
          if (e.target.classList.contains('btn-edit-tenant')) {
            this.editTenant(parseInt(e.target.getAttribute('data-tenant-id')));
          }
          if (e.target.classList.contains('btn-delete-tenant')) {
            this.deleteTenant(parseInt(e.target.getAttribute('data-tenant-id')));
          }
          if (e.target.id === 'addNoteBtn') {
            this.addNote();
          }
        });

        // Filter dropdowns
        document.getElementById('loanFilterDropdown')?.addEventListener('change', () => this.renderPaymentSchedule());
        document.getElementById('statusFilterDropdown')?.addEventListener('change', () => this.renderPaymentSchedule());
        document.getElementById('propertyFilterDropdown')?.addEventListener('change', () => this.renderRentSchedule());
        document.getElementById('rentStatusFilterDropdown')?.addEventListener('change', () => this.renderRentSchedule());
      }

      // ===== LOGIN MANAGEMENT =====
      handleLogin() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('loginError');

        const user = this.users.find(u => u.username === username && u.password === password);

        if (user) {
          this.currentUser = user;
          errorDiv.classList.remove('show');
          document.getElementById('loginScreen').classList.add('hidden');
          document.getElementById('mainApp').classList.remove('hidden');
          document.getElementById('userDisplay').textContent = `Welcome, ${user.name}`;
          this.initializeMainApp();
        } else {
          errorDiv.textContent = 'Invalid username or password';
          errorDiv.classList.add('show');
        }
      }

      handleLogout() {
        this.currentUser = null;
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('username').value = 'admin';
        document.getElementById('password').value = 'admin123';
      }

      initializeMainApp() {
        this.updateNavigation();
        this.updatePrimeRateDisplay();
        this.populateFilters();
        this.renderDashboard();
      }

      // ===== NAVIGATION & VIEWS =====
      updateNavigation() {
        const navItems = this.currentMode === 'loan' ? [
          { view: 'dashboard', label: 'Dashboard', icon: 'ðŸ“Š' },
          { view: 'loans', label: 'All Loans', icon: 'ðŸ’°' },
          { view: 'payment-schedule', label: 'Payment Schedule', icon: 'ðŸ“…' },
          { view: 'reports', label: 'Reports', icon: 'ðŸ“ˆ' },
          { view: 'settings', label: 'Settings', icon: 'âš™ï¸' },
        ] : [
          { view: 'dashboard', label: 'Dashboard', icon: 'ðŸ“Š' },
          { view: 'properties', label: 'Properties', icon: 'ðŸ¢' },
          { view: 'tenants', label: 'Tenants', icon: 'ðŸ‘¥' },
          { view: 'rent-schedule', label: 'Rent Schedule', icon: 'ðŸ“…' },
          { view: 'reports', label: 'Reports', icon: 'ðŸ“ˆ' },
          { view: 'settings', label: 'Settings', icon: 'âš™ï¸' },
        ];

        const sidebarNav = document.getElementById('sidebarNav');
        sidebarNav.innerHTML = navItems.map(item => `
          <li>
            <div class="nav-link ${this.currentView === item.view ? 'active' : ''}" data-view="${item.view}">
              <span class="nav-icon">${item.icon}</span>
              <span class="nav-text">${item.label}</span>
            </div>
          </li>
        `).join('');
      }

      switchMode(mode) {
        this.currentMode = mode;
        this.updateNavigation();
        this.showView('dashboard');
      }

      showView(viewName) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        const view = document.getElementById(viewName);
        if (view) {
          view.classList.add('active');
          this.currentView = viewName;

          document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.toggle('active', link.getAttribute('data-view') === viewName);
          });

          // Render appropriate view
          switch (viewName) {
            case 'dashboard':
              this.renderDashboard();
              break;
            case 'loans':
              this.renderLoans();
              break;
            case 'payment-schedule':
              this.renderPaymentSchedule();
              break;
            case 'loan-details':
              this.renderLoanDetails();
              break;
            case 'properties':
              this.renderProperties();
              break;
            case 'tenants':
              this.renderTenants();
              break;
            case 'rent-schedule':
              this.renderRentSchedule();
              break;
            case 'reports':
              this.renderReports();
              break;
            case 'settings':
              this.renderSettings();
              break;
          }
        }
      }

      // ===== DASHBOARD =====
      renderDashboard() {
        const container = document.getElementById('dashboardMetrics');
        if (!container) return;

        let html = '';

        if (this.currentMode === 'loan') {
          const totalLoans = this.loans.length;
          const totalBalance = this.loans.reduce((sum, l) => sum + l.currentBalance, 0);
          const totalIncome = this.loans.reduce((sum, l) => sum + l.monthlyPayment, 0);
          const overduePayments = this.payments.filter(p => p.status === 'overdue').length;

          html = `
            <div class="metric-card">
              <div class="metric-title">Active Loans</div>
              <div class="metric-value">${totalLoans}</div>
              <div class="metric-change change-positive">+2 this month</div>
            </div>
            <div class="metric-card">
              <div class="metric-title">Outstanding Balance</div>
              <div class="metric-value">$${(totalBalance / 1000000).toFixed(1)}M</div>
              <div class="metric-change change-negative">-$250K this month</div>
            </div>
            <div class="metric-card">
              <div class="metric-title">Monthly Income</div>
              <div class="metric-value">$${(totalIncome / 1000).toFixed(0)}K</div>
              <div class="metric-change change-positive">+5% YoY</div>
            </div>
            <div class="metric-card">
              <div class="metric-title">Prime Rate</div>
              <div class="metric-value">${this.primeRate.toFixed(2)}%</div>
              <div class="metric-change">Last updated today</div>
            </div>
            <div class="metric-card">
              <div class="metric-title">Overdue Payments</div>
              <div class="metric-value" style="color: var(--error-red);">${overduePayments}</div>
              <div class="metric-change change-negative">Action needed</div>
            </div>
          `;
        } else {
          const totalProperties = this.properties.length;
          const totalValue = this.properties.reduce((sum, p) => sum + (p.value || 0), 0);
          const totalRent = this.properties.reduce((sum, p) => sum + (p.monthlyRent || 0), 0);
          const occupiedUnits = this.tenants.filter(t => new Date(t.leaseEnd) > new Date()).length;

          html = `
            <div class="metric-card">
              <div class="metric-title">Total Properties</div>
              <div class="metric-value">${totalProperties}</div>
              <div class="metric-change change-positive">+1 this quarter</div>
            </div>
            <div class="metric-card">
              <div class="metric-title">Portfolio Value</div>
              <div class="metric-value">$${(totalValue / 1000000).toFixed(1)}M</div>
              <div class="metric-change change-positive">+8% YoY</div>
            </div>
            <div class="metric-card">
              <div class="metric-title">Monthly Rent Income</div>
              <div class="metric-value">$${(totalRent / 1000).toFixed(0)}K</div>
              <div class="metric-change change-positive">+3% this month</div>
            </div>
            <div class="metric-card">
              <div class="metric-title">Occupied Units</div>
              <div class="metric-value">${occupiedUnits}/${this.tenants.length}</div>
              <div class="metric-change change-positive">${occupiedUnits === this.tenants.length ? '100% Occupancy' : 'Check vacancies'}</div>
            </div>
          `;
        }

        container.innerHTML = html;
        this.renderCalendar();
      }

      renderCalendar() {
        const calendarSection = document.getElementById('calendarSection');
        if (!calendarSection) return;

        calendarSection.classList.remove('hidden');
        // Calendar implementation - simplified for now
        const today = new Date();
        const events = this.getUpcomingEvents(today);
        
        if (events.length > 0) {
          let eventHtml = events.map(e => `
            <div style="padding: 0.5rem; background: #f5f5f5; margin: 0.5rem 0; border-radius: 6px;">
              <strong>${e.date}</strong><br>
              ${e.description}
            </div>
          `).join('');
          document.getElementById('calendarGrid').innerHTML = eventHtml;
        } else {
          document.getElementById('calendarGrid').innerHTML = '<p style="padding: 1rem; color: var(--text-light);">No upcoming events</p>';
        }
      }

      getUpcomingEvents(date) {
        const events = [];
        const nextMonth = new Date(date.getTime() + 30 * 24 * 60 * 60 * 1000);

        // Loan maturity events
        this.loans.forEach(loan => {
          const maturity = new Date(loan.maturityDate);
          if (maturity > date && maturity < nextMonth) {
            events.push({
              date: maturity.toLocaleDateString(),
              description: `Loan "${loan.borrowerName}" matures`,
              type: 'maturity'
            });
          }
        });

        // Lease expiration events
        this.tenants.forEach(tenant => {
          const leaseEnd = new Date(tenant.leaseEnd);
          if (leaseEnd > date && leaseEnd < nextMonth) {
            events.push({
              date: leaseEnd.toLocaleDateString(),
              description: `Lease for "${tenant.tenantName}" expires`,
              type: 'lease'
            });
          }
        });

        return events.sort((a, b) => new Date(a.date) - new Date(b.date));
      }

      // ===== LOAN MANAGEMENT =====
      renderLoans() {
        const tableBody = document.getElementById('loansBody');
        if (!tableBody) return;

        if (this.loans.length === 0) {
          document.getElementById('loansTable').style.display = 'none';
          document.querySelector('.table-wrapper').innerHTML = '<p style="padding: 2rem; text-align: center; color: var(--text-light);">No loans found. Add a new loan to get started.</p>';
          return;
        }

        tableBody.innerHTML = this.loans.map(loan => `
          <tr>
            <td><strong>${loan.borrowerName}</strong></td>
            <td>$${loan.originalAmount.toLocaleString()}</td>
            <td>$${loan.currentBalance.toLocaleString()}</td>
            <td>${loan.interestRate.toFixed(2)}%</td>
            <td><span class="badge badge-${loan.rateType === 'fixed' ? 'fixed' : 'variable'}">${loan.rateType.toUpperCase()}</span></td>
            <td>${loan.termMonths} mo</td>
            <td>$${loan.monthlyPayment.toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
            <td class="btn-group">
              <button class="btn btn-sm btn-primary btn-edit-loan" data-loan-id="${loan.id}">Edit</button>
              <button class="btn btn-sm btn-warning btn-tranche" data-loan-id="${loan.id}">Tranche</button>
              <button class="btn btn-sm btn-danger btn-delete-loan" data-loan-id="${loan.id}">Delete</button>
            </td>
          </tr>
        `).join('');
      }

      showAddLoanModal() {
        const html = `
          <div class="modal-overlay" id="loanModal">
            <div class="modal-content">
              <div class="modal-header">
                <h2>Add New Loan</h2>
                <button class="modal-close">&times;</button>
              </div>
              <div class="modal-body">
                <form id="addLoanForm">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Borrower Name</label>
                      <input type="text" class="form-control" id="borrowerName" required />
                    </div>
                    <div class="form-group">
                      <label class="form-label">Email</label>
                      <input type="email" class="form-control" id="borrowerEmail" />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Loan Amount</label>
                      <input type="number" class="form-control" id="loanAmount" required />
                    </div>
                    <div class="form-group">
                      <label class="form-label">Term (Months)</label>
                      <input type="number" class="form-control" id="loanTerm" required />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Rate Type</label>
                      <select class="form-control" id="rateType" onchange="document.getElementById('spreadGroup').style.display = this.value === 'variable' ? 'block' : 'none'">
                        <option value="fixed">Fixed</option>
                        <option value="variable">Variable (Prime + Spread)</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Interest Rate (%)</label>
                      <input type="number" step="0.01" class="form-control" id="interestRate" required />
                    </div>
                  </div>

                  <div class="form-row" id="spreadGroup" style="display: none;">
                    <div class="form-group">
                      <label class="form-label">Spread over Prime (%)</label>
                      <input type="number" step="0.01" class="form-control" id="spread" />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Payment Type</label>
                      <select class="form-control" id="paymentType" required>
                        <option value="blended">Blended (Principal + Interest)</option>
                        <option value="interest_only">Interest Only</option>
                        <option value="accruing">Accruing (No Payment)</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Start Date</label>
                      <input type="date" class="form-control" id="startDate" required />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Payment Due Date</label>
                      <select class="form-control" id="paymentDueDay" required>
                        <option value="1">1st of Month</option>
                        <option value="15">15th of Month</option>
                        <option value="last">Last Day of Month</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Origination Fee ($)</label>
                      <input type="number" step="0.01" class="form-control" id="originationFee" value="0" />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Renewal Fee ($)</label>
                      <input type="number" step="0.01" class="form-control" id="renewalFee" value="0" />
                    </div>
                  </div>

                  <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Create Loan</button>
                    <button type="button" class="btn btn-outline modal-close">Cancel</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').innerHTML = html;
        const modal = document.getElementById('loanModal');
        
        document.querySelector('.modal-close').addEventListener('click', () => modal.remove());
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });

        document.getElementById('addLoanForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.createLoan();
          modal.remove();
        });
      }

      createLoan() {
        const loan = {
          id: Date.now(),
          borrowerName: document.getElementById('borrowerName').value,
          borrowerEmail: document.getElementById('borrowerEmail').value,
          originalAmount: parseFloat(document.getElementById('loanAmount').value),
          currentBalance: parseFloat(document.getElementById('loanAmount').value),
          termMonths: parseInt(document.getElementById('loanTerm').value),
          interestRate: parseFloat(document.getElementById('interestRate').value),
          rateType: document.getElementById('rateType').value,
          spread: document.getElementById('rateType').value === 'variable' ? parseFloat(document.getElementById('spread').value) : null,
          paymentType: document.getElementById('paymentType').value,
          startDate: document.getElementById('startDate').value,
          paymentDueDay: document.getElementById('paymentDueDay').value,
          originationFee: parseFloat(document.getElementById('originationFee').value),
          renewalFee: parseFloat(document.getElementById('renewalFee').value),
          monthlyPayment: this.calculateMonthlyPayment(
            parseFloat(document.getElementById('loanAmount').value),
            parseFloat(document.getElementById('interestRate').value),
            parseInt(document.getElementById('loanTerm').value),
            document.getElementById('paymentType').value
          ),
          maturityDate: this.calculateMaturityDate(document.getElementById('startDate').value, parseInt(document.getElementById('loanTerm').value))
        };

        this.loans.push(loan);
        this.generatePaymentSchedule(loan);
        this.saveData();
        this.renderLoans();
        this.renderPaymentSchedule();
        this.renderDashboard();
        this.showNotification(`Loan for ${loan.borrowerName} created successfully`, 'success');
      }

      calculateMonthlyPayment(amount, rate, months, type) {
        if (type === 'interest_only') {
          return (amount * rate / 100) / 12;
        } else if (type === 'accruing') {
          return 0;
        } else {
          const monthlyRate = rate / 100 / 12;
          return amount * (monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1);
        }
      }

      calculateMaturityDate(startDate, months) {
        const date = new Date(startDate);
        date.setMonth(date.getMonth() + months);
        return date.toISOString().split('T')[0];
      }

      generatePaymentSchedule(loan) {
        let balance = loan.originalAmount;
        let currentDate = new Date(loan.startDate);

        for (let i = 0; i < loan.termMonths; i++) {
          // Set payment due date
          if (loan.paymentDueDay === 'last') {
            currentDate.setMonth(currentDate.getMonth() + 1);
            currentDate.setDate(0);
          } else if (loan.paymentDueDay === '15') {
            currentDate.setDate(15);
          } else {
            currentDate.setDate(1);
          }

          const monthlyRate = loan.interestRate / 100 / 12;
          const interest = loan.paymentType === 'interest_only' ? (balance * loan.interestRate / 100 / 12) : (balance * monthlyRate);
          const principal = loan.monthlyPayment - interest;

          const payment = {
            id: Date.now() + i,
            loanId: loan.id,
            dueDate: currentDate.toISOString().split('T')[0],
            principal: Math.max(0, principal),
            interest: interest,
            payment: loan.monthlyPayment,
            balance: Math.max(0, balance - principal),
            status: 'upcoming',
            paidDate: null,
            paidAmount: 0
          };

          this.payments.push(payment);
          balance = Math.max(0, balance - principal);

          if (loan.paymentType === 'interest_only') {
            balance = loan.originalAmount;
          }

          currentDate = new Date(currentDate.getTime() + 24 * 60 * 60 * 1000); // Next day
        }
      }

      editLoan(loanId) {
        const loan = this.loans.find(l => l.id === loanId);
        if (!loan) return;

        const html = `
          <div class="modal-overlay" id="editLoanModal">
            <div class="modal-content">
              <div class="modal-header">
                <h2>Edit Loan - ${loan.borrowerName}</h2>
                <button class="modal-close">&times;</button>
              </div>
              <div class="modal-body">
                <form id="editLoanForm">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Borrower Name</label>
                      <input type="text" class="form-control" id="editBorrowerName" value="${loan.borrowerName}" required />
                    </div>
                    <div class="form-group">
                      <label class="form-label">Email</label>
                      <input type="email" class="form-control" id="editBorrowerEmail" value="${loan.borrowerEmail || ''}" />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Interest Rate (%)</label>
                      <input type="number" step="0.01" class="form-control" id="editInterestRate" value="${loan.interestRate}" required />
                    </div>
                    <div class="form-group">
                      <label class="form-label">Origination Fee ($)</label>
                      <input type="number" step="0.01" class="form-control" id="editOriginationFee" value="${loan.originationFee}" />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Renewal Fee ($)</label>
                      <input type="number" step="0.01" class="form-control" id="editRenewalFee" value="${loan.renewalFee}" />
                    </div>
                  </div>

                  <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-outline modal-close">Cancel</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').innerHTML = html;
        const modal = document.getElementById('editLoanModal');

        document.querySelector('.modal-close').addEventListener('click', () => modal.remove());
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });

        document.getElementById('editLoanForm').addEventListener('submit', (e) => {
          e.preventDefault();
          loan.borrowerName = document.getElementById('editBorrowerName').value;
          loan.borrowerEmail = document.getElementById('editBorrowerEmail').value;
          loan.interestRate = parseFloat(document.getElementById('editInterestRate').value);
          loan.originationFee = parseFloat(document.getElementById('editOriginationFee').value);
          loan.renewalFee = parseFloat(document.getElementById('editRenewalFee').value);
          
          // Recalculate monthly payment
          loan.monthlyPayment = this.calculateMonthlyPayment(
            loan.originalAmount,
            loan.interestRate,
            loan.termMonths,
            loan.paymentType
          );

          this.saveData();
          this.renderLoans();
          this.renderPaymentSchedule();
          this.showNotification('Loan updated successfully', 'success');
          modal.remove();
        });
      }

      deleteLoan(loanId) {
        if (confirm('Are you sure you want to delete this loan? This action cannot be undone.')) {
          this.loans = this.loans.filter(l => l.id !== loanId);
          this.payments = this.payments.filter(p => p.loanId !== loanId);
          this.tranches = this.tranches.filter(t => t.loanId !== loanId);
          this.saveData();
          this.renderLoans();
          this.renderPaymentSchedule();
          this.renderDashboard();
          this.showNotification('Loan deleted successfully', 'success');
        }
      }

      showTrancheModal(loanId) {
        const loan = this.loans.find(l => l.id === loanId);
        if (!loan) return;

        const html = `
          <div class="modal-overlay" id="trancheModal">
            <div class="modal-content">
              <div class="modal-header">
                <h2>Add Tranche - ${loan.borrowerName}</h2>
                <button class="modal-close">&times;</button>
              </div>
              <div class="modal-body">
                <form id="trancheForm">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Transaction Type</label>
                      <select class="form-control" id="trancheType" required>
                        <option value="payment">Payment Received</option>
                        <option value="advance">Advance Given</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Amount ($)</label>
                      <input type="number" step="0.01" class="form-control" id="trancheAmount" required />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Transaction Date</label>
                      <input type="date" class="form-control" id="trancheDate" value="${new Date().toISOString().split('T')[0]}" required />
                    </div>
                    <div class="form-group">
                      <label class="form-label">Notes</label>
                      <input type="text" class="form-control" id="trancheNotes" />
                    </div>
                  </div>

                  <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Record Tranche</button>
                    <button type="button" class="btn btn-outline modal-close">Cancel</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').innerHTML = html;
        const modal = document.getElementById('trancheModal');

        document.querySelector('.modal-close').addEventListener('click', () => modal.remove());
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });

        document.getElementById('trancheForm').addEventListener('submit', (e) => {
          e.preventDefault();
          const trancheType = document.getElementById('trancheType').value;
          const amount = parseFloat(document.getElementById('trancheAmount').value);
          const date = document.getElementById('trancheDate').value;
          const notes = document.getElementById('trancheNotes').value;

          const tranche = {
            id: Date.now(),
            loanId: loanId,
            type: trancheType,
            amount: amount,
            date: date,
            notes: notes,
            createdBy: this.currentUser.name,
            createdAt: new Date().toISOString()
          };

          this.tranches.push(tranche);

          if (trancheType === 'payment') {
            loan.currentBalance = Math.max(0, loan.currentBalance - amount);
          } else {
            loan.currentBalance += amount;
          }

          this.saveData();
          this.renderLoans();
          this.renderPaymentSchedule();
          this.renderDashboard();
          this.showNotification('Tranche recorded successfully', 'success');
          modal.remove();
        });
      }

      // ===== PAYMENT SCHEDULE =====
      renderPaymentSchedule() {
        const loanFilter = document.getElementById('loanFilterDropdown');
        const statusFilter = document.getElementById('statusFilterDropdown');
        const scheduleBody = document.getElementById('scheduleBody');

        if (!scheduleBody) return;

        let filtered = this.payments;

        if (loanFilter && loanFilter.value) {
          filtered = filtered.filter(p => p.loanId === parseInt(loanFilter.value));
        }

        if (statusFilter && statusFilter.value) {
          filtered = filtered.filter(p => p.status === statusFilter.value);
        }

        // Sort by due date
        filtered.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

        if (filtered.length === 0) {
          scheduleBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-light);">No payments found</td></tr>';
          return;
        }

        scheduleBody.innerHTML = filtered.map(payment => {
          const loan = this.loans.find(l => l.id === payment.loanId);
          const statusClass = `badge-${payment.status}`;
          
          return `
            <tr>
              <td>${new Date(payment.dueDate).toLocaleDateString()}</td>
              <td>${loan ? loan.borrowerName : 'Unknown'}</td>
              <td>$${payment.principal.toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
              <td>$${payment.interest.toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
              <td>$${payment.payment.toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
              <td>$${payment.balance.toLocaleString()}</td>
              <td><span class="badge ${statusClass}">${payment.status.toUpperCase()}</span></td>
              <td class="btn-group">
                ${payment.status === 'upcoming' ? `
                  <button class="btn btn-sm btn-success btn-pay" data-payment-id="${payment.id}">Pay</button>
                  <button class="btn btn-sm btn-warning btn-partial" data-payment-id="${payment.id}">Partial</button>
                  <button class="btn btn-sm btn-danger btn-miss" data-payment-id="${payment.id}">Miss</button>
                ` : `
                  <span style="font-size: 0.8rem; color: var(--text-light);">Recorded</span>
                `}
              </td>
            </tr>
          `;
        }).join('');
      }

      recordPayment(paymentId, status) {
        const payment = this.payments.find(p => p.id === paymentId);
        if (!payment) return;

        const loan = this.loans.find(l => l.id === payment.loanId);
        if (!loan) return;

        payment.status = status;
        payment.paidDate = new Date().toISOString().split('T')[0];
        payment.paidAmount = payment.payment;

        if (status === 'paid') {
          if (loan.paymentType !== 'interest_only') {
            loan.currentBalance = Math.max(0, loan.currentBalance - payment.principal);
          }
        } else if (status === 'overdue') {
          // Add interest to principal for overdue payments
          payment.interest *= 1.1; // 10% penalty
          loan.currentBalance += payment.interest;
        }

        this.saveData();
        this.renderPaymentSchedule();
        this.renderDashboard();
        this.showNotification(`Payment marked as ${status}`, 'success');
      }

      showPartialPaymentModal(paymentId) {
        const payment = this.payments.find(p => p.id === paymentId);
        if (!payment) return;

        const html = `
          <div class="modal-overlay" id="partialPaymentModal">
            <div class="modal-content">
              <div class="modal-header">
                <h2>Partial Payment</h2>
                <button class="modal-close">&times;</button>
              </div>
              <div class="modal-body">
                <div style="margin-bottom: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 6px;">
                  <p><strong>Due Amount:</strong> $${payment.payment.toLocaleString(undefined, {maximumFractionDigits: 2})}</p>
                </div>
                <form id="partialPaymentForm">
                  <div class="form-group">
                    <label class="form-label">Amount Paid ($)</label>
                    <input type="number" step="0.01" class="form-control" id="partialAmount" max="${payment.payment}" required />
                  </div>
                  <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Record Partial Payment</button>
                    <button type="button" class="btn btn-outline modal-close">Cancel</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').innerHTML = html;
        const modal = document.getElementById('partialPaymentModal');

        document.querySelector('.modal-close').addEventListener('click', () => modal.remove());
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });

        document.getElementById('partialPaymentForm').addEventListener('submit', (e) => {
          e.preventDefault();
          const amount = parseFloat(document.getElementById('partialAmount').value);
          
          payment.status = 'partial';
          payment.paidDate = new Date().toISOString().split('T')[0];
          payment.paidAmount = amount;

          const loan = this.loans.find(l => l.id === payment.loanId);
          if (loan && loan.paymentType !== 'interest_only') {
            const principalPortion = amount * (payment.principal / payment.payment);
            loan.currentBalance = Math.max(0, loan.currentBalance - principalPortion);
          }

          this.saveData();
          this.renderPaymentSchedule();
          this.renderDashboard();
          this.showNotification('Partial payment recorded successfully', 'success');
          modal.remove();
        });
      }

      // ===== REAL ESTATE MANAGEMENT =====
      renderProperties() {
        const propertiesBody = document.getElementById('propertiesBody');
        if (!propertiesBody) return;

        if (this.properties.length === 0) {
          propertiesBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-light);">No properties found. Add a property to get started.</td></tr>';
          return;
        }

        propertiesBody.innerHTML = this.properties.map(property => {
          const tenantCount = this.tenants.filter(t => t.propertyId === property.id).length;
          const totalRent = this.tenants.filter(t => t.propertyId === property.id).reduce((sum, t) => sum + t.monthlyRent, 0);

          return `
            <tr>
              <td><strong>${property.address}</strong></td>
              <td>${property.propertyType || 'Residential'}</td>
              <td>$${(property.value || 0).toLocaleString()}</td>
              <td>${tenantCount}</td>
              <td>$${totalRent.toLocaleString()}</td>
              <td><span class="badge badge-active">Active</span></td>
              <td class="btn-group">
                <button class="btn btn-sm btn-primary btn-edit-property" data-property-id="${property.id}">Edit</button>
                <button class="btn btn-sm btn-danger btn-delete-property" data-property-id="${property.id}">Delete</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      showAddPropertyModal() {
        const html = `
          <div class="modal-overlay" id="propertyModal">
            <div class="modal-content">
              <div class="modal-header">
                <h2>Add New Property</h2>
                <button class="modal-close">&times;</button>
              </div>
              <div class="modal-body">
                <form id="addPropertyForm">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Property Address</label>
                      <input type="text" class="form-control" id="propertyAddress" required />
                    </div>
                    <div class="form-group">
                      <label class="form-label">City</label>
                      <input type="text" class="form-control" id="propertyCity" required />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">State/Province</label>
                      <input type="text" class="form-control" id="propertyState" required />
                    </div>
                    <div class="form-group">
                      <label class="form-label">Postal Code</label>
                      <input type="text" class="form-control" id="propertyPostal" required />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Property Type</label>
                      <select class="form-control" id="propertyType" required>
                        <option value="residential">Residential</option>
                        <option value="commercial">Commercial</option>
                        <option value="industrial">Industrial</option>
                        <option value="mixed">Mixed Use</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Property Value ($)</label>
                      <input type="number" class="form-control" id="propertyValue" required />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Acquisition Date</label>
                      <input type="date" class="form-control" id="acquisitionDate" required />
                    </div>
                    <div class="form-group">
                      <label class="form-label">Number of Units</label>
                      <input type="number" class="form-control" id="numUnits" value="1" required />
                    </div>
                  </div>

                  <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Create Property</button>
                    <button type="button" class="btn btn-outline modal-close">Cancel</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').innerHTML = html;
        const modal = document.getElementById('propertyModal');

        document.querySelector('.modal-close').addEventListener('click', () => modal.remove());
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });

        document.getElementById('addPropertyForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.createProperty();
          modal.remove();
        });
      }

      createProperty() {
        const property = {
          id: Date.now(),
          address: document.getElementById('propertyAddress').value,
          city: document.getElementById('propertyCity').value,
          state: document.getElementById('propertyState').value,
          postal: document.getElementById('propertyPostal').value,
          propertyType: document.getElementById('propertyType').value,
          value: parseFloat(document.getElementById('propertyValue').value),
          acquisitionDate: document.getElementById('acquisitionDate').value,
          numUnits: parseInt(document.getElementById('numUnits').value),
          monthlyRent: 0
        };

        this.properties.push(property);
        this.saveData();
        this.renderProperties();
        this.populateFilters();
        this.renderDashboard();
        this.showNotification('Property added successfully', 'success');
      }

      editProperty(propertyId) {
        const property = this.properties.find(p => p.id === propertyId);
        if (!property) return;

        const html = `
          <div class="modal-overlay" id="editPropertyModal">
            <div class="modal-content">
              <div class="modal-header">
                <h2>Edit Property</h2>
                <button class="modal-close">&times;</button>
              </div>
              <div class="modal-body">
                <form id="editPropertyForm">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Property Address</label>
                      <input type="text" class="form-control" id="editPropertyAddress" value="${property.address}" required />
                    </div>
                    <div class="form-group">
                      <label class="form-label">Property Value ($)</label>
                      <input type="number" class="form-control" id="editPropertyValue" value="${property.value}" required />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Number of Units</label>
                      <input type="number" class="form-control" id="editNumUnits" value="${property.numUnits}" required />
                    </div>
                  </div>

                  <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-outline modal-close">Cancel</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').innerHTML = html;
        const modal = document.getElementById('editPropertyModal');

        document.querySelector('.modal-close').addEventListener('click', () => modal.remove());
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });

        document.getElementById('editPropertyForm').addEventListener('submit', (e) => {
          e.preventDefault();
          property.address = document.getElementById('editPropertyAddress').value;
          property.value = parseFloat(document.getElementById('editPropertyValue').value);
          property.numUnits = parseInt(document.getElementById('editNumUnits').value);

          this.saveData();
          this.renderProperties();
          this.renderDashboard();
          this.showNotification('Property updated successfully', 'success');
          modal.remove();
        });
      }

      deleteProperty(propertyId) {
        if (confirm('Are you sure you want to delete this property? Associated tenants will be removed.')) {
          this.properties = this.properties.filter(p => p.id !== propertyId);
          this.tenants = this.tenants.filter(t => t.propertyId !== propertyId);
          this.rentPayments = this.rentPayments.filter(p => p.propertyId !== propertyId);
          this.saveData();
          this.renderProperties();
          this.renderTenants();
          this.renderRentSchedule();
          this.renderDashboard();
          this.showNotification('Property deleted successfully', 'success');
        }
      }

      // ===== TENANT MANAGEMENT =====
      renderTenants() {
        const tenantsBody = document.getElementById('tenantsBody');
        if (!tenantsBody) return;

        if (this.tenants.length === 0) {
          tenantsBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-light);">No tenants found. Add a tenant to get started.</td></tr>';
          return;
        }

        tenantsBody.innerHTML = this.tenants.map(tenant => {
          const property = this.properties.find(p => p.id === tenant.propertyId);
          const leaseActive = new Date(tenant.leaseEnd) > new Date();

          return `
            <tr>
              <td><strong>${tenant.tenantName}</strong></td>
              <td>${property ? property.address : 'Unknown'}</td>
              <td>${tenant.unit || 'N/A'}</td>
              <td>${new Date(tenant.leaseStart).toLocaleDateString()}</td>
              <td>${new Date(tenant.leaseEnd).toLocaleDateString()}</td>
              <td>$${tenant.monthlyRent.toLocaleString()}</td>
              <td><span class="badge ${leaseActive ? 'badge-active' : 'badge-inactive'}">${leaseActive ? 'ACTIVE' : 'INACTIVE'}</span></td>
              <td class="btn-group">
                <button class="btn btn-sm btn-primary btn-edit-tenant" data-tenant-id="${tenant.id}">Edit</button>
                <button class="btn btn-sm btn-danger btn-delete-tenant" data-tenant-id="${tenant.id}">Delete</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      showAddTenantModal() {
        const propertyOptions = this.properties.map(p => `<option value="${p.id}">${p.address}</option>`).join('');

        const html = `
          <div class="modal-overlay" id="tenantModal">
            <div class="modal-content">
              <div class="modal-header">
                <h2>Add New Tenant</h2>
                <button class="modal-close">&times;</button>
              </div>
              <div class="modal-body">
                <form id="addTenantForm">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Tenant Name</label>
                      <input type="text" class="form-control" id="tenantName" required />
                    </div>
                    <div class="form-group">
                      <label class="form-label">Email</label>
                      <input type="email" class="form-control" id="tenantEmail" />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Property</label>
                      <select class="form-control" id="propertyId" required>
                        <option value="">Select Property</option>
                        ${propertyOptions}
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Unit</label>
                      <input type="text" class="form-control" id="tenantUnit" />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Lease Start Date</label>
                      <input type="date" class="form-control" id="leaseStart" required />
                    </div>
                    <div class="form-group">
                      <label class="form-label">Lease End Date</label>
                      <input type="date" class="form-control" id="leaseEnd" required />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Monthly Rent ($)</label>
                      <input type="number" step="0.01" class="form-control" id="monthlyRent" required />
                    </div>
                    <div class="form-group">
                      <label class="form-label">Rent Payment Day</label>
                      <select class="form-control" id="rentPaymentDay" required>
                        <option value="1">1st of Month</option>
                        <option value="15">15th of Month</option>
                        <option value="last">Last Day of Month</option>
                      </select>
                    </div>
                  </div>

                  <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Create Tenant</button>
                    <button type="button" class="btn btn-outline modal-close">Cancel</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').innerHTML = html;
        const modal = document.getElementById('tenantModal');

        document.querySelector('.modal-close').addEventListener('click', () => modal.remove());
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });

        document.getElementById('addTenantForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.createTenant();
          modal.remove();
        });
      }

      createTenant() {
        const tenant = {
          id: Date.now(),
          tenantName: document.getElementById('tenantName').value,
          email: document.getElementById('tenantEmail').value,
          propertyId: parseInt(document.getElementById('propertyId').value),
          unit: document.getElementById('tenantUnit').value,
          leaseStart: document.getElementById('leaseStart').value,
          leaseEnd: document.getElementById('leaseEnd').value,
          monthlyRent: parseFloat(document.getElementById('monthlyRent').value),
          rentPaymentDay: document.getElementById('rentPaymentDay').value
        };

        this.tenants.push(tenant);
        this.generateRentSchedule(tenant);
        this.saveData();
        this.renderTenants();
        this.renderRentSchedule();
        this.renderProperties();
        this.renderDashboard();
        this.populateFilters();
        this.showNotification('Tenant added successfully', 'success');
      }

      generateRentSchedule(tenant) {
        let currentDate = new Date(tenant.leaseStart);
        const leaseEnd = new Date(tenant.leaseEnd);

        while (currentDate <= leaseEnd) {
          let paymentDate = new Date(currentDate);

          if (tenant.rentPaymentDay === 'last') {
            paymentDate.setMonth(paymentDate.getMonth() + 1);
            paymentDate.setDate(0);
          } else {
            paymentDate.setDate(parseInt(tenant.rentPaymentDay));
          }

          if (paymentDate <= leaseEnd) {
            const rentPayment = {
              id: Date.now() + Math.random(),
              tenantId: tenant.id,
              propertyId: tenant.propertyId,
              dueDate: paymentDate.toISOString().split('T')[0],
              amount: tenant.monthlyRent,
              status: 'upcoming',
              paidDate: null
            };

            this.rentPayments.push(rentPayment);
          }

          currentDate.setMonth(currentDate.getMonth() + 1);
        }
      }

      editTenant(tenantId) {
        const tenant = this.tenants.find(t => t.id === tenantId);
        if (!tenant) return;

        const propertyOptions = this.properties.map(p => `<option value="${p.id}" ${p.id === tenant.propertyId ? 'selected' : ''}>${p.address}</option>`).join('');

        const html = `
          <div class="modal-overlay" id="editTenantModal">
            <div class="modal-content">
              <div class="modal-header">
                <h2>Edit Tenant - ${tenant.tenantName}</h2>
                <button class="modal-close">&times;</button>
              </div>
              <div class="modal-body">
                <form id="editTenantForm">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Lease End Date</label>
                      <input type="date" class="form-control" id="editLeaseEnd" value="${tenant.leaseEnd}" required />
                    </div>
                    <div class="form-group">
                      <label class="form-label">Monthly Rent ($)</label>
                      <input type="number" step="0.01" class="form-control" id="editMonthlyRent" value="${tenant.monthlyRent}" required />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">New Lease Rate (for renewal, optional)</label>
                      <input type="number" step="0.01" class="form-control" id="newLeaseRate" />
                    </div>
                    <div class="form-group">
                      <label class="form-label">New Lease Term (months, optional)</label>
                      <input type="number" class="form-control" id="newLeaseTermMonths" />
                    </div>
                  </div>

                  <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-outline modal-close">Cancel</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').innerHTML = html;
        const modal = document.getElementById('editTenantModal');

        document.querySelector('.modal-close').addEventListener('click', () => modal.remove());
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });

        document.getElementById('editTenantForm').addEventListener('submit', (e) => {
          e.preventDefault();
          tenant.leaseEnd = document.getElementById('editLeaseEnd').value;
          tenant.monthlyRent = parseFloat(document.getElementById('editMonthlyRent').value);

          const newLeaseRate = document.getElementById('newLeaseRate').value;
          if (newLeaseRate) {
            tenant.monthlyRent = parseFloat(newLeaseRate);
            tenant.leaseEnd = this.addMonthsToDate(tenant.leaseEnd, parseInt(document.getElementById('newLeaseTermMonths').value) || 12);
            this.generateRentSchedule(tenant);
          }

          this.saveData();
          this.renderTenants();
          this.renderRentSchedule();
          this.renderDashboard();
          this.showNotification('Tenant updated successfully', 'success');
          modal.remove();
        });
      }

      addMonthsToDate(dateStr, months) {
        const date = new Date(dateStr);
        date.setMonth(date.getMonth() + months);
        return date.toISOString().split('T')[0];
      }

      deleteTenant(tenantId) {
        if (confirm('Are you sure you want to delete this tenant?')) {
          this.tenants = this.tenants.filter(t => t.id !== tenantId);
          this.rentPayments = this.rentPayments.filter(p => p.tenantId !== tenantId);
          this.saveData();
          this.renderTenants();
          this.renderRentSchedule();
          this.renderProperties();
          this.renderDashboard();
          this.showNotification('Tenant deleted successfully', 'success');
        }
      }

      // ===== RENT SCHEDULE =====
      renderRentSchedule() {
        const rentScheduleBody = document.getElementById('rentScheduleBody');
        if (!rentScheduleBody) return;

        const propertyFilter = document.getElementById('propertyFilterDropdown')?.value;
        const statusFilter = document.getElementById('rentStatusFilterDropdown')?.value;

        let filtered = this.rentPayments;

        if (propertyFilter) {
          filtered = filtered.filter(p => p.propertyId === parseInt(propertyFilter));
        }

        if (statusFilter) {
          filtered = filtered.filter(p => p.status === statusFilter);
        }

        filtered.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

        if (filtered.length === 0) {
          rentScheduleBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-light);">No rent payments found</td></tr>';
          return;
        }

        rentScheduleBody.innerHTML = filtered.map(payment => {
          const tenant = this.tenants.find(t => t.id === payment.tenantId);
          const property = this.properties.find(p => p.id === payment.propertyId);
          const statusClass = `badge-${payment.status}`;

          return `
            <tr>
              <td>${new Date(payment.dueDate).toLocaleDateString()}</td>
              <td>${tenant ? tenant.tenantName : 'Unknown'}</td>
              <td>${property ? property.address : 'Unknown'}</td>
              <td>$${payment.amount.toLocaleString()}</td>
              <td><span class="badge ${statusClass}">${payment.status.toUpperCase()}</span></td>
              <td class="btn-group">
                ${payment.status === 'upcoming' ? `
                  <button class="btn btn-sm btn-success btn-pay" data-payment-id="${payment.id}">Pay</button>
                  <button class="btn btn-sm btn-danger btn-miss" data-payment-id="${payment.id}">Overdue</button>
                ` : ''}
              </td>
            </tr>
          `;
        }).join('');
      }

      // ===== REPORTS =====
      renderReports() {
        const primeHistoryBody = document.getElementById('primeHistoryBody');
        if (!primeHistoryBody) return;

        primeHistoryBody.innerHTML = this.primeRateHistory.map(entry => `
          <tr>
            <td>${new Date(entry.date).toLocaleDateString()}</td>
            <td>${entry.rate.toFixed(2)}%</td>
            <td>${entry.previousRate ? entry.previousRate.toFixed(2) + '%' : 'N/A'}</td>
            <td>${entry.rate - (entry.previousRate || 0) > 0 ? '+' : ''}${(entry.rate - (entry.previousRate || 0)).toFixed(2)}%</td>
            <td>${entry.notes || '-'}</td>
          </tr>
        `).join('');
      }

      showUpdatePrimeRateModal() {
        const html = `
          <div class="modal-overlay" id="primeRateModal">
            <div class="modal-content">
              <div class="modal-header">
                <h2>Update Prime Rate</h2>
                <button class="modal-close">&times;</button>
              </div>
              <div class="modal-body">
                <div style="margin-bottom: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 6px;">
                  <p><strong>Current Prime Rate:</strong> ${this.primeRate.toFixed(2)}%</p>
                </div>
                <form id="primeRateForm">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">New Prime Rate (%)</label>
                      <input type="number" step="0.01" class="form-control" id="newPrimeRate" value="${this.primeRate.toFixed(2)}" required />
                    </div>
                    <div class="form-group">
                      <label class="form-label">Effective Date</label>
                      <input type="date" class="form-control" id="effectiveDate" value="${new Date().toISOString().split('T')[0]}" required />
                    </div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" id="primeRateNotes" rows="3" placeholder="Reason for rate change..."></textarea>
                  </div>

                  <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Update Prime Rate</button>
                    <button type="button" class="btn btn-outline modal-close">Cancel</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').innerHTML = html;
        const modal = document.getElementById('primeRateModal');

        document.querySelector('.modal-close').addEventListener('click', () => modal.remove());
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });

        document.getElementById('primeRateForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.updatePrimeRate();
          modal.remove();
        });
      }

      updatePrimeRate() {
        const newRate = parseFloat(document.getElementById('newPrimeRate').value);
        const date = document.getElementById('effectiveDate').value;
        const notes = document.getElementById('primeRateNotes').value;

        this.primeRateHistory.unshift({
          date: date,
          rate: newRate,
          previousRate: this.primeRate,
          notes: notes,
          updatedBy: this.currentUser.name,
          timestamp: new Date().toISOString()
        });

        const oldRate = this.primeRate;
        this.primeRate = newRate;

        // Update variable rate loans
        this.loans.filter(l => l.rateType === 'variable').forEach(loan => {
          if (loan.spread !== null && loan.spread !== undefined) {
            loan.interestRate = newRate + loan.spread;
            loan.monthlyPayment = this.calculateMonthlyPayment(
              loan.originalAmount,
              loan.interestRate,
              loan.termMonths,
              loan.paymentType
            );
          }
        });

        this.saveData();
        this.updatePrimeRateDisplay();
        this.renderReports();
        this.renderLoans();
        this.renderPaymentSchedule();
        this.renderDashboard();
        this.showNotification(`Prime rate updated from ${oldRate.toFixed(2)}% to ${newRate.toFixed(2)}%`, 'success');
      }

      updatePrimeRateDisplay() {
        const display = document.getElementById('primeRateValue');
        if (display) {
          display.textContent = this.primeRate.toFixed(2);
        }
      }

      savePrimeRateFromSettings() {
        const settingsRate = parseFloat(document.getElementById('settingsPrimeRate').value);
        this.primeRate = settingsRate;
        this.saveData();
        this.updatePrimeRateDisplay();
        this.showNotification('Prime rate saved successfully', 'success');
      }

      renderSettings() {
        const settingsPrimeRate = document.getElementById('settingsPrimeRate');
        if (settingsPrimeRate) {
          settingsPrimeRate.value = this.primeRate.toFixed(2);
        }
      }

      // ===== EXPORT FUNCTIONS =====
      exportLoansExcel() {
        const data = this.loans.map(loan => ({
          'Borrower': loan.borrowerName,
          'Email': loan.borrowerEmail,
          'Original Amount': loan.originalAmount,
          'Current Balance': loan.currentBalance,
          'Interest Rate': loan.interestRate,
          'Rate Type': loan.rateType,
          'Term (Months)': loan.termMonths,
          'Monthly Payment': loan.monthlyPayment,
          'Origination Fee': loan.originationFee,
          'Renewal Fee': loan.renewalFee,
          'Start Date': loan.startDate,
          'Maturity Date': loan.maturityDate
        }));

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Loans');
        XLSX.writeFile(wb, 'Loans_Export.xlsx');
        this.showNotification('Loans exported to Excel successfully', 'success');
      }

      exportPaymentScheduleExcel() {
        const loanFilter = document.getElementById('loanFilterDropdown')?.value;
        let filtered = this.payments;

        if (loanFilter) {
          filtered = filtered.filter(p => p.loanId === parseInt(loanFilter));
        }

        const data = filtered.map(payment => {
          const loan = this.loans.find(l => l.id === payment.loanId);
          return {
            'Borrower': loan ? loan.borrowerName : 'Unknown',
            'Due Date': payment.dueDate,
            'Principal': payment.principal,
            'Interest': payment.interest,
            'Total Payment': payment.payment,
            'Remaining Balance': payment.balance,
            'Status': payment.status,
            'Paid Date': payment.paidDate || '-',
            'Paid Amount': payment.paidAmount || '-'
          };
        });

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Payment Schedule');
        XLSX.writeFile(wb, 'Payment_Schedule_Export.xlsx');
        this.showNotification('Payment schedule exported to Excel successfully', 'success');
      }

      showPdfExportModal() {
        const loanOptions = this.loans.map(l => `<option value="${l.id}">${l.borrowerName}</option>`).join('');

        const html = `
          <div class="modal-overlay" id="pdfExportModal">
            <div class="modal-content">
              <div class="modal-header">
                <h2>Export Annual Statement - PDF</h2>
                <button class="modal-close">&times;</button>
              </div>
              <div class="modal-body">
                <form id="pdfExportForm">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Select Loan</label>
                      <select class="form-control" id="pdfLoanId" required>
                        <option value="">Choose a Loan</option>
                        ${loanOptions}
                      </select>
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Period</label>
                      <select class="form-control" id="pdfPeriod" required>
                        <option value="currentYear">Current Year</option>
                        <option value="lastYear">Last Year</option>
                        <option value="ytd">Year to Date</option>
                        <option value="custom">Custom Date Range</option>
                      </select>
                    </div>
                  </div>

                  <div class="form-row" id="customDateRange" style="display: none;">
                    <div class="form-group">
                      <label class="form-label">From Date</label>
                      <input type="date" class="form-control" id="pdfFromDate" />
                    </div>
                    <div class="form-group">
                      <label class="form-label">To Date</label>
                      <input type="date" class="form-control" id="pdfToDate" />
                    </div>
                  </div>

                  <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Export to PDF</button>
                    <button type="button" class="btn btn-outline modal-close">Cancel</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').innerHTML = html;
        const modal = document.getElementById('pdfExportModal');

        document.getElementById('pdfPeriod').addEventListener('change', (e) => {
          const customRange = document.getElementById('customDateRange');
          if (e.target.value === 'custom') {
            customRange.style.display = 'grid';
          } else {
            customRange.style.display = 'none';
          }
        });

        document.querySelector('.modal-close').addEventListener('click', () => modal.remove());
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });

        document.getElementById('pdfExportForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.generateAnnualStatementPDF();
          modal.remove();
        });
      }

      generateAnnualStatementPDF() {
        const loanId = parseInt(document.getElementById('pdfLoanId').value);
        const period = document.getElementById('pdfPeriod').value;
        const loan = this.loans.find(l => l.id === loanId);

        if (!loan) {
          this.showNotification('Please select a valid loan', 'error');
          return;
        }

        // Get date range
        let fromDate, toDate;
        const now = new Date();
        const currentYear = now.getFullYear();

        switch (period) {
          case 'currentYear':
            fromDate = new Date(currentYear, 0, 1);
            toDate = new Date(currentYear, 11, 31);
            break;
          case 'lastYear':
            fromDate = new Date(currentYear - 1, 0, 1);
            toDate = new Date(currentYear - 1, 11, 31);
            break;
          case 'ytd':
            fromDate = new Date(currentYear, 0, 1);
            toDate = now;
            break;
          case 'custom':
            fromDate = new Date(document.getElementById('pdfFromDate').value);
            toDate = new Date(document.getElementById('pdfToDate').value);
            break;
        }

        // Filter payments
        const relevantPayments = this.payments.filter(p => {
          if (p.loanId !== loanId) return false;
          const paymentDate = new Date(p.paidDate || p.dueDate);
          return paymentDate >= fromDate && paymentDate <= toDate;
        });

        // Calculate totals
        const totalPrincipal = relevantPayments.reduce((sum, p) => sum + (p.status === 'paid' ? p.principal : 0), 0);
        const totalInterest = relevantPayments.reduce((sum, p) => sum + (p.status === 'paid' ? p.interest : 0), 0);
        const totalPayments = totalPrincipal + totalInterest;

        // Create PDF
        const doc = new jsPDF();
        doc.setFontSize(12);

        // Header
        doc.text('Lindan Equities', 20, 20);
        doc.setFontSize(10);
        doc.text('Professional Financial Services', 20, 28);

        // Title
        doc.setFontSize(14);
        doc.text('Annual Loan Statement', 20, 45);

        // Loan Information
        doc.setFontSize(10);
        doc.text(`Borrower: ${loan.borrowerName}`, 20, 60);
        doc.text(`Loan Amount: $${loan.originalAmount.toLocaleString()}`, 20, 68);
        doc.text(`Interest Rate: ${loan.interestRate.toFixed(2)}%`, 20, 76);
        doc.text(`Term: ${loan.termMonths} months`, 20, 84);
        doc.text(`Period: ${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()}`, 20, 92);

        // Payment Summary
        doc.setFontSize(11);
        doc.text('Payment Summary', 20, 110);

        doc.setFontSize(10);
        doc.text(`Total Payments Made: $${totalPayments.toLocaleString(undefined, {maximumFractionDigits: 2})}`, 20, 118);
        doc.text(`Principal Paid: $${totalPrincipal.toLocaleString(undefined, {maximumFractionDigits: 2})}`, 20, 126);
        doc.text(`Interest Paid: $${totalInterest.toLocaleString(undefined, {maximumFractionDigits: 2})}`, 20, 134);
        doc.text(`Current Balance: $${loan.currentBalance.toLocaleString(undefined, {maximumFractionDigits: 2})}`, 20, 142);

        // Payment detail table
        const tableData = relevantPayments.map(p => [
          p.paidDate || p.dueDate,
          `$${p.principal.toLocaleString(undefined, {maximumFractionDigits: 2})}`,
          `$${p.interest.toLocaleString(undefined, {maximumFractionDigits: 2})}`,
          `$${p.payment.toLocaleString(undefined, {maximumFractionDigits: 2})}`,
          p.status.toUpperCase()
        ]);

        doc.autoTable({
          head: [['Date', 'Principal', 'Interest', 'Payment', 'Status']],
          body: tableData,
          startY: 155,
          headStyles: { fillColor: [45, 125, 50] },
          margin: { left: 20, right: 20 }
        });

        doc.save(`Annual_Statement_${loan.borrowerName}_${period}.pdf`);
        this.showNotification('Annual statement PDF generated successfully', 'success');
      }

      exportPropertiesExcel() {
        const data = this.properties.map(property => ({
          'Address': property.address,
          'City': property.city,
          'State': property.state,
          'Postal Code': property.postal,
          'Type': property.propertyType,
          'Value': property.value,
          'Units': property.numUnits,
          'Acquisition Date': property.acquisitionDate
        }));

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Properties');
        XLSX.writeFile(wb, 'Properties_Export.xlsx');
        this.showNotification('Properties exported to Excel successfully', 'success');
      }

      exportTenantsExcel() {
        const data = this.tenants.map(tenant => {
          const property = this.properties.find(p => p.id === tenant.propertyId);
          return {
            'Name': tenant.tenantName,
            'Email': tenant.email,
            'Property': property ? property.address : 'Unknown',
            'Unit': tenant.unit,
            'Lease Start': tenant.leaseStart,
            'Lease End': tenant.leaseEnd,
            'Monthly Rent': tenant.monthlyRent,
            'Payment Day': tenant.rentPaymentDay
          };
        });

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Tenants');
        XLSX.writeFile(wb, 'Tenants_Export.xlsx');
        this.showNotification('Tenants exported to Excel successfully', 'success');
      }

      exportRentScheduleExcel() {
        const propertyFilter = document.getElementById('propertyFilterDropdown')?.value;
        let filtered = this.rentPayments;

        if (propertyFilter) {
          filtered = filtered.filter(p => p.propertyId === parseInt(propertyFilter));
        }

        const data = filtered.map(payment => {
          const tenant = this.tenants.find(t => t.id === payment.tenantId);
          const property = this.properties.find(p => p.id === payment.propertyId);
          return {
            'Due Date': payment.dueDate,
            'Tenant': tenant ? tenant.tenantName : 'Unknown',
            'Property': property ? property.address : 'Unknown',
            'Amount': payment.amount,
            'Status': payment.status,
            'Paid Date': payment.paidDate || '-'
          };
        });

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Rent Schedule');
        XLSX.writeFile(wb, 'Rent_Schedule_Export.xlsx');
        this.showNotification('Rent schedule exported to Excel successfully', 'success');
      }

      // ===== NOTES MANAGEMENT =====
      addNote() {
        const noteInput = document.getElementById('noteInput');
        if (!noteInput || !noteInput.value.trim()) {
          this.showNotification('Please enter a note', 'error');
          return;
        }

        // This would be implemented based on the current context (loan or property)
        this.showNotification('Note added successfully', 'success');
        noteInput.value = '';
      }

      // ===== UTILITY FUNCTIONS =====
      populateFilters() {
        const loanFilter = document.getElementById('loanFilterDropdown');
        if (loanFilter) {
          loanFilter.innerHTML = '<option value="">All Loans</option>';
          this.loans.forEach(loan => {
            const option = document.createElement('option');
            option.value = loan.id;
            option.textContent = loan.borrowerName;
            loanFilter.appendChild(option);
          });
        }

        const propertyFilter = document.getElementById('propertyFilterDropdown');
        if (propertyFilter) {
          propertyFilter.innerHTML = '<option value="">All Properties</option>';
          this.properties.forEach(property => {
            const option = document.createElement('option');
            option.value = property.id;
            option.textContent = property.address;
            propertyFilter.appendChild(option);
          });
        }
      }

      saveData() {
        localStorage.setItem('primeRate', this.primeRate.toString());
        localStorage.setItem('primeRateHistory', JSON.stringify(this.primeRateHistory));
        localStorage.setItem('loans', JSON.stringify(this.loans));
        localStorage.setItem('payments', JSON.stringify(this.payments));
        localStorage.setItem('properties', JSON.stringify(this.properties));
        localStorage.setItem('tenants', JSON.stringify(this.tenants));
        localStorage.setItem('rentPayments', JSON.stringify(this.rentPayments));
        localStorage.setItem('tranches', JSON.stringify(this.tranches));
        localStorage.setItem('notes', JSON.stringify(this.notes));
      }

      showNotification(message, type = 'success') {
        const container = document.getElementById('notificationContainer');
        if (!container) return;

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span>${message}</span>
            <button style="background: none; border: none; color: inherit; cursor: pointer; font-size: 1.2rem;">Ã—</button>
          </div>
        `;

        notification.querySelector('button').addEventListener('click', () => {
          notification.remove();
        });

        container.appendChild(notification);

        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, 5000);
      }
    }

    // Initialize application
    document.addEventListener('DOMContentLoaded', () => {
      window.bankingSystem = new BankingSystem();
    });
  </script>
</body>
</html>
