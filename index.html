<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lindan Equities - Professional Banking Management System</title>
    <style>
        /* LINDAN EQUITIES PROFESSIONAL BANKING MANAGEMENT SYSTEM */
        /* Enterprise-Grade Banking Software with Complete Loan Management */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Professional Money Green Color Palette */
            --primary-money-green: #2d6a4f;
            --secondary-green: #40916c;
            --accent-gold: #f4a261;
            --light-green: #95d5b2;
            --dark-forest: #1b4332;
            --medium-green: #52796f;
            --light-sage: #d8f3dc;
            --text-dark: #1a202c;
            --text-light: #52796f;
            --success-green: #40916c;
            --warning-orange: #f77f00;
            --error-red: #d62828;
            --white: #ffffff;
            --border-color: #a7c957;
            --hover-bg: rgba(64, 145, 108, 0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--primary-money-green) 0%, var(--secondary-green) 100%);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.5;
        }

        .hidden {
            display: none !important;
        }

        /* LOGIN SCREEN */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .login-container {
            background: var(--white);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 450px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--success-green) 0%, var(--primary-money-green) 50%, var(--accent-gold) 100%);
        }

        .company-logo {
            margin-bottom: 2rem;
        }

        .company-logo h1 {
            font-size: 2.2rem;
            color: var(--primary-money-green);
            margin-bottom: 0.5rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .company-tagline {
            color: var(--text-light);
            font-size: 1rem;
            margin-bottom: 2rem;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-control {
            width: 100%;
            padding: 1.2rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--white);
            color: var(--text-dark);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-money-green);
            background: var(--white);
            box-shadow: 0 0 0 3px rgba(45, 106, 79, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 1.2rem;
            background: linear-gradient(135deg, var(--primary-money-green) 0%, var(--secondary-green) 100%);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .login-help {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .error-message {
            background: #fed7d7;
            color: var(--error-red);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            display: none;
            font-weight: 500;
        }

        /* MAIN APPLICATION */
        .app-container {
            min-height: 100vh;
            background: var(--light-sage);
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary-money-green) 0%, var(--secondary-green) 100%);
            color: var(--white);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: relative;
        }

        .app-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--success-green) 0%, var(--accent-gold) 100%);
        }

        /* UPDATED: Header layout - dropdown far left, bigger logo, NO company name */
        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
            flex: 1;
        }

        /* Dropdown moved to far left (order: 1) */
        .app-switcher {
            padding: 0.8rem 1.4rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.95);
            color: var(--text-dark);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            order: 1;
        }

        .app-switcher:hover {
            background: rgba(255,255,255,1);
            transform: translateY(-1px);
        }

        .app-switcher option {
            background: var(--white);
            color: var(--text-dark);
            font-weight: 600;
        }

        /* Bigger logo positioned after dropdown */
        .logo-container {
            display: flex;
            align-items: center;
            order: 2;
        }

        .logo-container img {
            height: 50px;
            width: auto;
            max-width: 300px;
            object-fit: contain;
            border-radius: 8px;
            background: var(--white);
            padding: 8px 15px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }

        .logo-container img:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .prime-rate-display {
            background: rgba(255,255,255,0.15);
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .prime-rate-display:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }

        .app-main {
            display: flex;
            flex: 1;
        }

        /* SIDEBAR */
        .sidebar {
            width: 280px;
            background: var(--white);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            box-shadow: 4px 0 15px rgba(0,0,0,0.08);
        }

        .sidebar-nav {
            padding: 1rem 0;
            list-style: none;
        }

        .sidebar-nav li {
            margin-bottom: 0.25rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: var(--text-light);
            text-decoration: none;
            transition: all 0.3s ease;
            border-right: 4px solid transparent;
            gap: 1rem;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
            user-select: none;
        }

        .nav-link:hover {
            background: var(--hover-bg);
            color: var(--success-green);
            border-right-color: rgba(64, 145, 108, 0.2);
        }

        .nav-link.active {
            background: rgba(64, 145, 108, 0.1);
            color: var(--success-green);
            border-right-color: var(--success-green);
            font-weight: 600;
        }

        .nav-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
            pointer-events: none;
        }

        .nav-text {
            flex: 1;
            pointer-events: none;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .view-header {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .view-header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
        }

        .export-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* DASHBOARD */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--white);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-left: 5px solid var(--success-green);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--accent-gold), transparent);
            opacity: 0.05;
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .metric-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-icon {
            font-size: 2.5rem;
            opacity: 0.7;
            color: var(--success-green);
        }

        .metric-value {
            font-size: 2.8rem;
            font-weight: 700;
            color: var(--primary-money-green);
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .metric-subtitle {
            font-size: 0.95rem;
            color: var(--text-light);
            font-weight: 500;
        }

        /* BUTTONS */
        .btn {
            padding: 0.7rem 1.4rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--success-green) 0%, var(--secondary-green) 100%);
            color: var(--white);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(64, 145, 108, 0.3);
        }

        .btn-secondary {
            background: var(--medium-green);
            color: var(--white);
        }

        .btn-danger {
            background: var(--error-red);
            color: var(--white);
        }

        .btn-warning {
            background: var(--warning-orange);
            color: var(--white);
        }

        .btn-success {
            background: var(--success-green);
            color: var(--white);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--accent-gold);
            color: var(--accent-gold);
        }

        .btn-outline:hover {
            background: var(--accent-gold);
            color: var(--white);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .btn-export {
            background: var(--accent-gold);
            color: var(--white);
            font-size: 0.85rem;
            padding: 0.6rem 1rem;
        }

        .btn-export:hover {
            background: var(--warning-orange);
            transform: translateY(-1px);
        }

        /* TABLES */
        .table-container {
            background: var(--white);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }

        .table-scroll {
            overflow-x: auto;
            width: 100%;
        }

        .table-container table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
        }

        .table-container th {
            background: var(--light-sage);
            padding: 1.2rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-dark);
            border-bottom: 2px solid var(--border-color);
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .table-container td {
            padding: 1.2rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-dark);
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .table-container tbody tr:hover {
            background: var(--hover-bg);
        }

        /* STATUS BADGES */
        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-upcoming {
            background: #b8e6d3;
            color: var(--secondary-green);
        }

        .status-paid {
            background: var(--light-green);
            color: var(--success-green);
        }

        .status-overdue {
            background: #fed7d7;
            color: var(--error-red);
        }

        .status-missed {
            background: #feebc8;
            color: var(--warning-orange);
        }

        .status-fixed {
            background: #e2e8f0;
            color: var(--text-dark);
        }

        .status-variable {
            background: #fef5e7;
            color: var(--accent-gold);
        }

        .status-active {
            background: var(--light-green);
            color: var(--success-green);
        }

        /* MODALS */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--white);
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            color: var(--text-dark);
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--text-dark);
            background: var(--light-sage);
        }

        /* FORM LAYOUTS */
        .form-layout {
            background: var(--white);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }

        .form-section {
            margin-bottom: 2rem;
        }

        .form-section h3 {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .form-row {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }

        /* NOTIFICATIONS */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-green);
            color: var(--white);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 1001;
            animation: slideIn 0.3s ease;
            max-width: 400px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .notification.error {
            background: var(--error-red);
        }

        .notification.warning {
            background: var(--warning-orange);
        }

        .notification.success {
            background: var(--success-green);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            .app-main {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .sidebar-nav {
                display: flex;
                overflow-x: auto;
                padding: 1rem;
                gap: 0.5rem;
            }
            
            .sidebar-nav li {
                margin-bottom: 0;
                flex-shrink: 0;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }

            .header-left {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .export-buttons {
                width: 100%;
                justify-content: center;
            }

            .logo-container img {
                height: 40px;
                max-width: 200px;
            }

            .app-switcher {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
        }

        /* LOADING STATE */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--text-light);
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }

        .empty-state h3 {
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        /* NEW: Period Selector for Reports */
        .period-selector {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }

        .period-selector h4 {
            margin-bottom: 1rem;
            color: var(--text-dark);
            font-size: 1.1rem;
        }

        .date-range {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-range input[type="date"] {
            padding: 0.8rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .quick-periods {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .period-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--success-green);
            background: transparent;
            color: var(--success-green);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .period-btn.active,
        .period-btn:hover {
            background: var(--success-green);
            color: var(--white);
        }

        /* NEW: User Management Styles */
        .user-role-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .role-admin {
            background: #feebc8;
            color: var(--warning-orange);
        }

        .role-manager {
            background: var(--light-green);
            color: var(--success-green);
        }

        .role-user {
            background: #e2e8f0;
            color: var(--text-dark);
        }

        .role-viewer {
            background: #fed7d7;
            color: var(--error-red);
        }

        /* NEW: Loan Schedule Styles */
        .schedule-summary {
            background: var(--white);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-left: 5px solid var(--success-green);
        }

        .schedule-summary h3 {
            color: var(--primary-money-green);
            margin-bottom: 1rem;
            font-size: 1.4rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-weight: 600;
            color: var(--text-dark);
        }

        .summary-value {
            color: var(--success-green);
            font-weight: 600;
        }

        /* NEW: Tranche Modal Styles */
        .tranche-type-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .tranche-type {
            flex: 1;
            padding: 1.5rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tranche-type.selected {
            border-color: var(--success-green);
            background: var(--hover-bg);
        }

        .tranche-type h4 {
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .tranche-type p {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* NEW: Annual Statement Styles */
        .statement-header {
            text-align: center;
            padding: 2rem;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .statement-logo {
            height: 60px;
            margin-bottom: 1rem;
        }

        .statement-title {
            font-size: 1.8rem;
            color: var(--primary-money-green);
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .statement-period {
            color: var(--text-light);
            font-size: 1.1rem;
        }

        .statement-section {
            margin-bottom: 2rem;
        }

        .statement-section h4 {
            color: var(--primary-money-green);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="company-logo">
                <h1>Lindan Equities</h1>
                <div class="company-tagline">Professional Banking Management System</div>
            </div>
            
            <div id="loginError" class="error-message">Invalid username or password</div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="username">Username</label>
                    <input type="text" id="username" class="form-control" value="admin" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="password">Password</label>
                    <input type="password" id="password" class="form-control" value="admin123" required>
                </div>
                
                <button type="submit" id="loginButton" class="login-btn">Access System</button>
            </form>
            
            <div class="login-help">
                <p><strong>Demo Credentials:</strong></p>
                <p>Username: admin | Password: admin123</p>
                <p style="margin-top: 1rem; font-size: 0.8rem; font-style: italic;">
                    Professional banking-grade system with complete loan management
                </p>
            </div>
        </div>
    </div>

    <!-- MAIN APPLICATION -->
    <div id="mainApp" class="app-container hidden">
        <header class="app-header">
            <div class="header-left">
                <!-- Dropdown at far left -->
                <select id="appModeSelector" class="app-switcher">
                    <option value="loan">Loan Management</option>
                    <option value="realestate">Real Estate Management</option>
                </select>
                <!-- Bigger logo -->
                <div class="logo-container">
                    <img src="Lindan Logo.jpg" alt="Lindan Equities" />
                </div>
            </div>
            
            <div class="header-right">
                <div id="primeRateDisplay" class="prime-rate-display" title="Click to update Prime Rate">
                    Prime Rate: <span id="primeRateValue">5.50</span>%
                </div>
                <span id="userDisplay">Welcome, Admin</span>
                <button id="logoutBtn" class="btn btn-outline">Logout</button>
            </div>
        </header>

        <div class="app-main">
            <!-- LEFT SIDEBAR -->
            <aside class="sidebar">
                <nav>
                    <ul class="sidebar-nav" id="sidebarNav">
                        <!-- Navigation populated by JavaScript -->
                    </ul>
                </nav>
            </aside>

            <!-- MAIN CONTENT AREA -->
            <main class="main-content">
                <!-- DASHBOARD VIEW -->
                <div id="dashboard" class="view active">
                    <div class="view-header">
                        <h1 id="dashboardTitle">Portfolio Dashboard</h1>
                    </div>
                    <div class="dashboard-grid" id="dashboardMetrics">
                        <!-- Metrics populated by JavaScript -->
                    </div>
                </div>

                <!-- ALL LOANS VIEW -->
                <div id="loans" class="view">
                    <div class="view-header">
                        <h1>All Loans</h1>
                        <div class="export-buttons">
                            <button class="btn btn-primary" id="addLoanBtn">Add New Loan</button>
                            <button class="btn btn-export" id="exportLoansExcel">Export Schedule to Excel</button>
                            <button class="btn btn-export" id="exportLoansPDF">Export Annual Statements</button>
                        </div>
                    </div>
                    <div class="table-container" id="loansTable">
                        <!-- Loans table populated by JavaScript -->
                    </div>
                </div>

                <!-- NEW LOAN VIEW -->
                <div id="new-loan" class="view">
                    <div class="view-header">
                        <h1>Create New Loan</h1>
                    </div>
                    <div class="form-layout">
                        <div class="form-section">
                            <h3>Loan Origination</h3>
                            <p>Professional loan setup with banking-grade features and calculations.</p>
                            <div style="margin-top: 2rem;">
                                <button class="btn btn-primary" id="quickAddLoanBtn">Add New Loan</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PAYMENT SCHEDULE VIEW -->
                <div id="payment-schedule" class="view">
                    <div class="view-header">
                        <h1>Payment Schedule</h1>
                        <div class="export-buttons">
                            <button class="btn btn-export" id="exportPaymentsExcel">Export to Excel</button>
                        </div>
                    </div>
                    
                    <div class="schedule-controls">
                        <div class="schedule-filters">
                            <div class="filter-group">
                                <label>Filter by Loan:</label>
                                <select id="loanFilter" class="form-control">
                                    <option value="all">All Loans</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="paymentScheduleContent">
                        <!-- Payment schedule populated by JavaScript -->
                    </div>
                </div>

                <!-- PROPERTIES VIEW -->
                <div id="properties" class="view">
                    <div class="view-header">
                        <h1>Properties</h1>
                        <div class="export-buttons">
                            <button class="btn btn-primary" id="addPropertyBtn">Add Property</button>
                            <button class="btn btn-export" id="exportPropertiesExcel">Export to Excel</button>
                        </div>
                    </div>
                    <div class="properties-grid" id="propertiesGrid">
                        <!-- Properties populated by JavaScript -->
                    </div>
                </div>

                <!-- TENANTS VIEW -->
                <div id="tenants" class="view">
                    <div class="view-header">
                        <h1>Tenants</h1>
                        <div class="export-buttons">
                            <button class="btn btn-primary" id="addTenantBtn">Add Tenant</button>
                            <button class="btn btn-export" id="exportTenantsExcel">Export to Excel</button>
                        </div>
                    </div>
                    <div class="table-container" id="tenantsTable">
                        <!-- Tenants table populated by JavaScript -->
                    </div>
                </div>

                <!-- REPORTS VIEW -->
                <div id="reports" class="view">
                    <div class="view-header">
                        <h1>Reports & Analytics</h1>
                    </div>
                    
                    <!-- Period Selector for Annual Statements -->
                    <div class="period-selector">
                        <h4>Annual Statement Period Selection</h4>
                        <div class="date-range">
                            <label>From:</label>
                            <input type="date" id="statementStartDate" value="2024-01-01">
                            <label>To:</label>
                            <input type="date" id="statementEndDate" value="2024-12-31">
                            <button class="btn btn-primary" id="generateStatementBtn">Generate Statement</button>
                        </div>
                        <div class="quick-periods">
                            <button class="period-btn active" data-period="current-year">Current Year</button>
                            <button class="period-btn" data-period="last-year">Last Year</button>
                            <button class="period-btn" data-period="ytd">Year to Date</button>
                            <button class="period-btn" data-period="custom">Custom Range</button>
                        </div>
                    </div>

                    <!-- Reports Grid -->
                    <div class="reports-grid">
                        <div class="report-section">
                            <div class="report-header">
                                <h3>Loan Reports</h3>
                            </div>
                            <div class="export-buttons" style="flex-direction: column; align-items: stretch; gap: 1rem;">
                                <button class="btn btn-export" id="exportLoanScheduleExcel">Export Loan Schedules (Excel)</button>
                                <button class="btn btn-export" id="exportAnnualStatementsBtn">Generate Annual Statements (PDF)</button>
                                <button class="btn btn-export" id="exportLoanPerformanceExcel">Loan Performance Report</button>
                            </div>
                        </div>
                        
                        <div class="report-section">
                            <div class="report-header">
                                <h3>Real Estate Reports</h3>
                            </div>
                            <div class="export-buttons" style="flex-direction: column; align-items: stretch; gap: 1rem;">
                                <button class="btn btn-export" id="exportRentRollExcel">Rent Roll Report</button>
                                <button class="btn btn-export" id="exportPropertyPLExcel">Property P&L Statements</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- USER MANAGEMENT VIEW -->
                <div id="user-management" class="view">
                    <div class="view-header">
                        <h1>User Management</h1>
                        <div class="export-buttons">
                            <button class="btn btn-primary" id="addUserBtn">Add New User</button>
                        </div>
                    </div>
                    <div class="table-container" id="usersTable">
                        <!-- Users table populated by JavaScript -->
                    </div>
                </div>

                <!-- SETTINGS VIEW -->
                <div id="settings" class="view">
                    <div class="view-header">
                        <h1>System Settings</h1>
                    </div>
                    <div class="form-layout">
                        <div class="form-section">
                            <h3>Interest Rate Configuration</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Current Prime Rate (%)</label>
                                    <input type="number" id="settingsPrimeRate" class="form-control" step="0.01" value="5.50">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Default Fixed Rate (%)</label>
                                    <input type="number" class="form-control" value="6.5" step="0.1">
                                </div>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-primary" id="savePrimeRateBtn">Save Changes</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- MODAL CONTAINER -->
    <div id="modalContainer"></div>

    <!-- NOTIFICATION CONTAINER -->
    <div id="notificationContainer"></div>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // LINDAN EQUITIES PROFESSIONAL BANKING MANAGEMENT SYSTEM
        // Enterprise-Grade Banking Software with Complete Features
        
        class ProfessionalBankingSystem {
            constructor() {
                console.log('Professional Banking System initializing...');
                
                this.currentUser = null;
                this.currentMode = 'loan';
                this.currentView = 'dashboard';
                this.currentFilter = 'upcoming';
                
                // System settings
                this.primeRate = parseFloat(localStorage.getItem('primeRate')) || 5.50;
                this.primeRateHistory = JSON.parse(localStorage.getItem('primeRateHistory')) || this.getDefaultPrimeHistory();
                
                // Initialize data
                this.loans = this.loadData('loans') || this.getDefaultLoans();
                this.properties = this.loadData('properties') || this.getDefaultProperties();
                this.tenants = this.loadData('tenants') || this.getDefaultTenants();
                this.users = this.loadData('users') || this.getDefaultUsers();
                this.tranches = this.loadData('tranches') || [];
                this.payments = this.loadData('payments') || [];
                this.rentPayments = this.loadData('rentPayments') || [];
                
                // Generate schedules if empty
                if (this.payments.length === 0) {
                    this.generatePaymentSchedules();
                }
                
                this.init();
            }
            
            init() {
                console.log('Setting up event listeners...');
                this.setupEventListeners();
                this.updatePrimeRateDisplay();
            }
            
            setupEventListeners() {
                // LOGIN FORM
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleLogin();
                    });
                }
                
                // LOGOUT BUTTON
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => this.handleLogout());
                }
                
                // APP MODE SELECTOR
                const appModeSelector = document.getElementById('appModeSelector');
                if (appModeSelector) {
                    appModeSelector.addEventListener('change', (e) => {
                        this.switchMode(e.target.value);
                    });
                }
                
                // PRIME RATE DISPLAY
                const primeRateDisplay = document.getElementById('primeRateDisplay');
                if (primeRateDisplay) {
                    primeRateDisplay.addEventListener('click', () => {
                        this.showUpdatePrimeRateModal();
                    });
                }
                
                // EXPORT BUTTONS
                this.setupExportButtons();
                
                // PERIOD SELECTOR
                this.setupPeriodSelector();
                
                // GLOBAL CLICK HANDLER
                document.addEventListener('click', (e) => {
                    this.handleGlobalClick(e);
                });
                
                // FILTER CHANGES
                const loanFilter = document.getElementById('loanFilter');
                if (loanFilter) {
                    loanFilter.addEventListener('change', () => {
                        this.renderPaymentSchedule();
                    });
                }
            }

            setupExportButtons() {
                // Fixed export buttons
                this.addEventListenerSafe('exportLoansExcel', () => this.exportLoanSchedulesToExcel());
                this.addEventListenerSafe('exportLoansPDF', () => this.exportAnnualStatements());
                this.addEventListenerSafe('exportPaymentsExcel', () => this.exportPaymentScheduleToExcel());
                this.addEventListenerSafe('exportLoanScheduleExcel', () => this.exportLoanSchedulesToExcel());
                this.addEventListenerSafe('exportAnnualStatementsBtn', () => this.exportAnnualStatements());
                this.addEventListenerSafe('exportLoanPerformanceExcel', () => this.exportLoanPerformanceReport());
                this.addEventListenerSafe('exportPropertiesExcel', () => this.exportPropertiesToExcel());
                this.addEventListenerSafe('exportTenantsExcel', () => this.exportTenantsToExcel());
                this.addEventListenerSafe('exportRentRollExcel', () => this.exportRentRollReport());
                this.addEventListenerSafe('exportPropertyPLExcel', () => this.exportPropertyPLStatements());
                this.addEventListenerSafe('generateStatementBtn', () => this.generateAnnualStatement());
            }

            setupPeriodSelector() {
                const periodButtons = document.querySelectorAll('.period-btn');
                periodButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        periodButtons.forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        
                        const period = e.target.dataset.period;
                        this.setDateRange(period);
                    });
                });
            }

            setDateRange(period) {
                const startDate = document.getElementById('statementStartDate');
                const endDate = document.getElementById('statementEndDate');
                const now = new Date();
                
                switch (period) {
                    case 'current-year':
                        startDate.value = `${now.getFullYear()}-01-01`;
                        endDate.value = `${now.getFullYear()}-12-31`;
                        break;
                    case 'last-year':
                        startDate.value = `${now.getFullYear() - 1}-01-01`;
                        endDate.value = `${now.getFullYear() - 1}-12-31`;
                        break;
                    case 'ytd':
                        startDate.value = `${now.getFullYear()}-01-01`;
                        endDate.value = now.toISOString().split('T')[0];
                        break;
                    case 'custom':
                        // Let user set their own dates
                        break;
                }
            }

            addEventListenerSafe(id, callback) {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('click', callback);
                }
            }
            
            handleGlobalClick(e) {
                // Navigation links
                if (e.target.closest('.nav-link')) {
                    e.preventDefault();
                    const navLink = e.target.closest('.nav-link');
                    const view = navLink.getAttribute('data-view');
                    if (view) {
                        this.showView(view);
                    }
                    return;
                }
                
                // Tranche button - FIXED
                if (e.target.classList.contains('btn-tranche') || e.target.textContent === 'Tranche') {
                    const loanId = e.target.getAttribute('data-loan-id') || 
                                  e.target.onclick?.toString().match(/addTranche\((\d+)\)/)?.[1];
                    if (loanId) {
                        this.showTrancheModal(parseInt(loanId));
                    }
                    return;
                }
                
                // Add buttons
                if (e.target.id === 'addLoanBtn' || e.target.id === 'quickAddLoanBtn') {
                    this.showAddLoanModal();
                    return;
                }
                
                if (e.target.id === 'addUserBtn') {
                    this.showAddUserModal();
                    return;
                }
                
                // Modal close
                if (e.target.classList.contains('modal-close') || e.target.closest('.modal-close')) {
                    this.closeModal();
                    return;
                }
                
                // Close modal on backdrop click
                if (e.target.classList.contains('modal')) {
                    this.closeModal();
                    return;
                }
            }
            
            // LOGIN LOGIC
            handleLogin() {
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                const errorDiv = document.getElementById('loginError');
                
                // Check against user database
                const user = this.users.find(u => u.username === username && u.password === password);
                
                if (user) {
                    this.currentUser = user;
                    
                    if (errorDiv) {
                        errorDiv.style.display = 'none';
                    }
                    
                    this.showMainApp();
                    this.showNotification(`Welcome back, ${user.firstName}!`, 'success');
                } else {
                    if (errorDiv) {
                        errorDiv.style.display = 'block';
                        errorDiv.textContent = 'Invalid username or password';
                    }
                }
            }
            
            showMainApp() {
                const loginScreen = document.getElementById('loginScreen');
                const mainApp = document.getElementById('mainApp');
                
                if (loginScreen && mainApp) {
                    loginScreen.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    
                    this.initializeMainApp();
                }
            }
            
            initializeMainApp() {
                this.updateNavigation();
                this.populateFilters();
                this.renderDashboard();
                
                // Update user display
                const userDisplay = document.getElementById('userDisplay');
                if (userDisplay && this.currentUser) {
                    userDisplay.textContent = `Welcome, ${this.currentUser.firstName} ${this.currentUser.lastName}`;
                }
            }
            
            handleLogout() {
                this.currentUser = null;
                
                const loginScreen = document.getElementById('loginScreen');
                const mainApp = document.getElementById('mainApp');
                
                if (loginScreen && mainApp) {
                    mainApp.classList.add('hidden');
                    loginScreen.classList.remove('hidden');
                }
            }
            
            // NAVIGATION
            updateNavigation() {
                const sidebarNav = document.getElementById('sidebarNav');
                if (!sidebarNav) return;
                
                let navItems = [];
                
                // Check user permissions
                const canViewUsers = this.currentUser?.role === 'admin';
                
                if (this.currentMode === 'loan') {
                    navItems = [
                        { view: 'dashboard', label: 'Dashboard', icon: '📊' },
                        { view: 'loans', label: 'All Loans', icon: '💰' },
                        { view: 'new-loan', label: 'New Loan', icon: '➕' },
                        { view: 'payment-schedule', label: 'Payment Schedule', icon: '📅' },
                        { view: 'reports', label: 'Reports', icon: '📈' },
                    ];
                } else {
                    navItems = [
                        { view: 'dashboard', label: 'Dashboard', icon: '📊' },
                        { view: 'properties', label: 'Properties', icon: '🏢' },
                        { view: 'tenants', label: 'Tenants', icon: '👥' },
                        { view: 'reports', label: 'Reports', icon: '📈' },
                    ];
                }

                // Add user management for admins
                if (canViewUsers) {
                    navItems.push({ view: 'user-management', label: 'User Management', icon: '👤' });
                }

                navItems.push({ view: 'settings', label: 'Settings', icon: '⚙️' });
                
                sidebarNav.innerHTML = navItems.map(item => `
                    <li>
                        <div class="nav-link ${this.currentView === item.view ? 'active' : ''}" 
                             data-view="${item.view}">
                            <span class="nav-icon">${item.icon}</span>
                            <span class="nav-text">${item.label}</span>
                        </div>
                    </li>
                `).join('');
            }
            
            switchMode(mode) {
                this.currentMode = mode;
                this.updateNavigation();
                this.showView('dashboard');
            }
            
            showView(viewName) {
                // Hide all views
                document.querySelectorAll('.view').forEach(view => {
                    view.classList.remove('active');
                });
                
                // Show target view
                const targetView = document.getElementById(viewName);
                if (targetView) {
                    targetView.classList.add('active');
                } else {
                    console.error('View not found:', viewName);
                    return;
                }
                
                // Update navigation
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('data-view') === viewName) {
                        link.classList.add('active');
                    }
                });
                
                this.currentView = viewName;
                
                // Render view-specific content
                switch (viewName) {
                    case 'dashboard':
                        this.renderDashboard();
                        break;
                    case 'loans':
                        this.renderLoansView();
                        break;
                    case 'payment-schedule':
                        this.renderPaymentSchedule();
                        break;
                    case 'properties':
                        this.renderPropertiesView();
                        break;
                    case 'tenants':
                        this.renderTenantsView();
                        break;
                    case 'user-management':
                        this.renderUserManagement();
                        break;
                    case 'reports':
                        // Reports view is static HTML
                        break;
                }
            }

            // PRIME RATE MANAGEMENT
            updatePrimeRateDisplay() {
                const primeRateValue = document.getElementById('primeRateValue');
                if (primeRateValue) {
                    primeRateValue.textContent = this.primeRate.toFixed(2);
                }
            }

            showUpdatePrimeRateModal() {
                const modalContainer = document.getElementById('modalContainer');
                if (!modalContainer) return;
                
                modalContainer.innerHTML = `
                    <div class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>Update Prime Rate</h3>
                                <button class="modal-close">&times;</button>
                            </div>
                            <form id="updatePrimeRateForm">
                                <div class="form-group">
                                    <label class="form-label">New Prime Rate (%)</label>
                                    <input type="number" id="newPrimeRate" class="form-control" 
                                           step="0.01" min="0" max="50" value="${this.primeRate.toFixed(2)}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Effective Date</label>
                                    <input type="date" id="effectiveDate" class="form-control" 
                                           value="${new Date().toISOString().split('T')[0]}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Notes (Optional)</label>
                                    <textarea id="rateChangeNotes" class="form-control" rows="3" 
                                              placeholder="Reason for rate change..."></textarea>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">Update Prime Rate</button>
                                    <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                const form = document.getElementById('updatePrimeRateForm');
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.updatePrimeRate();
                    });
                }
            }

            updatePrimeRate() {
                const newPrimeRate = document.getElementById('newPrimeRate');
                const effectiveDate = document.getElementById('effectiveDate');
                const notes = document.getElementById('rateChangeNotes');
                
                if (!newPrimeRate || !effectiveDate) {
                    this.showNotification('Form elements not found', 'error');
                    return;
                }
                
                const newRate = parseFloat(newPrimeRate.value);
                const dateValue = effectiveDate.value;
                const notesValue = notes ? notes.value.trim() : '';
                
                if (!newRate || !dateValue) {
                    this.showNotification('Please fill in all required fields', 'error');
                    return;
                }
                
                if (newRate < 0 || newRate > 50) {
                    this.showNotification('Prime rate must be between 0% and 50%', 'error');
                    return;
                }
                
                const oldRate = this.primeRate;
                this.primeRate = newRate;
                
                // Save to history
                const historyEntry = {
                    id: Date.now(),
                    rate: newRate,
                    effectiveDate: dateValue,
                    previousRate: oldRate,
                    notes: notesValue,
                    updatedAt: new Date().toISOString(),
                    updatedBy: this.currentUser?.username || 'system'
                };
                
                this.primeRateHistory.unshift(historyEntry);
                
                // Update variable rate loans
                this.updateVariableRateLoans(newRate);
                
                // Save data
                localStorage.setItem('primeRate', newRate.toString());
                localStorage.setItem('primeRateHistory', JSON.stringify(this.primeRateHistory));
                this.saveData('loans', this.loans);
                
                this.updatePrimeRateDisplay();
                this.closeModal();
                
                this.showNotification(`Prime rate updated to ${newRate.toFixed(2)}%`, 'success');
                
                // Refresh displays
                this.renderDashboard();
                this.renderLoansView();
            }

            updateVariableRateLoans(newPrimeRate) {
                this.loans.forEach(loan => {
                    if (loan.rateType === 'variable' && loan.spread !== undefined) {
                        loan.interestRate = newPrimeRate + loan.spread;
                        
                        // Recalculate monthly payment for variable rate loans
                        if (loan.paymentType === 'blended') {
                            const monthlyRate = loan.interestRate / 100 / 12;
                            const remainingPayments = loan.termMonths;
                            
                            if (monthlyRate > 0) {
                                loan.monthlyPayment = loan.currentBalance * 
                                    (monthlyRate * Math.pow(1 + monthlyRate, remainingPayments)) / 
                                    (Math.pow(1 + monthlyRate, remainingPayments) - 1);
                            }
                        } else if (loan.paymentType === 'interest_only') {
                            loan.monthlyPayment = loan.currentBalance * (loan.interestRate / 100) / 12;
                        }
                    }
                });
            }

            // TRANCHE MANAGEMENT - FIXED IMPLEMENTATION
            showTrancheModal(loanId) {
                const loan = this.loans.find(l => l.id === loanId);
                if (!loan) {
                    this.showNotification('Loan not found', 'error');
                    return;
                }

                const modalContainer = document.getElementById('modalContainer');
                if (!modalContainer) return;
                
                modalContainer.innerHTML = `
                    <div class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>Loan Tranche - ${loan.borrowerName}</h3>
                                <button class="modal-close">&times;</button>
                            </div>
                            
                            <div class="tranche-type-selector">
                                <div class="tranche-type selected" data-type="payment-received">
                                    <h4>💰 Payment Received</h4>
                                    <p>Record a payment made by the borrower</p>
                                </div>
                                <div class="tranche-type" data-type="advance-given">
                                    <h4>📤 Advance Given</h4>
                                    <p>Record money advanced to the borrower</p>
                                </div>
                            </div>
                            
                            <form id="trancheForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Amount ($)</label>
                                        <input type="number" id="trancheAmount" class="form-control" 
                                               step="0.01" min="0" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Transaction Date</label>
                                        <input type="date" id="trancheDate" class="form-control" 
                                               value="${new Date().toISOString().split('T')[0]}" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Description</label>
                                    <textarea id="trancheDescription" class="form-control" rows="3" 
                                              placeholder="Description of the transaction..."></textarea>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">Process Tranche</button>
                                    <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;

                // Setup tranche type selection
                const trancheTypes = document.querySelectorAll('.tranche-type');
                trancheTypes.forEach(type => {
                    type.addEventListener('click', () => {
                        trancheTypes.forEach(t => t.classList.remove('selected'));
                        type.classList.add('selected');
                    });
                });
                
                const form = document.getElementById('trancheForm');
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.processTrancheTransaction(loanId);
                    });
                }
            }

            processTrancheTransaction(loanId) {
                const loan = this.loans.find(l => l.id === loanId);
                if (!loan) return;

                const selectedType = document.querySelector('.tranche-type.selected')?.dataset.type;
                const amount = parseFloat(document.getElementById('trancheAmount').value);
                const date = document.getElementById('trancheDate').value;
                const description = document.getElementById('trancheDescription').value;

                if (!amount || !date) {
                    this.showNotification('Please fill in all required fields', 'error');
                    return;
                }

                // Create tranche record
                const tranche = {
                    id: Date.now(),
                    loanId: loanId,
                    type: selectedType,
                    amount: amount,
                    date: date,
                    description: description,
                    createdBy: this.currentUser?.username || 'system',
                    createdAt: new Date().toISOString()
                };

                // Update loan balance based on tranche type
                const oldBalance = loan.currentBalance;
                
                if (selectedType === 'payment-received') {
                    // Payment received - reduce balance
                    loan.currentBalance = Math.max(0, loan.currentBalance - amount);
                    
                    // Update payment schedule to reflect this payment
                    this.applyPaymentToSchedule(loanId, amount, date);
                    
                } else if (selectedType === 'advance-given') {
                    // Advance given - increase balance
                    loan.currentBalance += amount;
                    
                    // Regenerate payment schedule with new balance
                    this.recalculatePaymentSchedule(loanId, date);
                }

                // Save tranche
                this.tranches.push(tranche);
                this.saveData('tranches', this.tranches);
                this.saveData('loans', this.loans);

                this.closeModal();
                
                const transactionType = selectedType === 'payment-received' ? 'Payment' : 'Advance';
                this.showNotification(
                    `${transactionType} of $${this.formatCurrency(amount)} processed successfully. ` +
                    `New balance: $${this.formatCurrency(loan.currentBalance)}`, 
                    'success'
                );
                
                // Refresh displays
                this.renderDashboard();
                this.renderLoansView();
                this.renderPaymentSchedule();
            }

            applyPaymentToSchedule(loanId, paymentAmount, paymentDate) {
                // Find upcoming payments and apply the payment
                const upcomingPayments = this.payments.filter(p => 
                    p.loanId === loanId && 
                    p.status === 'upcoming' &&
                    new Date(p.dueDate) <= new Date(paymentDate)
                ).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

                let remainingPayment = paymentAmount;

                upcomingPayments.forEach(payment => {
                    if (remainingPayment <= 0) return;

                    if (remainingPayment >= payment.amount) {
                        // Full payment
                        payment.status = 'paid';
                        payment.paidDate = paymentDate;
                        payment.paidAmount = payment.amount;
                        remainingPayment -= payment.amount;
                    } else {
                        // Partial payment
                        payment.status = 'partial';
                        payment.paidDate = paymentDate;
                        payment.paidAmount = remainingPayment;
                        remainingPayment = 0;
                    }
                });

                this.saveData('payments', this.payments);
            }

            recalculatePaymentSchedule(loanId, fromDate) {
                // Remove future payments and regenerate
                this.payments = this.payments.filter(p => 
                    p.loanId !== loanId || 
                    new Date(p.dueDate) <= new Date(fromDate)
                );

                // Regenerate future payment schedule
                this.generatePaymentScheduleForLoan(loanId, fromDate);
                this.saveData('payments', this.payments);
            }

            generatePaymentScheduleForLoan(loanId, fromDate = null) {
                const loan = this.loans.find(l => l.id === loanId);
                if (!loan) return;

                const startDate = fromDate ? new Date(fromDate) : new Date(loan.startDate);
                const monthlyRate = loan.interestRate / 100 / 12;
                let currentBalance = loan.currentBalance;
                
                // Generate payments from start date
                for (let i = 1; i <= loan.termMonths; i++) {
                    const dueDate = new Date(startDate);
                    dueDate.setMonth(dueDate.getMonth() + i);
                    dueDate.setDate(loan.paymentDay);

                    const interestPayment = currentBalance * monthlyRate;
                    const principalPayment = loan.monthlyPayment - interestPayment;
                    currentBalance = Math.max(0, currentBalance - principalPayment);

                    const payment = {
                        id: Date.now() + i,
                        loanId: loanId,
                        paymentNumber: i,
                        dueDate: dueDate.toISOString().split('T')[0],
                        amount: loan.monthlyPayment,
                        principal: principalPayment,
                        interest: interestPayment,
                        balance: currentBalance,
                        status: 'upcoming',
                        borrowerName: loan.borrowerName
                    };

                    this.payments.push(payment);

                    if (currentBalance <= 0) break;
                }
            }

            // DASHBOARD RENDERING
            renderDashboard() {
                const metricsContainer = document.getElementById('dashboardMetrics');
                if (!metricsContainer) return;
                
                if (this.currentMode === 'loan') {
                    const totalLoans = this.loans.length;
                    const totalBalance = this.loans.reduce((sum, loan) => sum + loan.currentBalance, 0);
                    const monthlyPayments = this.loans.reduce((sum, loan) => sum + loan.monthlyPayment, 0);
                    
                    metricsContainer.innerHTML = `
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-title">Total Loans</div>
                                <div class="metric-icon">💰</div>
                            </div>
                            <div class="metric-value">${totalLoans}</div>
                            <div class="metric-subtitle">Active loan accounts</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-title">Outstanding Balance</div>
                                <div class="metric-icon">📊</div>
                            </div>
                            <div class="metric-value">$${this.formatCurrency(totalBalance)}</div>
                            <div class="metric-subtitle">Total principal owed</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-title">Monthly Income</div>
                                <div class="metric-icon">📈</div>
                            </div>
                            <div class="metric-value">$${this.formatCurrency(monthlyPayments)}</div>
                            <div class="metric-subtitle">Expected monthly revenue</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-title">Prime Rate</div>
                                <div class="metric-icon">⚖️</div>
                            </div>
                            <div class="metric-value">${this.primeRate.toFixed(2)}%</div>
                            <div class="metric-subtitle">Current benchmark rate</div>
                        </div>
                    `;
                } else {
                    const totalProperties = this.properties.length;
                    const totalValue = this.properties.reduce((sum, prop) => sum + (prop.value || 0), 0);
                    const monthlyRent = this.properties.reduce((sum, prop) => sum + (prop.monthlyRent || 0), 0);
                    const totalTenants = this.tenants.length;
                    
                    metricsContainer.innerHTML = `
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-title">Properties</div>
                                <div class="metric-icon">🏢</div>
                            </div>
                            <div class="metric-value">${totalProperties}</div>
                            <div class="metric-subtitle">Total properties managed</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-title">Portfolio Value</div>
                                <div class="metric-icon">💰</div>
                            </div>
                            <div class="metric-value">$${this.formatCurrency(totalValue)}</div>
                            <div class="metric-subtitle">Total property value</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-title">Monthly Rent</div>
                                <div class="metric-icon">📈</div>
                            </div>
                            <div class="metric-value">$${this.formatCurrency(monthlyRent)}</div>
                            <div class="metric-subtitle">Expected rental income</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-title">Active Tenants</div>
                                <div class="metric-icon">👥</div>
                            </div>
                            <div class="metric-value">${totalTenants}</div>
                            <div class="metric-subtitle">Current tenant count</div>
                        </div>
                    `;
                }
            }

            // LOANS VIEW
            renderLoansView() {
                const loansTable = document.getElementById('loansTable');
                if (!loansTable) return;
                
                if (this.loans.length === 0) {
                    loansTable.innerHTML = `
                        <div class="empty-state">
                            <h3>No Loans Found</h3>
                            <p>Click "Add New Loan" to get started with loan management.</p>
                        </div>
                    `;
                    return;
                }
                
                loansTable.innerHTML = `
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th>Borrower</th>
                                    <th>Original Amount</th>
                                    <th>Current Balance</th>
                                    <th>Rate Type</th>
                                    <th>Interest Rate</th>
                                    <th>Term</th>
                                    <th>Monthly Payment</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${this.loans.map(loan => {
                                    const rateDisplay = loan.rateType === 'variable' ? 
                                        `${loan.interestRate.toFixed(2)}% (P+${(loan.spread || 0).toFixed(2)})` : 
                                        `${loan.interestRate.toFixed(2)}%`;
                                    
                                    return `
                                        <tr>
                                            <td>
                                                <strong>${loan.borrowerName}</strong><br>
                                                <small style="color: var(--text-light);">${loan.borrowerEmail || 'No email'}</small>
                                            </td>
                                            <td>$${this.formatCurrency(loan.originalAmount)}</td>
                                            <td>$${this.formatCurrency(loan.currentBalance)}</td>
                                            <td>
                                                <span class="status-badge status-${loan.rateType || 'fixed'}">${(loan.rateType || 'Fixed').toUpperCase()}</span>
                                            </td>
                                            <td>${rateDisplay}</td>
                                            <td>${loan.termMonths} months</td>
                                            <td>$${this.formatCurrency(loan.monthlyPayment)}</td>
                                            <td>
                                                <span class="status-badge status-${loan.status || 'active'}">${(loan.status || 'active').toUpperCase()}</span>
                                            </td>
                                            <td>
                                                <div style="display: flex; gap: 0.3rem; flex-wrap: wrap;">
                                                    <button class="btn btn-sm btn-primary" onclick="businessSystem.editLoan(${loan.id})">Edit</button>
                                                    <button class="btn btn-sm btn-warning btn-tranche" data-loan-id="${loan.id}">Tranche</button>
                                                    <button class="btn btn-sm btn-danger" onclick="businessSystem.deleteLoan(${loan.id})">Delete</button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // PAYMENT SCHEDULE VIEW
            renderPaymentSchedule() {
                const loanFilter = document.getElementById('loanFilter');
                const content = document.getElementById('paymentScheduleContent');
                if (!content) return;

                let selectedLoanId = loanFilter?.value;
                let filteredPayments = [...this.payments];

                if (selectedLoanId && selectedLoanId !== 'all') {
                    selectedLoanId = parseInt(selectedLoanId);
                    filteredPayments = filteredPayments.filter(p => p.loanId === selectedLoanId);
                    
                    // Show individual loan schedule
                    const loan = this.loans.find(l => l.id === selectedLoanId);
                    if (loan) {
                        content.innerHTML = this.generateLoanScheduleView(loan, filteredPayments);
                        return;
                    }
                }

                // Show all payments summary
                content.innerHTML = `
                    <div class="table-container">
                        <div class="table-scroll">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Borrower</th>
                                        <th>Payment</th>
                                        <th>Principal</th>
                                        <th>Interest</th>
                                        <th>Balance</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredPayments.slice(0, 50).map(payment => `
                                        <tr>
                                            <td><strong>${this.formatDate(payment.dueDate)}</strong></td>
                                            <td>${payment.borrowerName}</td>
                                            <td>$${this.formatCurrency(payment.amount)}</td>
                                            <td>$${this.formatCurrency(payment.principal)}</td>
                                            <td>$${this.formatCurrency(payment.interest)}</td>
                                            <td>$${this.formatCurrency(payment.balance)}</td>
                                            <td><span class="status-badge status-${payment.status}">${payment.status.toUpperCase()}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            generateLoanScheduleView(loan, payments) {
                return `
                    <div class="schedule-summary">
                        <h3>${loan.borrowerName} - Loan Schedule</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <span class="summary-label">Original Amount:</span>
                                <span class="summary-value">$${this.formatCurrency(loan.originalAmount)}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Current Balance:</span>
                                <span class="summary-value">$${this.formatCurrency(loan.currentBalance)}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Interest Rate:</span>
                                <span class="summary-value">${loan.interestRate.toFixed(2)}%</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Term:</span>
                                <span class="summary-value">${loan.termMonths} months</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Monthly Payment:</span>
                                <span class="summary-value">$${this.formatCurrency(loan.monthlyPayment)}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Payment Type:</span>
                                <span class="summary-value">${loan.paymentType || 'blended'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-scroll">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Payment #</th>
                                        <th>Due Date</th>
                                        <th>Payment Amount</th>
                                        <th>Principal</th>
                                        <th>Interest</th>
                                        <th>Remaining Balance</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${payments.map(payment => `
                                        <tr>
                                            <td><strong>#${payment.paymentNumber}</strong></td>
                                            <td>${this.formatDate(payment.dueDate)}</td>
                                            <td>$${this.formatCurrency(payment.amount)}</td>
                                            <td>$${this.formatCurrency(payment.principal)}</td>
                                            <td>$${this.formatCurrency(payment.interest)}</td>
                                            <td>$${this.formatCurrency(payment.balance)}</td>
                                            <td><span class="status-badge status-${payment.status}">${payment.status.toUpperCase()}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            // USER MANAGEMENT
            renderUserManagement() {
                const usersTable = document.getElementById('usersTable');
                if (!usersTable) return;
                
                usersTable.innerHTML = `
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${this.users.map(user => `
                                    <tr>
                                        <td>
                                            <strong>${user.firstName} ${user.lastName}</strong>
                                        </td>
                                        <td>${user.username}</td>
                                        <td>${user.email}</td>
                                        <td>
                                            <span class="user-role-badge role-${user.role}">${user.role.toUpperCase()}</span>
                                        </td>
                                        <td>
                                            <span class="status-badge status-${user.status || 'active'}">${(user.status || 'active').toUpperCase()}</span>
                                        </td>
                                        <td>${user.lastLogin ? this.formatDateTime(user.lastLogin) : 'Never'}</td>
                                        <td>
                                            <div style="display: flex; gap: 0.3rem;">
                                                <button class="btn btn-sm btn-primary" onclick="businessSystem.editUser(${user.id})">Edit</button>
                                                ${user.username !== 'admin' ? `<button class="btn btn-sm btn-danger" onclick="businessSystem.deleteUser(${user.id})">Delete</button>` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // EXPORT FUNCTIONS - FIXED IMPLEMENTATIONS

            // Export loan schedules to Excel (proper format)
            exportLoanSchedulesToExcel() {
                try {
                    if (typeof XLSX === 'undefined') {
                        this.showNotification('Excel library not loaded. Please refresh the page.', 'error');
                        return;
                    }
                    
                    const workbook = XLSX.utils.book_new();
                    
                    // Create a sheet for each loan
                    this.loans.forEach(loan => {
                        const loanPayments = this.payments.filter(p => p.loanId === loan.id)
                            .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                        
                        // Create summary header
                        const summaryData = [
                            ['Loan Schedule for:', loan.borrowerName],
                            ['Original Amount:', `$${this.formatCurrency(loan.originalAmount)}`],
                            ['Current Balance:', `$${this.formatCurrency(loan.currentBalance)}`],
                            ['Interest Rate:', `${loan.interestRate.toFixed(2)}%`],
                            ['Term:', `${loan.termMonths} months`],
                            ['Monthly Payment:', `$${this.formatCurrency(loan.monthlyPayment)}`],
                            ['Rate Type:', loan.rateType || 'Fixed'],
                            [], // Empty row
                            ['Payment Date', 'Interest Rate (%)', 'Interest ($)', 'Principal ($)', 'Total Payment ($)', 'Remaining Balance ($)']
                        ];
                        
                        // Add payment schedule data
                        loanPayments.forEach(payment => {
                            summaryData.push([
                                payment.dueDate,
                                loan.interestRate.toFixed(2),
                                this.formatCurrency(payment.interest),
                                this.formatCurrency(payment.principal),
                                this.formatCurrency(payment.amount),
                                this.formatCurrency(payment.balance)
                            ]);
                        });
                        
                        const worksheet = XLSX.utils.aoa_to_sheet(summaryData);
                        
                        // Style the header
                        const range = XLSX.utils.decode_range(worksheet['!ref']);
                        for (let R = 0; R <= 7; R++) {
                            for (let C = 0; C <= 1; C++) {
                                const cell_address = XLSX.utils.encode_cell({c: C, r: R});
                                if (!worksheet[cell_address]) continue;
                                worksheet[cell_address].s = {
                                    font: { bold: true },
                                    fill: { fgColor: { rgb: "D8F3DC" } }
                                };
                            }
                        }
                        
                        const sheetName = `Loan_${loan.id}_${loan.borrowerName.replace(/[^a-zA-Z0-9]/g, '_')}`.substring(0, 31);
                        XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                    });
                    
                    XLSX.writeFile(workbook, `Lindan_Equities_Loan_Schedules_${new Date().toISOString().split('T')[0]}.xlsx`);
                    this.showNotification('Loan schedules exported to Excel successfully!', 'success');
                } catch (error) {
                    console.error('Export error:', error);
                    this.showNotification('Error exporting loan schedules: ' + error.message, 'error');
                }
            }

            // Export annual statements (PDF with logo and professional format)
            exportAnnualStatements() {
                try {
                    if (typeof jsPDF === 'undefined') {
                        this.showNotification('PDF library not loaded. Please refresh the page.', 'error');
                        return;
                    }
                    
                    const startDate = document.getElementById('statementStartDate')?.value || '2024-01-01';
                    const endDate = document.getElementById('statementEndDate')?.value || '2024-12-31';
                    
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    
                    this.loans.forEach((loan, index) => {
                        if (index > 0) pdf.addPage();
                        
                        // Header with logo space
                        pdf.setFontSize(20);
                        pdf.setTextColor(45, 106, 79); // Money green
                        pdf.text('LINDAN EQUITIES', 105, 30, { align: 'center' });
                        
                        pdf.setFontSize(16);
                        pdf.setTextColor(0, 0, 0);
                        pdf.text('Annual Mortgage Statement', 105, 45, { align: 'center' });
                        
                        pdf.setFontSize(12);
                        pdf.text(`Statement Period: ${startDate} to ${endDate}`, 105, 55, { align: 'center' });
                        
                        // Draw line
                        pdf.setDrawColor(45, 106, 79);
                        pdf.line(20, 65, 190, 65);
                        
                        // Borrower and loan information
                        let yPos = 80;
                        pdf.setFontSize(14);
                        pdf.setTextColor(45, 106, 79);
                        pdf.text('Borrower Information', 20, yPos);
                        
                        yPos += 15;
                        pdf.setFontSize(11);
                        pdf.setTextColor(0, 0, 0);
                        pdf.text(`Name: ${loan.borrowerName}`, 20, yPos);
                        yPos += 8;
                        if (loan.borrowerEmail) {
                            pdf.text(`Email: ${loan.borrowerEmail}`, 20, yPos);
                            yPos += 8;
                        }
                        pdf.text(`Loan ID: ${loan.id}`, 20, yPos);
                        
                        yPos += 20;
                        pdf.setFontSize(14);
                        pdf.setTextColor(45, 106, 79);
                        pdf.text('Loan Details', 20, yPos);
                        
                        yPos += 15;
                        pdf.setFontSize(11);
                        pdf.setTextColor(0, 0, 0);
                        pdf.text(`Original Amount: $${this.formatCurrency(loan.originalAmount)}`, 20, yPos);
                        pdf.text(`Current Balance: $${this.formatCurrency(loan.currentBalance)}`, 110, yPos);
                        yPos += 8;
                        pdf.text(`Interest Rate: ${loan.interestRate.toFixed(2)}%`, 20, yPos);
                        pdf.text(`Monthly Payment: $${this.formatCurrency(loan.monthlyPayment)}`, 110, yPos);
                        yPos += 8;
                        pdf.text(`Term: ${loan.termMonths} months`, 20, yPos);
                        pdf.text(`Rate Type: ${loan.rateType || 'Fixed'}`, 110, yPos);
                        
                        // Payment summary for the period
                        const loanPayments = this.payments.filter(p => 
                            p.loanId === loan.id && 
                            p.status === 'paid' &&
                            new Date(p.paidDate || p.dueDate) >= new Date(startDate) &&
                            new Date(p.paidDate || p.dueDate) <= new Date(endDate)
                        );
                        
                        const totalPaid = loanPayments.reduce((sum, p) => sum + (p.paidAmount || p.amount), 0);
                        const totalPrincipal = loanPayments.reduce((sum, p) => sum + p.principal, 0);
                        const totalInterest = loanPayments.reduce((sum, p) => sum + p.interest, 0);
                        
                        yPos += 20;
                        pdf.setFontSize(14);
                        pdf.setTextColor(45, 106, 79);
                        pdf.text('Payment Summary for Period', 20, yPos);
                        
                        yPos += 15;
                        pdf.setFontSize(11);
                        pdf.setTextColor(0, 0, 0);
                        pdf.text(`Total Payments Made: $${this.formatCurrency(totalPaid)}`, 20, yPos);
                        yPos += 8;
                        pdf.text(`Principal Paid: $${this.formatCurrency(totalPrincipal)}`, 20, yPos);
                        yPos += 8;
                        pdf.text(`Interest Paid: $${this.formatCurrency(totalInterest)}`, 20, yPos);
                        yPos += 8;
                        pdf.text(`Number of Payments: ${loanPayments.length}`, 20, yPos);
                        
                        // Payment details table (if space allows)
                        if (loanPayments.length > 0 && yPos < 200) {
                            yPos += 20;
                            pdf.setFontSize(12);
                            pdf.setTextColor(45, 106, 79);
                            pdf.text('Payment Details', 20, yPos);
                            
                            yPos += 10;
                            pdf.setFontSize(9);
                            pdf.setTextColor(0, 0, 0);
                            pdf.text('Date', 20, yPos);
                            pdf.text('Payment', 60, yPos);
                            pdf.text('Principal', 100, yPos);
                            pdf.text('Interest', 140, yPos);
                            pdf.text('Balance', 180, yPos);
                            
                            yPos += 5;
                            pdf.line(20, yPos, 190, yPos);
                            
                            loanPayments.slice(0, 15).forEach(payment => {
                                yPos += 8;
                                if (yPos > 270) return; // Prevent overflow
                                
                                pdf.text(this.formatDate(payment.paidDate || payment.dueDate), 20, yPos);
                                pdf.text(`$${this.formatCurrency(payment.paidAmount || payment.amount)}`, 60, yPos);
                                pdf.text(`$${this.formatCurrency(payment.principal)}`, 100, yPos);
                                pdf.text(`$${this.formatCurrency(payment.interest)}`, 140, yPos);
                                pdf.text(`$${this.formatCurrency(payment.balance)}`, 180, yPos);
                            });
                        }
                        
                        // Footer
                        pdf.setFontSize(8);
                        pdf.setTextColor(128, 128, 128);
                        pdf.text('This statement is generated by Lindan Equities Professional Banking System', 105, 280, { align: 'center' });
                        pdf.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 285, { align: 'center' });
                    });
                    
                    pdf.save(`Lindan_Equities_Annual_Statements_${startDate}_to_${endDate}.pdf`);
                    this.showNotification('Annual statements exported successfully!', 'success');
                } catch (error) {
                    console.error('PDF export error:', error);
                    this.showNotification('Error exporting annual statements: ' + error.message, 'error');
                }
            }

            generateAnnualStatement() {
                this.exportAnnualStatements();
            }

            // Other placeholder export methods
            exportPaymentScheduleToExcel() {
                this.showNotification('Payment schedule export functionality ready for implementation', 'info');
            }

            exportLoanPerformanceReport() {
                this.showNotification('Loan performance report export ready for implementation', 'info');
            }

            exportPropertiesToExcel() {
                this.showNotification('Properties export functionality ready for implementation', 'info');
            }

            exportTenantsToExcel() {
                this.showNotification('Tenants export functionality ready for implementation', 'info');
            }

            exportRentRollReport() {
                this.showNotification('Rent roll report export ready for implementation', 'info');
            }

            exportPropertyPLStatements() {
                this.showNotification('Property P&L statements export ready for implementation', 'info');
            }

            // PLACEHOLDER METHODS FOR USER MANAGEMENT
            showAddUserModal() {
                this.showNotification('Add user functionality ready for implementation', 'info');
            }

            editUser(userId) {
                this.showNotification(`Edit user ${userId} functionality ready for implementation`, 'info');
            }

            deleteUser(userId) {
                this.showNotification(`Delete user ${userId} functionality ready for implementation`, 'info');
            }

            // PLACEHOLDER METHODS FOR OTHER VIEWS
            renderPropertiesView() {
                this.showNotification('Properties view ready for implementation', 'info');
            }

            renderTenantsView() {
                this.showNotification('Tenants view ready for implementation', 'info');
            }

            // PLACEHOLDER METHODS
            showAddLoanModal() {
                this.showNotification('Add loan modal ready for implementation', 'info');
            }

            editLoan(loanId) {
                this.showNotification(`Edit loan ${loanId} functionality ready for implementation`, 'info');
            }

            deleteLoan(loanId) {
                if (confirm('Delete this loan?')) {
                    this.loans = this.loans.filter(l => l.id !== loanId);
                    this.payments = this.payments.filter(p => p.loanId !== loanId);
                    this.saveData('loans', this.loans);
                    this.saveData('payments', this.payments);
                    this.renderLoansView();
                    this.showNotification('Loan deleted successfully', 'success');
                }
            }

            closeModal() {
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) modalContainer.innerHTML = '';
            }

            populateFilters() {
                const loanFilter = document.getElementById('loanFilter');
                if (!loanFilter) return;
                
                loanFilter.innerHTML = '<option value="all">All Loans</option>';
                this.loans.forEach(loan => {
                    const option = document.createElement('option');
                    option.value = loan.id;
                    option.textContent = loan.borrowerName;
                    loanFilter.appendChild(option);
                });
            }

            generatePaymentSchedules() {
                this.payments = [];
                this.loans.forEach(loan => {
                    this.generatePaymentScheduleForLoan(loan.id);
                });
                this.saveData('payments', this.payments);
            }

            // DEFAULT DATA
            getDefaultLoans() {
                return [
                    {
                        id: 1,
                        borrowerName: "Smith Construction Ltd",
                        borrowerEmail: "contact@smithconstruction.com",
                        originalAmount: 150000,
                        currentBalance: 142000,
                        interestRate: 6.5,
                        termMonths: 60,
                        paymentType: "blended",
                        monthlyPayment: 2934.38,
                        startDate: "2024-01-15",
                        paymentDay: 15,
                        status: 'active',
                        rateType: 'fixed'
                    },
                    {
                        id: 2,
                        borrowerName: "Johnson Development Corp",
                        borrowerEmail: "finance@johnsondevelopment.com",
                        originalAmount: 75000,
                        currentBalance: 75000,
                        interestRate: 7.5,
                        termMonths: 36,
                        paymentType: "interest_only",
                        monthlyPayment: 468.75,
                        startDate: "2024-03-01",
                        paymentDay: 1,
                        status: 'active',
                        rateType: 'variable',
                        spread: 2.0
                    }
                ];
            }

            getDefaultProperties() {
                return [
                    {
                        id: 1,
                        name: "Downtown Commercial Complex",
                        address: "250 Business District Ave",
                        type: "Commercial",
                        units: 8,
                        value: 1800000,
                        monthlyRent: 16000,
                        status: 'active'
                    },
                    {
                        id: 2,
                        name: "Riverside Residential Tower",
                        address: "789 Waterfront Drive",
                        type: "Residential",
                        units: 32,
                        value: 1200000,
                        monthlyRent: 28000,
                        status: 'active'
                    }
                ];
            }

            getDefaultTenants() {
                return [
                    {
                        id: 1,
                        name: "Professional Services Group",
                        email: "admin@proservicesgroup.com",
                        propertyId: 1,
                        unitNumber: "Suite 402",
                        monthlyRent: 5500,
                        rentDueDay: 1,
                        leaseStart: "2024-09-01",
                        leaseEnd: "2025-08-31",
                        status: 'active'
                    }
                ];
            }

            getDefaultUsers() {
                return [
                    {
                        id: 1,
                        username: "admin",
                        password: "admin123",
                        firstName: "Admin",
                        lastName: "User",
                        email: "admin@lindanequities.com",
                        role: "admin",
                        status: "active",
                        lastLogin: new Date().toISOString(),
                        permissions: ["all"]
                    },
                    {
                        id: 2,
                        username: "manager",
                        password: "manager123",
                        firstName: "Manager",
                        lastName: "User",
                        email: "manager@lindanequities.com",
                        role: "manager",
                        status: "active",
                        lastLogin: null,
                        permissions: ["loans", "reports", "properties"]
                    },
                    {
                        id: 3,
                        username: "user",
                        password: "user123",
                        firstName: "Standard",
                        lastName: "User",
                        email: "user@lindanequities.com",
                        role: "user",
                        status: "active",
                        lastLogin: null,
                        permissions: ["loans"]
                    }
                ];
            }

            getDefaultPrimeHistory() {
                return [
                    {
                        id: 1,
                        rate: 5.50,
                        effectiveDate: "2024-09-01",
                        previousRate: 5.25,
                        notes: "Federal Reserve adjustment",
                        updatedAt: "2024-09-01T09:00:00.000Z",
                        updatedBy: "system"
                    }
                ];
            }

            // UTILITY METHODS
            loadData(key) {
                try {
                    const data = localStorage.getItem(`businessSystem_${key}`);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error(`Error loading ${key}:`, error);
                    return null;
                }
            }

            saveData(key, data) {
                try {
                    localStorage.setItem(`businessSystem_${key}`, JSON.stringify(data));
                } catch (error) {
                    console.error(`Error saving ${key}:`, error);
                }
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount || 0);
            }

            formatDate(date) {
                if (!date) return 'N/A';
                if (typeof date === 'string') date = new Date(date);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            }

            formatDateTime(dateTime) {
                if (!dateTime) return 'N/A';
                const date = new Date(dateTime);
                return date.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            showNotification(message, type = 'success') {
                const container = document.getElementById('notificationContainer');
                if (!container) return;
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="background: none; border: none; color: inherit; font-size: 1.2rem; cursor: pointer; margin-left: 1rem; padding: 0.25rem;">
                            &times;
                        </button>
                    </div>
                `;
                
                container.appendChild(notification);
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }
        }
        
        // Initialize the Professional Banking System
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded - initializing Professional Banking System');
            window.businessSystem = new ProfessionalBankingSystem();
        });
        
        // Backup initialization
        if (document.readyState === 'loading') {
            console.log('DOM is loading...');
        } else {
            console.log('DOM already ready - initializing immediately');
            window.businessSystem = new ProfessionalBankingSystem();
        }
    </script>
</body>
</html>
