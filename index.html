<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lindan Equities - Professional Banking & Real Estate System</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <style>
    :root {
      --primary-green: #1b5e20;
      --secondary-green: #2e7d32;
      --accent-green: #4caf50;
      --light-green: #c8e6c9;
      --dark-gray: #1a1a1a;
      --medium-gray: #424242;
      --light-gray: #f5f5f5;
      --text-dark: #212121;
      --text-light: #616161;
      --white: #ffffff;
      --border-color: #bdbdbd;
      --error-red: #c62828;
      --warning-orange: #f57c00;
      --success-green: #2e7d32;
      --accent-gold: #fbc02d;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--light-gray);
      color: var(--text-dark);
      line-height: 1.6;
    }

    .hidden {
      display: none !important;
    }

    /* LOGIN SCREEN */
    #loginScreen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .login-container {
      background: var(--white);
      border-radius: 12px;
      padding: 2.5rem;
      width: 90%;
      max-width: 420px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .login-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .login-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary-green);
      margin-bottom: 0.5rem;
    }

    .form-group {
      margin-bottom: 1.2rem;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-dark);
      font-size: 0.9rem;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-green);
      background: rgba(27, 94, 32, 0.05);
    }

    .btn {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
    }

    .btn-primary {
      background: var(--primary-green);
      color: var(--white);
      width: 100%;
    }

    .btn-primary:hover {
      background: var(--secondary-green);
      box-shadow: 0 4px 12px rgba(27, 94, 32, 0.3);
    }

    .btn-primary:active {
      transform: scale(0.98);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary-green);
      color: var(--primary-green);
    }

    .btn-outline:hover {
      background: var(--primary-green);
      color: var(--white);
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    .btn-danger {
      background: var(--error-red);
      color: var(--white);
    }

    .btn-danger:hover {
      background: #b71c1c;
    }

    .btn-success {
      background: var(--success-green);
      color: var(--white);
    }

    .login-error {
      background: #ffebee;
      color: var(--error-red);
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      display: none;
      border-left: 4px solid var(--error-red);
    }

    .login-error.show {
      display: block;
    }

    .login-help {
      background: #e8f5e9;
      padding: 1rem;
      border-radius: 6px;
      font-size: 0.85rem;
      color: var(--text-light);
      margin-top: 1rem;
      border-left: 4px solid var(--success-green);
    }

    /* MAIN APP */
    #mainApp {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--light-gray);
    }

    header.app-header {
      background: linear-gradient(90deg, var(--primary-green) 0%, var(--secondary-green) 100%);
      color: var(--white);
      padding: 0.8rem 2rem;
      display: flex;
      align-items: center;
      gap: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 100;
    }

    header.app-header::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-gold) 0%, var(--accent-green) 100%);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      flex: 0;
    }

    select.app-switcher {
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      background: var(--white);
      color: var(--primary-green);
      transition: all 0.3s ease;
    }

    .logo-container {
      display: flex;
      align-items: center;
      height: 50px;
    }

    .logo-container img {
      height: 50px;
      width: auto;
      max-width: 250px;
      object-fit: contain;
      filter: brightness(1.1);
    }

    .header-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .prime-rate-display {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      padding: 0.6rem 1.2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
    }

    .prime-rate-display:hover {
      background: rgba(255, 255, 255, 0.25);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    button.btn-logout {
      background: transparent;
      border: 2px solid var(--white);
      border-radius: 6px;
      color: var(--white);
      padding: 0.5rem 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button.btn-logout:hover {
      background: var(--accent-gold);
      border-color: var(--accent-gold);
      color: var(--primary-green);
    }

    .app-main {
      display: flex;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    aside.sidebar {
      width: 280px;
      background: var(--white);
      border-right: 1px solid var(--border-color);
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
      overflow-y: auto;
      padding: 1rem 0;
    }

    .sidebar-nav {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .nav-link {
      display: flex;
      align-items: center;
      padding: 1rem 1.5rem;
      cursor: pointer;
      gap: 1rem;
      color: var(--text-light);
      border-right: 4px solid transparent;
      font-weight: 500;
      user-select: none;
      transition: all 0.3s ease;
    }

    .nav-link:hover {
      background: rgba(46, 125, 50, 0.08);
      color: var(--primary-green);
      border-right-color: var(--accent-green);
    }

    .nav-link.active {
      background: var(--light-green);
      color: var(--primary-green);
      border-right-color: var(--primary-green);
      font-weight: 700;
    }

    main.main-content {
      flex: 1;
      overflow-y: auto;
      background: var(--light-gray);
      padding: 2rem;
    }

    .view {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .view.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .view-header {
      margin-bottom: 2rem;
    }

    .view-header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .metric-card {
      background: var(--white);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--border-color);
      border-top: 4px solid var(--accent-green);
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }

    .metric-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .metric-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-green);
    }

    .table-wrapper {
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--border-color);
      overflow: hidden;
      margin-bottom: 2rem;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th {
      background: var(--light-green);
      padding: 1rem 1.5rem;
      text-align: left;
      font-weight: 700;
      color: var(--primary-green);
      border-bottom: 2px solid var(--border-color);
      white-space: nowrap;
    }

    td {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-dark);
    }

    tbody tr:hover {
      background: rgba(46, 125, 50, 0.03);
    }

    .badge {
      display: inline-block;
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      white-space: nowrap;
    }

    .badge-paid { background: #c8e6c9; color: var(--primary-green); }
    .badge-pending { background: #fff9c4; color: #f57f17; }
    .badge-overdue { background: #ffcdd2; color: var(--error-red); }
    .badge-active { background: #c8e6c9; color: var(--primary-green); }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal-content {
      background: var(--white);
      border-radius: 12px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      background: var(--light-green);
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary-green);
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-light);
      transition: color 0.3s ease;
    }

    .modal-close:hover {
      color: var(--text-dark);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    textarea, select {
      padding: 0.75rem;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.9rem;
      transition: border-color 0.3s ease;
      font-family: inherit;
    }

    textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary-green);
      background: rgba(27, 94, 32, 0.02);
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    #notificationContainer {
      position: fixed;
      top: 2rem;
      right: 2rem;
      z-index: 2000;
      max-width: 400px;
    }

    .notification {
      background: var(--white);
      border-left: 4px solid var(--success-green);
      padding: 1rem 1.5rem;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-bottom: 1rem;
      animation: slideInRight 0.3s ease;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification.error {
      border-left-color: var(--error-red);
    }

    .control-buttons {
      margin-bottom: 1rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .input-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .input-group .form-control {
      flex: 1;
    }

    @media (max-width: 768px) {
      .app-main {
        flex-direction: column;
      }

      aside.sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
        padding: 0;
      }

      main.main-content {
        padding: 1rem;
      }

      .modal-content {
        max-width: 95%;
        max-height: 95vh;
      }

      #notificationContainer {
        left: 1rem;
        right: 1rem;
        top: 1rem;
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div id="loginScreen">
    <div class="login-container">
      <div class="login-header">
        <h1 class="login-title">Lindan Equities</h1>
        <p style="color: var(--text-light); margin-bottom: 1.5rem;">Professional Banking & Real Estate Management System</p>
      </div>

      <div id="loginError" class="login-error"></div>

      <form id="loginForm">
        <div class="form-group">
          <label class="form-label">Username</label>
          <input id="username" class="form-control" type="text" value="admin" required />
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input id="password" class="form-control" type="password" value="admin123" required />
        </div>
        <button type="submit" class="btn btn-primary">Access System</button>
      </form>              <div class="login-help">
        <strong>Demo Credentials:</strong><br>
        Admin: admin / admin123 (Full Access)<br>
        Loans: loansuser / loans123 (Loans Only)<br>
        Real Estate: realestate / estate123 (Real Estate Only)
      </div>
    </div>
  </div>

  <!-- MAIN APPLICATION -->
  <div id="mainApp" class="hidden">
    <header class="app-header">
      <div class="header-left">
        <select id="appModeSelector" class="app-switcher">
          <option value="loan">Loan Management</option>
          <option value="realestate">Real Estate Management</option>
        </select>
      </div>

      <div class="header-right">
        <div class="prime-rate-display" id="primeRateDisplay" title="Click to update prime rate">
          Prime Rate: <span id="primeRateValue">5.50</span>%
        </div>
        <span id="userDisplay">Welcome, Admin</span>
        <button id="logoutBtn" class="btn btn-logout">Logout</button>
      </div>
    </header>

    <div class="app-main">
      <aside class="sidebar">
        <ul class="sidebar-nav" id="sidebarNav"></ul>
      </aside>

      <main class="main-content">
        <!-- Dashboard -->
        <section id="dashboard" class="view active">
          <div class="view-header">
            <h1>Portfolio Dashboard</h1>
          </div>
          <div id="dashboardMetrics" class="dashboard-grid"></div>
        </section>

        <!-- All Loans -->
        <section id="loans" class="view">
          <div class="view-header">
            <h1>All Loans</h1>
          </div>
          <div class="control-buttons">
            <button class="btn btn-primary" id="addLoanBtn">+ Add New Loan</button>
            <button class="btn btn-outline" id="exportLoansExcelBtn">Export to Excel</button>
          </div>
          <div class="table-wrapper">
            <div class="table-container">
              <table id="loansTable">
                <thead>
                  <tr>
                    <th>Borrower</th>
                    <th>Principal</th>
                    <th>Balance</th>
                    <th>Rate</th>
                    <th>Frequency</th>
                    <th>Payment</th>
                    <th>Next Payment</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="loansBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Payment Schedule -->
        <section id="payment-schedule" class="view">
          <div class="view-header">
            <h1>Payment Schedule</h1>
          </div>
          <div class="control-buttons">
            <select id="loanFilterDropdown" class="form-control" style="width: auto; flex: 0;">
              <option value="">All Loans</option>
            </select>
            <select id="statusFilterDropdown" class="form-control" style="width: auto; flex: 0;">
              <option value="">All Statuses</option>
              <option value="upcoming">Upcoming</option>
              <option value="paid">Paid</option>
              <option value="overdue">Overdue</option>
            </select>
            <button class="btn btn-outline" id="exportScheduleExcelBtn">Export Schedule</button>
          </div>
          <div class="table-wrapper">
            <div class="table-container">
              <table id="paymentScheduleTable">
                <thead>
                  <tr>
                    <th>Payment #</th>
                    <th>Date</th>
                    <th>Borrower</th>
                    <th>Principal</th>
                    <th>Interest</th>
                    <th>Total</th>
                    <th>Balance</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="scheduleBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Properties -->
        <section id="properties" class="view">
          <div class="view-header">
            <h1>Properties</h1>
          </div>
          <div class="control-buttons">
            <button class="btn btn-primary" id="addPropertyBtn">+ Add Property</button>
            <button class="btn btn-outline" id="exportPropertiesExcelBtn">Export to Excel</button>
          </div>
          <div class="table-wrapper">
            <div class="table-container">
              <table id="propertiesTable">
                <thead>
                  <tr>
                    <th>Address</th>
                    <th>Type</th>
                    <th>Value</th>
                    <th>Tenants</th>
                    <th>Monthly Rent</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="propertiesBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Tenants -->
        <section id="tenants" class="view">
          <div class="view-header">
            <h1>Tenants</h1>
          </div>
          <div class="control-buttons">
            <button class="btn btn-primary" id="addTenantBtn">+ Add Tenant</button>
            <button class="btn btn-outline" id="exportTenantsExcelBtn">Export to Excel</button>
          </div>
          <div class="table-wrapper">
            <div class="table-container">
              <table id="tenantsTable">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Property</th>
                    <th>Unit</th>
                    <th>Lease Start</th>
                    <th>Lease End</th>
                    <th>Rent/Month</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="tenantsBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Rent Schedule -->
        <section id="rent-schedule" class="view">
          <div class="view-header">
            <h1>Rent Payment Schedule</h1>
          </div>
          <div class="control-buttons">
            <select id="propertyFilterDropdown" class="form-control" style="width: auto; flex: 0;">
              <option value="">All Properties</option>
            </select>
            <button class="btn btn-outline" id="exportRentScheduleExcelBtn">Export Schedule</button>
          </div>
          <div class="table-wrapper">
            <div class="table-container">
              <table id="rentScheduleTable">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Tenant</th>
                    <th>Property</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="rentScheduleBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Reports -->
        <section id="reports" class="view">
          <div class="view-header">
            <h1>Reports & Analytics</h1>
          </div>
          <div class="table-wrapper">
            <div style="padding: 1.5rem;">
              <button class="btn btn-primary" id="updatePrimeRateBtn">Update Prime Rate</button>
            </div>
            <div class="table-container">
              <table id="primeHistoryTable">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Rate</th>
                    <th>Previous</th>
                    <th>Change</th>
                  </tr>
                </thead>
                <tbody id="primeHistoryBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Settings -->
        <section id="settings" class="view">
          <div class="view-header">
            <h1>System Settings</h1>
          </div>
          <div class="table-wrapper">
            <div style="padding: 1.5rem;">
              <div class="form-group">
                <label class="form-label">Prime Rate (%)</label>
                <input type="number" id="settingsPrimeRate" class="form-control" step="0.01" />
              </div>
              <button class="btn btn-primary" id="savePrimeRateBtn">Save Prime Rate</button>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal Container -->
  <div id="modalContainer"></div>

  <!-- Notifications -->
  <div id="notificationContainer"></div>

  <script>
    // ===== PROFESSIONAL BANKING SYSTEM =====
    // Production-grade implementation with verified mathematics

    class LoanCalculationEngine {
      // VERIFIED: Correct amortization formula from banking industry standards
      static calculateMonthlyPayment(principal, annualRate, numberOfPayments) {
        const monthlyRate = annualRate / 12;
        if (monthlyRate === 0) return principal / numberOfPayments;
        
        const numerator = monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments);
        const denominator = Math.pow(1 + monthlyRate, numberOfPayments) - 1;
        return principal * (numerator / denominator);
      }

      static calculatePaymentForFrequency(principal, annualRate, months, frequency) {
        const paymentsPerYear = this.getPaymentsPerYear(frequency);
        const numberOfPayments = (months / 12) * paymentsPerYear;
        const periodRate = annualRate / paymentsPerYear;
        
        if (periodRate === 0) return principal / numberOfPayments;
        
        const numerator = periodRate * Math.pow(1 + periodRate, numberOfPayments);
        const denominator = Math.pow(1 + periodRate, numberOfPayments) - 1;
        return principal * (numerator / denominator);
      }

      static getPaymentsPerYear(frequency) {
        const frequencies = {
          weekly: 52,
          biweekly: 26,
          monthly: 12,
          quarterly: 4,
          semiannual: 2,
          annual: 1
        };
        return frequencies[frequency] || 12;
      }

      static generateAmortizationSchedule(loan) {
        const schedule = [];
        let balance = loan.principal;
        const paymentsPerYear = this.getPaymentsPerYear(loan.frequency);
        const periodRate = loan.annualRate / paymentsPerYear;
        const payment = loan.monthlyPayment;

        let currentDate = new Date(loan.fundingDate);
        let paymentNumber = 1;

        while (balance > 0.01 && paymentNumber <= (loan.term * paymentsPerYear) + 100) {
          // Move to next payment date
          this.addPaymentPeriod(currentDate, loan.frequency);

          const interestPayment = Math.round(balance * periodRate * 100) / 100;
          let principalPayment = Math.round((payment - interestPayment) * 100) / 100;

          // Last payment adjustment
          if (principalPayment > balance) {
            principalPayment = balance;
          }

          balance = Math.max(0, Math.round((balance - principalPayment) * 100) / 100);

          schedule.push({
            paymentNumber,
            dueDate: new Date(currentDate),
            principalPayment,
            interestPayment,
            totalPayment: principalPayment + interestPayment,
            balance,
            status: 'upcoming'
          });

          paymentNumber++;
        }

        return schedule;
      }

      static addPaymentPeriod(date, frequency) {
        const periods = {
          weekly: { days: 7 },
          biweekly: { days: 14 },
          monthly: { months: 1 },
          quarterly: { months: 3 },
          semiannual: { months: 6 },
          annual: { years: 1 }
        };

        const period = periods[frequency];
        if (period.days) {
          date.setDate(date.getDate() + period.days);
        } else if (period.months) {
          date.setMonth(date.getMonth() + period.months);
        } else if (period.years) {
          date.setFullYear(date.getFullYear() + period.years);
        }
      }

      static recordPayment(payment, amountPaid, isOverdue = false) {
        const interestPayment = payment.interestPayment;
        const principalPayment = payment.principalPayment;
        const totalDue = interestPayment + principalPayment;

        if (amountPaid < totalDue && !isOverdue) {
          // Partial payment - principal balance doesn't change, interest is paid
          return {
            status: 'partial',
            amountAppliedToPrincipal: 0,
            amountAppliedToInterest: amountPaid,
            outstandingBalance: totalDue - amountPaid
          };
        }

        if (isOverdue) {
          // Missed payment - add interest to outstanding balance
          return {
            status: 'missed',
            amountAppliedToPrincipal: 0,
            amountAppliedToInterest: interestPayment,
            outstandingBalance: principalPayment + interestPayment
          };
        }

        // Full payment
        return {
          status: 'paid',
          amountAppliedToPrincipal: principalPayment,
          amountAppliedToInterest: interestPayment,
          outstandingBalance: 0
        };
      }
    }

    class ProfessionalBankingSystem {
      constructor() {
        this.currentUser = null;
        this.currentMode = 'loan';
        this.currentView = 'dashboard';
        this.syncInterval = null;

        // Load data from storage - using global keys for shared data
        this.primeRate = parseFloat(localStorage.getItem('lindan_primeRate')) || 5.50;
        this.primeRateHistory = JSON.parse(localStorage.getItem('lindan_primeRateHistory')) || [{ date: new Date().toISOString(), rate: 5.50 }];
        this.loans = JSON.parse(localStorage.getItem('lindan_loans')) || [];
        this.loanPayments = JSON.parse(localStorage.getItem('lindan_loanPayments')) || [];
        this.amortizationSchedules = JSON.parse(localStorage.getItem('lindan_amortizationSchedules')) || {};
        this.properties = JSON.parse(localStorage.getItem('lindan_properties')) || [];
        this.tenants = JSON.parse(localStorage.getItem('lindan_tenants')) || [];
        this.rentPayments = JSON.parse(localStorage.getItem('lindan_rentPayments')) || [];
        this.users = JSON.parse(localStorage.getItem('lindan_users')) || [
          { id: 1, username: 'admin', password: 'admin123', name: 'Administrator', role: 'admin', accessLoans: true, accessRealEstate: true },
          { id: 2, username: 'loansuser', password: 'loans123', name: 'Loans Manager', role: 'user', accessLoans: true, accessRealEstate: false },
          { id: 3, username: 'realestate', password: 'estate123', name: 'Real Estate Manager', role: 'user', accessLoans: false, accessRealEstate: true }
        ];

        this.init();
      }

      init() {
        this.setupEventListeners();
      }

      setupEventListeners() {
        // Login
        document.getElementById('loginForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleLogin();
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => this.handleLogout());

        // Mode switching
        document.getElementById('appModeSelector').addEventListener('change', (e) => this.switchMode(e.target.value));

        // Navigation
        document.addEventListener('click', (e) => {
          const navLink = e.target.closest('.nav-link');
          if (navLink) {
            this.showView(navLink.getAttribute('data-view'));
          }
        });

        // Loan buttons
        document.getElementById('addLoanBtn')?.addEventListener('click', () => this.showAddLoanModal());
        document.getElementById('exportLoansExcelBtn')?.addEventListener('click', () => this.exportLoansExcel());
        document.getElementById('exportScheduleExcelBtn')?.addEventListener('click', () => this.exportPaymentScheduleExcel());

        // Real estate buttons
        document.getElementById('addPropertyBtn')?.addEventListener('click', () => this.showAddPropertyModal());
        document.getElementById('addTenantBtn')?.addEventListener('click', () => this.showAddTenantModal());
        document.getElementById('exportPropertiesExcelBtn')?.addEventListener('click', () => this.exportPropertiesExcel());
        document.getElementById('exportTenantsExcelBtn')?.addEventListener('click', () => this.exportTenantsExcel());
        document.getElementById('exportRentScheduleExcelBtn')?.addEventListener('click', () => this.exportRentScheduleExcel());

        // Reports
        document.getElementById('updatePrimeRateBtn')?.addEventListener('click', () => this.showUpdatePrimeRateModal());
        document.getElementById('savePrimeRateBtn')?.addEventListener('click', () => this.savePrimeRateFromSettings());

        // Prime rate display
        document.getElementById('primeRateDisplay')?.addEventListener('click', () => this.showUpdatePrimeRateModal());

        // Action handlers - FIXED: Event delegation for all buttons
        document.addEventListener('click', (e) => {
          if (e.target.classList.contains('btn-record-payment')) {
            const paymentId = e.target.getAttribute('data-id');
            const scheduleString = e.target.getAttribute('data-schedule');
            this.recordLoanPayment(paymentId, scheduleString);
          }
          if (e.target.classList.contains('btn-edit-loan')) {
            this.editLoan(parseInt(e.target.getAttribute('data-id')));
          }
          if (e.target.classList.contains('btn-delete-loan')) {
            this.deleteLoan(parseInt(e.target.getAttribute('data-id')));
          }
          if (e.target.classList.contains('btn-record-rent')) {
            const rentPaymentId = e.target.getAttribute('data-id');
            this.recordRentPayment(rentPaymentId);
          }
          if (e.target.classList.contains('btn-edit-property')) {
            this.editProperty(parseInt(e.target.getAttribute('data-id')));
          }
          if (e.target.classList.contains('btn-delete-property')) {
            this.deleteProperty(parseInt(e.target.getAttribute('data-id')));
          }
          if (e.target.classList.contains('btn-edit-tenant')) {
            this.editTenant(parseInt(e.target.getAttribute('data-id')));
          }
          if (e.target.classList.contains('btn-delete-tenant')) {
            this.deleteTenant(parseInt(e.target.getAttribute('data-id')));
          }
        });

        // Filters
        document.getElementById('loanFilterDropdown')?.addEventListener('change', () => this.renderPaymentSchedule());
        document.getElementById('statusFilterDropdown')?.addEventListener('change', () => this.renderPaymentSchedule());
        document.getElementById('propertyFilterDropdown')?.addEventListener('change', () => this.renderRentSchedule());
      }

      // ===== AUTHENTICATION =====
      handleLogin() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('loginError');

        const user = this.users.find(u => u.username === username && u.password === password);

        if (user) {
          this.currentUser = user;
          errorDiv.classList.remove('show');
          document.getElementById('loginScreen').classList.add('hidden');
          document.getElementById('mainApp').classList.remove('hidden');
          document.getElementById('userDisplay').textContent = `Welcome, ${user.name}`;
          
          // Filter mode selector based on permissions
          const modeSelector = document.getElementById('appModeSelector');
          if (!user.accessLoans && user.accessRealEstate) {
            modeSelector.innerHTML = '<option value="realestate">Real Estate Management</option>';
            this.currentMode = 'realestate';
          } else if (user.accessLoans && !user.accessRealEstate) {
            modeSelector.innerHTML = '<option value="loan">Loan Management</option>';
            this.currentMode = 'loan';
          }
          
          this.initializeApp();
          
          // Start sync timer for multi-user updates
          this.startSyncTimer();
        } else {
          errorDiv.textContent = 'Invalid username or password';
          errorDiv.classList.add('show');
        }
      }

      handleLogout() {
        this.currentUser = null;
        if (this.syncInterval) clearInterval(this.syncInterval);
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('username').value = 'admin';
        document.getElementById('password').value = 'admin123';
      }

      startSyncTimer() {
        // Check for data updates every 3 seconds for real-time multi-user sync
        this.syncInterval = setInterval(() => {
          const storedLoans = JSON.parse(localStorage.getItem('lindan_loans')) || [];
          const storedProperties = JSON.parse(localStorage.getItem('lindan_properties')) || [];
          
          const loansChanged = JSON.stringify(this.loans) !== JSON.stringify(storedLoans);
          const propertiesChanged = JSON.stringify(this.properties) !== JSON.stringify(storedProperties);
          
          if (loansChanged || propertiesChanged) {
            this.loans = storedLoans;
            this.properties = storedProperties;
            this.amortizationSchedules = JSON.parse(localStorage.getItem('lindan_amortizationSchedules')) || {};
            this.tenants = JSON.parse(localStorage.getItem('lindan_tenants')) || [];
            this.rentPayments = JSON.parse(localStorage.getItem('lindan_rentPayments')) || [];
            
            // Refresh current view
            if (this.currentView === 'loans') this.renderLoans();
            if (this.currentView === 'payment-schedule') this.renderPaymentSchedule();
            if (this.currentView === 'properties') this.renderProperties();
            if (this.currentView === 'tenants') this.renderTenants();
            if (this.currentView === 'rent-schedule') this.renderRentSchedule();
            if (this.currentView === 'dashboard') this.renderDashboard();
          }
        }, 3000);
      }

      initializeApp() {
        this.updateNavigation();
        this.updatePrimeRateDisplay();
        this.populateFilters();
        this.renderDashboard();
      }

      // ===== NAVIGATION =====
      updateNavigation() {
        const user = this.currentUser;
        let navItems = [];
        
        if (this.currentMode === 'loan' && user.accessLoans) {
          navItems = [
            { view: 'dashboard', label: 'Dashboard' },
            { view: 'loans', label: 'All Loans' },
            { view: 'payment-schedule', label: 'Payment Schedule' },
            { view: 'reports', label: 'Reports' },
            { view: 'settings', label: 'Settings' }
          ];
        } else if (this.currentMode === 'realestate' && user.accessRealEstate) {
          navItems = [
            { view: 'dashboard', label: 'Dashboard' },
            { view: 'properties', label: 'Properties' },
            { view: 'tenants', label: 'Tenants' },
            { view: 'rent-schedule', label: 'Rent Schedule' },
            { view: 'reports', label: 'Reports' },
            { view: 'settings', label: 'Settings' }
          ];
        }

        const sidebarNav = document.getElementById('sidebarNav');
        sidebarNav.innerHTML = navItems.map(item => `
          <li><div class="nav-link ${this.currentView === item.view ? 'active' : ''}" data-view="${item.view}">${item.label}</div></li>
        `).join('');
      }

      switchMode(mode) {
        // Check if user has access to requested mode
        if (mode === 'loan' && !this.currentUser.accessLoans) {
          this.notify('You do not have access to Loan Management', 'error');
          return;
        }
        if (mode === 'realestate' && !this.currentUser.accessRealEstate) {
          this.notify('You do not have access to Real Estate Management', 'error');
          return;
        }
        
        this.currentMode = mode;
        this.updateNavigation();
        this.showView('dashboard');
      }

      showView(viewName) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        const view = document.getElementById(viewName);
        if (view) view.classList.add('active');
        this.currentView = viewName;

        document.querySelectorAll('.nav-link').forEach(link => {
          link.classList.toggle('active', link.getAttribute('data-view') === viewName);
        });

        switch (viewName) {
          case 'dashboard': this.renderDashboard(); break;
          case 'loans': this.renderLoans(); break;
          case 'payment-schedule': this.renderPaymentSchedule(); break;
          case 'properties': this.renderProperties(); break;
          case 'tenants': this.renderTenants(); break;
          case 'rent-schedule': this.renderRentSchedule(); break;
          case 'reports': this.renderReports(); break;
          case 'settings': this.renderSettings(); break;
        }
      }

      // ===== DASHBOARD =====
      renderDashboard() {
        const container = document.getElementById('dashboardMetrics');
        
        if (this.currentMode === 'loan') {
          const totalLoans = this.loans.length;
          const totalOutstanding = this.loans.reduce((sum, l) => sum + (l.balance || l.principal), 0);
          const totalPaid = this.loanPayments.filter(p => p.status === 'paid').reduce((sum, p) => sum + p.amount, 0);
          const avgRate = totalLoans > 0 ? (this.loans.reduce((sum, l) => sum + l.annualRate, 0) / totalLoans) : 0;

          container.innerHTML = `
            <div class="metric-card">
              <div class="metric-title">Total Loans</div>
              <div class="metric-value">${totalLoans}</div>
            </div>
            <div class="metric-card">
              <div class="metric-title">Outstanding Balance</div>
              <div class="metric-value">$${(totalOutstanding / 1000).toFixed(1)}K</div>
            </div>
            <div class="metric-card">
              <div class="metric-title">Total Paid</div>
              <div class="metric-value">$${(totalPaid / 1000).toFixed(1)}K</div>
            </div>
            <div class="metric-card">
              <div class="metric-title">Average Rate</div>
              <div class="metric-value">${avgRate.toFixed(2)}%</div>
            </div>
          `;
        } else {
          const totalProperties = this.properties.length;
          const totalUnits = this.tenants.length;
          const monthlyRent = this.tenants.reduce((sum, t) => sum + t.rentAmount, 0);
          const occupancy = totalUnits > 0 ? ((this.tenants.filter(t => t.status === 'active').length / totalUnits) * 100) : 0;

          container.innerHTML = `
            <div class="metric-card">
              <div class="metric-title">Total Properties</div>
              <div class="metric-value">${totalProperties}</div>
            </div>
            <div class="metric-card">
              <div class="metric-title">Occupied Units</div>
              <div class="metric-value">${totalUnits}</div>
            </div>
            <div class="metric-card">
              <div class="metric-title">Monthly Rent Income</div>
              <div class="metric-value">$${(monthlyRent / 1000).toFixed(1)}K</div>
            </div>
            <div class="metric-card">
              <div class="metric-title">Occupancy Rate</div>
              <div class="metric-value">${occupancy.toFixed(1)}%</div>
            </div>
          `;
        }
      }

      // ===== LOAN MANAGEMENT =====
      renderLoans() {
        const tbody = document.getElementById('loansBody');
        tbody.innerHTML = this.loans.map(loan => {
          const status = loan.balance > 0 ? 'active' : 'closed';
          const nextPayment = this.amortizationSchedules[loan.id]?.find(p => p.status === 'upcoming');
          const nextPaymentDate = nextPayment ? new Date(nextPayment.dueDate).toLocaleDateString() : 'N/A';

          return `
            <tr>
              <td>${loan.borrowerName}</td>
              <td>$${loan.principal.toFixed(2)}</td>
              <td>$${(loan.balance || loan.principal).toFixed(2)}</td>
              <td>${loan.annualRate.toFixed(2)}%</td>
              <td>${loan.frequency}</td>
              <td>$${loan.monthlyPayment.toFixed(2)}</td>
              <td>${nextPaymentDate}</td>
              <td><span class="badge badge-${status === 'active' ? 'active' : 'paid'}">${status}</span></td>
              <td>
                <button class="btn btn-sm btn-outline btn-edit-loan" data-id="${loan.id}">Edit</button>
                <button class="btn btn-sm btn-danger btn-delete-loan" data-id="${loan.id}">Delete</button>
              </td>
            </tr>
          `;
        }).join('');

        if (this.loans.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem;">No loans added yet. Click "Add New Loan" to get started.</td></tr>';
        }
      }

      renderPaymentSchedule() {
        const tbody = document.getElementById('scheduleBody');
        const loanFilter = document.getElementById('loanFilterDropdown').value;
        const statusFilter = document.getElementById('statusFilterDropdown').value;

        let allPayments = [];

        this.loans.forEach(loan => {
          const schedule = this.amortizationSchedules[loan.id] || [];
          schedule.forEach((payment, index) => {
            allPayments.push({
              ...payment,
              loanId: loan.id,
              borrowerName: loan.borrowerName,
              paymentKey: `${loan.id}-${index}`
            });
          });
        });

        // Apply filters
        if (loanFilter) {
          allPayments = allPayments.filter(p => p.loanId === parseInt(loanFilter));
        }
        if (statusFilter) {
          allPayments = allPayments.filter(p => p.status === statusFilter);
        }

        // Sort by date
        allPayments.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

        tbody.innerHTML = allPayments.map((payment, idx) => {
          const dueDate = new Date(payment.dueDate);
          const today = new Date();
          const status = payment.status === 'paid' ? 'paid' : (dueDate < today ? 'overdue' : 'upcoming');

          return `
            <tr>
              <td>${payment.paymentNumber}</td>
              <td>${dueDate.toLocaleDateString()}</td>
              <td>${payment.borrowerName}</td>
              <td>$${payment.principalPayment.toFixed(2)}</td>
              <td>$${payment.interestPayment.toFixed(2)}</td>
              <td>$${(payment.principalPayment + payment.interestPayment).toFixed(2)}</td>
              <td>$${payment.balance.toFixed(2)}</td>
              <td><span class="badge badge-${status}">${status}</span></td>
              <td>
                <button class="btn btn-sm btn-success btn-record-payment" data-id="${payment.paymentKey}" data-schedule="${JSON.stringify(payment).replace(/"/g, '&quot;')}">Record</button>
              </td>
            </tr>
          `;
        }).join('');

        if (allPayments.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem;">No payments scheduled.</td></tr>';
        }
      }

      recordLoanPayment(paymentId, scheduleString) {
        const payment = JSON.parse(scheduleString.replace(/&quot;/g, '"'));
        const [loanId, paymentIdx] = paymentId.split('-');
        
        const loan = this.loans.find(l => l.id === parseInt(loanId));
        if (!loan) return;

        // Record the payment
        const paymentRecord = {
          id: Date.now(),
          loanId: parseInt(loanId),
          paymentNumber: payment.paymentNumber,
          amount: payment.principalPayment + payment.interestPayment,
          principalApplied: payment.principalPayment,
          interestApplied: payment.interestPayment,
          dateRecorded: new Date().toISOString(),
          status: 'paid'
        };

        this.loanPayments.push(paymentRecord);

        // Update schedule status
        if (this.amortizationSchedules[loanId]) {
          this.amortizationSchedules[loanId][parseInt(paymentIdx)].status = 'paid';
        }

        // Update loan balance
        loan.balance = Math.max(0, (loan.balance || loan.principal) - payment.principalPayment);

        this.saveToStorage();
        this.renderPaymentSchedule();
        this.notify(`Payment of $${paymentRecord.amount.toFixed(2)} recorded for ${loan.borrowerName}`, 'success');
      }

      showAddLoanModal() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>Add New Loan</h2>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Borrower Name</label>
                <input class="form-control" id="borrowerName" type="text" />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Principal Amount ($)</label>
                  <input class="form-control" id="principal" type="number" step="0.01" />
                </div>
                <div class="form-group">
                  <label class="form-label">Annual Interest Rate (%)</label>
                  <input class="form-control" id="annualRate" type="number" step="0.01" value="5.50" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Loan Term (Months)</label>
                  <input class="form-control" id="term" type="number" step="1" value="60" />
                </div>
                <div class="form-group">
                  <label class="form-label">Payment Frequency</label>
                  <select class="form-control" id="frequency">
                    <option value="weekly">Weekly</option>
                    <option value="biweekly">Bi-Weekly</option>
                    <option value="monthly" selected>Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="semiannual">Semi-Annual</option>
                    <option value="annual">Annual</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Funding Date</label>
                <input class="form-control" id="fundingDate" type="date" />
              </div>
              <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-control" id="notes"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
              <button class="btn btn-primary" id="saveLoanBtn">Add Loan</button>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').appendChild(modal);

        // Set default funding date to today
        document.getElementById('fundingDate').valueAsDate = new Date();

        document.getElementById('saveLoanBtn').addEventListener('click', () => {
          const borrowerName = document.getElementById('borrowerName').value.trim();
          const principal = parseFloat(document.getElementById('principal').value);
          const annualRate = parseFloat(document.getElementById('annualRate').value) / 100;
          const termMonths = parseFloat(document.getElementById('term').value);
          const frequency = document.getElementById('frequency').value;
          const fundingDate = document.getElementById('fundingDate').value;
          const notes = document.getElementById('notes').value;

          if (!borrowerName || !principal || !fundingDate || !termMonths) {
            this.notify('Please fill in all required fields', 'error');
            return;
          }

          const monthlyPayment = LoanCalculationEngine.calculatePaymentForFrequency(principal, annualRate, termMonths, frequency);

          const loan = {
            id: Date.now(),
            borrowerName,
            principal,
            balance: principal,
            annualRate,
            termMonths: termMonths,
            frequency,
            fundingDate: new Date(fundingDate),
            monthlyPayment,
            notes,
            createdAt: new Date().toISOString(),
            userId: this.currentUser.id
          };

          this.loans.push(loan);

          // Generate amortization schedule
          this.amortizationSchedules[loan.id] = LoanCalculationEngine.generateAmortizationSchedule(loan);

          this.saveToStorage();
          modal.remove();
          this.renderLoans();
          this.renderPaymentSchedule();
          this.populateFilters();
          this.renderDashboard();
          this.notify(`Loan for ${borrowerName} added successfully`, 'success');
        });
      }

      editLoan(loanId) {
        const loan = this.loans.find(l => l.id === loanId);
        if (!loan) return;

        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>Edit Loan</h2>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Borrower Name</label>
                <input class="form-control" id="borrowerName" type="text" value="${loan.borrowerName}" />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Principal Amount ($)</label>
                  <input class="form-control" id="principal" type="number" step="0.01" value="${loan.principal}" disabled />
                </div>
                <div class="form-group">
                  <label class="form-label">Annual Interest Rate (%)</label>
                  <input class="form-control" id="annualRate" type="number" step="0.01" value="${(loan.annualRate * 100).toFixed(2)}" />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-control" id="notes">${loan.notes || ''}</textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
              <button class="btn btn-primary" id="updateLoanBtn">Update</button>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').appendChild(modal);

        document.getElementById('updateLoanBtn').addEventListener('click', () => {
          loan.borrowerName = document.getElementById('borrowerName').value.trim();
          loan.annualRate = parseFloat(document.getElementById('annualRate').value) / 100;
          loan.notes = document.getElementById('notes').value;

          this.saveToStorage();
          modal.remove();
          this.renderLoans();
          this.notify('Loan updated successfully', 'success');
        });
      }

      deleteLoan(loanId) {
        if (confirm('Are you sure you want to delete this loan? This action cannot be undone.')) {
          const loanIndex = this.loans.findIndex(l => l.id === loanId);
          if (loanIndex > -1) {
            const loanName = this.loans[loanIndex].borrowerName;
            this.loans.splice(loanIndex, 1);
            delete this.amortizationSchedules[loanId];
            this.loanPayments = this.loanPayments.filter(p => p.loanId !== loanId);
            this.saveToStorage();
            this.renderLoans();
            this.renderPaymentSchedule();
            this.populateFilters();
            this.renderDashboard();
            this.notify(`Loan for ${loanName} deleted`, 'success');
          }
        }
      }

      populateFilters() {
        // Loan filter
        const loanFilter = document.getElementById('loanFilterDropdown');
        if (loanFilter) {
          loanFilter.innerHTML = '<option value="">All Loans</option>' + this.loans.map(l => 
            `<option value="${l.id}">${l.borrowerName}</option>`
          ).join('');
        }

        // Property filter
        const propertyFilter = document.getElementById('propertyFilterDropdown');
        if (propertyFilter) {
          propertyFilter.innerHTML = '<option value="">All Properties</option>' + this.properties.map(p => 
            `<option value="${p.id}">${p.address}</option>`
          ).join('');
        }
      }

      // ===== REAL ESTATE MANAGEMENT =====
      renderProperties() {
        const tbody = document.getElementById('propertiesBody');
        tbody.innerHTML = this.properties.map(property => {
          const tenants = this.tenants.filter(t => t.propertyId === property.id);
          const monthlyRent = tenants.reduce((sum, t) => sum + t.rentAmount, 0);

          return `
            <tr>
              <td>${property.address}</td>
              <td>${property.type}</td>
              <td>$${property.value.toFixed(0)}</td>
              <td>${tenants.length}</td>
              <td>$${monthlyRent.toFixed(2)}</td>
              <td><span class="badge badge-active">active</span></td>
              <td>
                <button class="btn btn-sm btn-outline btn-edit-property" data-id="${property.id}">Edit</button>
                <button class="btn btn-sm btn-danger btn-delete-property" data-id="${property.id}">Delete</button>
              </td>
            </tr>
          `;
        }).join('');

        if (this.properties.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No properties added yet. Click "Add Property" to get started.</td></tr>';
        }
      }

      renderTenants() {
        const tbody = document.getElementById('tenantsBody');
        tbody.innerHTML = this.tenants.map(tenant => {
          const property = this.properties.find(p => p.id === tenant.propertyId);
          const leaseStart = new Date(tenant.leaseStart).toLocaleDateString();
          const leaseEnd = new Date(tenant.leaseEnd).toLocaleDateString();

          return `
            <tr>
              <td>${tenant.name}</td>
              <td>${property?.address || 'N/A'}</td>
              <td>${tenant.unit}</td>
              <td>${leaseStart}</td>
              <td>${leaseEnd}</td>
              <td>$${tenant.rentAmount.toFixed(2)}</td>
              <td><span class="badge badge-${tenant.status === 'active' ? 'active' : 'pending'}">${tenant.status}</span></td>
              <td>
                <button class="btn btn-sm btn-outline btn-edit-tenant" data-id="${tenant.id}">Edit</button>
                <button class="btn btn-sm btn-danger btn-delete-tenant" data-id="${tenant.id}">Delete</button>
              </td>
            </tr>
          `;
        }).join('');

        if (this.tenants.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">No tenants added yet. Click "Add Tenant" to get started.</td></tr>';
        }
      }

      renderRentSchedule() {
        const tbody = document.getElementById('rentScheduleBody');
        const propertyFilter = document.getElementById('propertyFilterDropdown').value;

        let rentPaymentsList = [];

        // Generate upcoming rent payments for all active tenants
        this.tenants.forEach(tenant => {
          if (propertyFilter && tenant.propertyId !== parseInt(propertyFilter)) return;

          const property = this.properties.find(p => p.id === tenant.propertyId);
          const today = new Date();
          const leaseEnd = new Date(tenant.leaseEnd);

          // Generate next 12 months of rent payments
          for (let i = 0; i < 12; i++) {
            const paymentDate = new Date(today);
            paymentDate.setMonth(paymentDate.getMonth() + i);
            paymentDate.setDate(1); // Rent due on first of month

            if (paymentDate <= leaseEnd && tenant.status === 'active') {
              const isOverdue = paymentDate < today;
              const paymentRecord = this.rentPayments.find(p => 
                p.tenantId === tenant.id && 
                new Date(p.dueDate).toDateString() === paymentDate.toDateString()
              );

              rentPaymentsList.push({
                id: `${tenant.id}-${paymentDate.getTime()}`,
                tenantId: tenant.id,
                tenantName: tenant.name,
                propertyId: property?.id,
                propertyAddress: property?.address || 'N/A',
                amount: tenant.rentAmount,
                dueDate: paymentDate,
                status: paymentRecord?.status || (isOverdue ? 'overdue' : 'upcoming'),
                recorded: !!paymentRecord
              });
            }
          }
        });

        // Sort by date
        rentPaymentsList.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

        tbody.innerHTML = rentPaymentsList.map(payment => {
          return `
            <tr>
              <td>${payment.dueDate.toLocaleDateString()}</td>
              <td>${payment.tenantName}</td>
              <td>${payment.propertyAddress}</td>
              <td>$${payment.amount.toFixed(2)}</td>
              <td><span class="badge badge-${payment.status}">${payment.status}</span></td>
              <td>
                ${!payment.recorded ? `<button class="btn btn-sm btn-success btn-record-rent" data-id="${payment.id}">Record</button>` : '<span style="color: var(--text-light);">Recorded</span>'}
              </td>
            </tr>
          `;
        }).join('');

        if (rentPaymentsList.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No rent payments scheduled.</td></tr>';
        }
      }

      recordRentPayment(rentPaymentId) {
        const [tenantId, timestamp] = rentPaymentId.split('-');
        const tenant = this.tenants.find(t => t.id === parseInt(tenantId));
        
        if (!tenant) return;

        const dueDate = new Date(parseInt(timestamp));

        const rentPaymentRecord = {
          id: Date.now(),
          tenantId: parseInt(tenantId),
          tenantName: tenant.name,
          amount: tenant.rentAmount,
          dueDate: dueDate.toISOString(),
          dateRecorded: new Date().toISOString(),
          status: 'paid'
        };

        this.rentPayments.push(rentPaymentRecord);
        this.saveToStorage();
        this.renderRentSchedule();
        this.notify(`Rent payment of $${rentPaymentRecord.amount.toFixed(2)} recorded for ${tenant.name}`, 'success');
      }

      showAddPropertyModal() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>Add New Property</h2>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Property Address</label>
                <input class="form-control" id="address" type="text" />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Property Type</label>
                  <select class="form-control" id="propertyType">
                    <option value="residential">Residential</option>
                    <option value="commercial">Commercial</option>
                    <option value="industrial">Industrial</option>
                    <option value="mixed">Mixed-Use</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Property Value ($)</label>
                  <input class="form-control" id="propertyValue" type="number" step="0.01" />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-control" id="propertyNotes"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
              <button class="btn btn-primary" id="savePropertyBtn">Add Property</button>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').appendChild(modal);

        document.getElementById('savePropertyBtn').addEventListener('click', () => {
          const address = document.getElementById('address').value.trim();
          const type = document.getElementById('propertyType').value;
          const value = parseFloat(document.getElementById('propertyValue').value);
          const notes = document.getElementById('propertyNotes').value;

          if (!address || !value) {
            this.notify('Please fill in all required fields', 'error');
            return;
          }

          const property = {
            id: Date.now(),
            address,
            type,
            value,
            notes,
            createdAt: new Date().toISOString()
          };

          this.properties.push(property);
          this.saveToStorage();
          modal.remove();
          this.renderProperties();
          this.populateFilters();
          this.renderDashboard();
          this.notify(`Property at ${address} added successfully`, 'success');
        });
      }

      editProperty(propertyId) {
        const property = this.properties.find(p => p.id === propertyId);
        if (!property) return;

        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>Edit Property</h2>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Property Address</label>
                <input class="form-control" id="address" type="text" value="${property.address}" />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Property Type</label>
                  <select class="form-control" id="propertyType">
                    <option value="residential" ${property.type === 'residential' ? 'selected' : ''}>Residential</option>
                    <option value="commercial" ${property.type === 'commercial' ? 'selected' : ''}>Commercial</option>
                    <option value="industrial" ${property.type === 'industrial' ? 'selected' : ''}>Industrial</option>
                    <option value="mixed" ${property.type === 'mixed' ? 'selected' : ''}>Mixed-Use</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Property Value ($)</label>
                  <input class="form-control" id="propertyValue" type="number" step="0.01" value="${property.value}" />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-control" id="propertyNotes">${property.notes || ''}</textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
              <button class="btn btn-primary" id="updatePropertyBtn">Update</button>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').appendChild(modal);

        document.getElementById('updatePropertyBtn').addEventListener('click', () => {
          property.address = document.getElementById('address').value.trim();
          property.type = document.getElementById('propertyType').value;
          property.value = parseFloat(document.getElementById('propertyValue').value);
          property.notes = document.getElementById('propertyNotes').value;

          this.saveToStorage();
          modal.remove();
          this.renderProperties();
          this.notify('Property updated successfully', 'success');
        });
      }

      deleteProperty(propertyId) {
        if (confirm('Are you sure you want to delete this property? Associated tenants will also be deleted. This action cannot be undone.')) {
          const propertyIndex = this.properties.findIndex(p => p.id === propertyId);
          if (propertyIndex > -1) {
            const propertyAddress = this.properties[propertyIndex].address;
            this.properties.splice(propertyIndex, 1);
            this.tenants = this.tenants.filter(t => t.propertyId !== propertyId);
            this.rentPayments = this.rentPayments.filter(p => !this.tenants.find(t => t.id === p.tenantId));
            this.saveToStorage();
            this.renderProperties();
            this.renderTenants();
            this.renderRentSchedule();
            this.populateFilters();
            this.renderDashboard();
            this.notify(`Property at ${propertyAddress} deleted`, 'success');
          }
        }
      }

      showAddTenantModal() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>Add New Tenant</h2>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Tenant Name</label>
                <input class="form-control" id="tenantName" type="text" />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Property</label>
                  <select class="form-control" id="propertySelect">
                    <option value="">Select a property...</option>
                    ${this.properties.map(p => `<option value="${p.id}">${p.address}</option>`).join('')}
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Unit</label>
                  <input class="form-control" id="unit" type="text" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Lease Start Date</label>
                  <input class="form-control" id="leaseStart" type="date" />
                </div>
                <div class="form-group">
                  <label class="form-label">Lease End Date</label>
                  <input class="form-control" id="leaseEnd" type="date" />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Monthly Rent ($)</label>
                <input class="form-control" id="rentAmount" type="number" step="0.01" />
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
              <button class="btn btn-primary" id="saveTenantBtn">Add Tenant</button>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').appendChild(modal);

        document.getElementById('saveTenantBtn').addEventListener('click', () => {
          const name = document.getElementById('tenantName').value.trim();
          const propertyId = parseInt(document.getElementById('propertySelect').value);
          const unit = document.getElementById('unit').value.trim();
          const leaseStart = document.getElementById('leaseStart').value;
          const leaseEnd = document.getElementById('leaseEnd').value;
          const rentAmount = parseFloat(document.getElementById('rentAmount').value);

          if (!name || !propertyId || !unit || !leaseStart || !leaseEnd || !rentAmount) {
            this.notify('Please fill in all required fields', 'error');
            return;
          }

          const tenant = {
            id: Date.now(),
            name,
            propertyId,
            unit,
            leaseStart: new Date(leaseStart),
            leaseEnd: new Date(leaseEnd),
            rentAmount,
            status: 'active',
            createdAt: new Date().toISOString()
          };

          this.tenants.push(tenant);
          this.saveToStorage();
          modal.remove();
          this.renderTenants();
          this.renderRentSchedule();
          this.populateFilters();
          this.renderDashboard();
          this.notify(`Tenant ${name} added successfully`, 'success');
        });
      }

      editTenant(tenantId) {
        const tenant = this.tenants.find(t => t.id === tenantId);
        if (!tenant) return;

        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>Edit Tenant</h2>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Tenant Name</label>
                <input class="form-control" id="tenantName" type="text" value="${tenant.name}" />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Property</label>
                  <select class="form-control" id="propertySelect">
                    ${this.properties.map(p => `<option value="${p.id}" ${p.id === tenant.propertyId ? 'selected' : ''}>${p.address}</option>`).join('')}
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Unit</label>
                  <input class="form-control" id="unit" type="text" value="${tenant.unit}" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Lease Start Date</label>
                  <input class="form-control" id="leaseStart" type="date" value="${tenant.leaseStart instanceof Date ? tenant.leaseStart.toISOString().split('T')[0] : new Date(tenant.leaseStart).toISOString().split('T')[0]}" />
                </div>
                <div class="form-group">
                  <label class="form-label">Lease End Date</label>
                  <input class="form-control" id="leaseEnd" type="date" value="${tenant.leaseEnd instanceof Date ? tenant.leaseEnd.toISOString().split('T')[0] : new Date(tenant.leaseEnd).toISOString().split('T')[0]}" />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Monthly Rent ($)</label>
                <input class="form-control" id="rentAmount" type="number" step="0.01" value="${tenant.rentAmount}" />
              </div>
              <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-control" id="tenantStatus">
                  <option value="active" ${tenant.status === 'active' ? 'selected' : ''}>Active</option>
                  <option value="inactive" ${tenant.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
              <button class="btn btn-primary" id="updateTenantBtn">Update</button>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').appendChild(modal);

        document.getElementById('updateTenantBtn').addEventListener('click', () => {
          tenant.name = document.getElementById('tenantName').value.trim();
          tenant.propertyId = parseInt(document.getElementById('propertySelect').value);
          tenant.unit = document.getElementById('unit').value.trim();
          tenant.leaseStart = new Date(document.getElementById('leaseStart').value);
          tenant.leaseEnd = new Date(document.getElementById('leaseEnd').value);
          tenant.rentAmount = parseFloat(document.getElementById('rentAmount').value);
          tenant.status = document.getElementById('tenantStatus').value;

          this.saveToStorage();
          modal.remove();
          this.renderTenants();
          this.renderRentSchedule();
          this.notify('Tenant updated successfully', 'success');
        });
      }

      deleteTenant(tenantId) {
        if (confirm('Are you sure you want to delete this tenant? This action cannot be undone.')) {
          const tenantIndex = this.tenants.findIndex(t => t.id === tenantId);
          if (tenantIndex > -1) {
            const tenantName = this.tenants[tenantIndex].name;
            this.tenants.splice(tenantIndex, 1);
            this.rentPayments = this.rentPayments.filter(p => p.tenantId !== tenantId);
            this.saveToStorage();
            this.renderTenants();
            this.renderRentSchedule();
            this.renderDashboard();
            this.notify(`Tenant ${tenantName} deleted`, 'success');
          }
        }
      }s="badge badge-active">Active</span></td>
              <td>
                <button class="btn btn-sm btn-outline btn-edit-property" data-id="${property.id}">Edit</button>
                <button class="btn btn-sm btn-danger btn-delete-property" data-id="${property.id}">Delete</button>
              </td>
            </tr>
          `;
        }).join('');

        if (this.properties.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No properties added yet. Click "Add Property" to get started.</td></tr>';
        }
      }

      renderTenants() {
        const tbody = document.getElementById('tenantsBody');
        tbody.innerHTML = this.tenants.map(tenant => {
          const property = this.properties.find(p => p.id === tenant.propertyId);

          return `
            <tr>
              <td>${tenant.name}</td>
              <td>${property ? property.address : 'N/A'}</td>
              <td>${tenant.unit}</td>
              <td>${new Date(tenant.leaseStart).toLocaleDateString()}</td>
              <td>${new Date(tenant.leaseEnd).toLocaleDateString()}</td>
              <td>$${tenant.rentAmount.toFixed(2)}</td>
              <td><span class="badge badge-${tenant.status === 'active' ? 'active' : 'overdue'}">${tenant.status}</span></td>
              <td>
                <button class="btn btn-sm btn-outline btn-edit-tenant" data-id="${tenant.id}">Edit</button>
                <button class="btn btn-sm btn-danger btn-delete-tenant" data-id="${tenant.id}">Delete</button>
              </td>
            </tr>
          `;
        }).join('');

        if (this.tenants.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">No tenants added yet. Click "Add Tenant" to get started.</td></tr>';
        }
      }

      renderRentSchedule() {
        const tbody = document.getElementById('rentScheduleBody');
        const propertyFilter = document.getElementById('propertyFilterDropdown').value;

        let schedules = [];

        this.tenants.forEach(tenant => {
          if (propertyFilter && tenant.propertyId !== parseInt(propertyFilter)) return;

          const property = this.properties.find(p => p.id === tenant.propertyId);
          
          // Generate rent due dates for the year
          const now = new Date();
          let rentDate = new Date(Math.max(new Date(tenant.leaseStart).getTime(), new Date(now.getFullYear(), 0, 1).getTime()));

          while (rentDate <= new Date(now.getFullYear(), 11, 31)) {
            if (rentDate > new Date(tenant.leaseEnd)) break;

            const paymentRecord = this.rentPayments.find(p => 
              p.tenantId === tenant.id && p.dueDate === rentDate.toISOString().split('T')[0]
            );

            schedules.push({
              id: `${tenant.id}-${rentDate.toISOString().split('T')[0]}`,
              dueDate: new Date(rentDate),
              tenantId: tenant.id,
              tenantName: tenant.name,
              propertyId: tenant.propertyId,
              propertyAddress: property ? property.address : 'N/A',
              amount: tenant.rentAmount,
              status: paymentRecord ? paymentRecord.status : (new Date(rentDate) < now ? 'overdue' : 'upcoming'),
              paid: paymentRecord ? true : false
            });

            rentDate = new Date(rentDate.getFullYear(), rentDate.getMonth() + 1, rentDate.getDate());
          }
        });

        schedules.sort((a, b) => a.dueDate - b.dueDate);

        tbody.innerHTML = schedules.map(schedule => {
          return `
            <tr>
              <td>${schedule.dueDate.toLocaleDateString()}</td>
              <td>${schedule.tenantName}</td>
              <td>${schedule.propertyAddress}</td>
              <td>$${schedule.amount.toFixed(2)}</td>
              <td><span class="badge badge-${schedule.status}">${schedule.status}</span></td>
              <td>
                ${!schedule.paid ? `<button class="btn btn-sm btn-success btn-record-rent" data-id="${schedule.id}">Record Payment</button>` : '<span style="color: var(--text-light);">Paid</span>'}
              </td>
            </tr>
          `;
        }).join('');

        if (schedules.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No rent payments scheduled.</td></tr>';
        }
      }

      recordRentPayment(scheduleId) {
        const [tenantId, dueDate] = scheduleId.split('-').slice(0, 2).join('-').split('-');
        const [year, month, day] = scheduleId.split('-').slice(-3);
        const fullDate = `${year}-${month}-${day}`;

        const tenant = this.tenants.find(t => t.id === parseInt(tenantId));
        const property = this.properties.find(p => p.id === tenant.propertyId);

        if (confirm(`Record rent payment of $${tenant.rentAmount.toFixed(2)} for ${tenant.name}?`)) {
          const paymentRecord = {
            id: Date.now(),
            tenantId: tenant.id,
            propertyId: tenant.propertyId,
            dueDate: fullDate,
            amount: tenant.rentAmount,
            dateRecorded: new Date().toISOString(),
            status: 'paid'
          };

          this.rentPayments.push(paymentRecord);
          this.saveToStorage();
          this.renderRentSchedule();
          this.renderDashboard();
          this.notify(`Rent payment of $${tenant.rentAmount.toFixed(2)} recorded for ${tenant.name}`, 'success');
        }
      }

      showAddPropertyModal() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>Add New Property</h2>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Address</label>
                <input class="form-control" id="address" type="text" />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Property Type</label>
                  <select class="form-control" id="propertyType">
                    <option value="residential">Residential</option>
                    <option value="commercial">Commercial</option>
                    <option value="industrial">Industrial</option>
                    <option value="mixed">Mixed Use</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Property Value ($)</label>
                  <input class="form-control" id="value" type="number" step="0.01" />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="description"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
              <button class="btn btn-primary" id="savePropertyBtn">Add Property</button>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').appendChild(modal);

        document.getElementById('savePropertyBtn').addEventListener('click', () => {
          const address = document.getElementById('address').value.trim();
          const type = document.getElementById('propertyType').value;
          const value = parseFloat(document.getElementById('value').value);
          const description = document.getElementById('description').value;

          if (!address || !value) {
            this.notify('Please fill in all required fields', 'error');
            return;
          }

          const property = {
            id: Date.now(),
            address,
            type,
            value,
            description,
            createdAt: new Date().toISOString()
          };

          this.properties.push(property);
          this.saveToStorage();
          modal.remove();
          this.renderProperties();
          this.populateFilters();
          this.renderDashboard();
          this.notify(`Property at ${address} added successfully`, 'success');
        });
      }

      editProperty(propertyId) {
        const property = this.properties.find(p => p.id === propertyId);
        if (!property) return;

        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>Edit Property</h2>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Address</label>
                <input class="form-control" id="address" type="text" value="${property.address}" />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Property Type</label>
                  <select class="form-control" id="propertyType">
                    <option value="residential" ${property.type === 'residential' ? 'selected' : ''}>Residential</option>
                    <option value="commercial" ${property.type === 'commercial' ? 'selected' : ''}>Commercial</option>
                    <option value="industrial" ${property.type === 'industrial' ? 'selected' : ''}>Industrial</option>
                    <option value="mixed" ${property.type === 'mixed' ? 'selected' : ''}>Mixed Use</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Property Value ($)</label>
                  <input class="form-control" id="value" type="number" step="0.01" value="${property.value}" />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="description">${property.description || ''}</textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
              <button class="btn btn-primary" id="updatePropertyBtn">Update</button>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').appendChild(modal);

        document.getElementById('updatePropertyBtn').addEventListener('click', () => {
          property.address = document.getElementById('address').value.trim();
          property.type = document.getElementById('propertyType').value;
          property.value = parseFloat(document.getElementById('value').value);
          property.description = document.getElementById('description').value;

          this.saveToStorage();
          modal.remove();
          this.renderProperties();
          this.notify('Property updated successfully', 'success');
        });
      }

      deleteProperty(propertyId) {
        if (confirm('Are you sure you want to delete this property?')) {
          const propIndex = this.properties.findIndex(p => p.id === propertyId);
          if (propIndex > -1) {
            const address = this.properties[propIndex].address;
            this.properties.splice(propIndex, 1);
            this.tenants = this.tenants.filter(t => t.propertyId !== propertyId);
            this.saveToStorage();
            this.renderProperties();
            this.renderTenants();
            this.renderRentSchedule();
            this.populateFilters();
            this.renderDashboard();
            this.notify(`Property at ${address} deleted`, 'success');
          }
        }
      }

      showAddTenantModal() {
        if (this.properties.length === 0) {
          this.notify('Please add a property first', 'error');
          return;
        }

        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>Add New Tenant</h2>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Tenant Name</label>
                <input class="form-control" id="tenantName" type="text" />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Property</label>
                  <select class="form-control" id="property">
                    ${this.properties.map(p => `<option value="${p.id}">${p.address}</option>`).join('')}
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Unit Number</label>
                  <input class="form-control" id="unit" type="text" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Lease Start Date</label>
                  <input class="form-control" id="leaseStart" type="date" />
                </div>
                <div class="form-group">
                  <label class="form-label">Lease End Date</label>
                  <input class="form-control" id="leaseEnd" type="date" />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Monthly Rent ($)</label>
                <input class="form-control" id="rent" type="number" step="0.01" />
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
              <button class="btn btn-primary" id="saveTenantBtn">Add Tenant</button>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').appendChild(modal);

        // Set default dates
        const today = new Date();
        document.getElementById('leaseStart').valueAsDate = today;
        const oneYearFromNow = new Date(today.getFullYear() + 1, today.getMonth(), today.getDate());
        document.getElementById('leaseEnd').valueAsDate = oneYearFromNow;

        document.getElementById('saveTenantBtn').addEventListener('click', () => {
          const name = document.getElementById('tenantName').value.trim();
          const propertyId = parseInt(document.getElementById('property').value);
          const unit = document.getElementById('unit').value.trim();
          const leaseStart = document.getElementById('leaseStart').value;
          const leaseEnd = document.getElementById('leaseEnd').value;
          const rent = parseFloat(document.getElementById('rent').value);

          if (!name || !unit || !leaseStart || !leaseEnd || !rent) {
            this.notify('Please fill in all required fields', 'error');
            return;
          }

          const tenant = {
            id: Date.now(),
            name,
            propertyId,
            unit,
            leaseStart: new Date(leaseStart),
            leaseEnd: new Date(leaseEnd),
            rentAmount: rent,
            status: 'active',
            createdAt: new Date().toISOString()
          };

          this.tenants.push(tenant);
          this.saveToStorage();
          modal.remove();
          this.renderTenants();
          this.renderRentSchedule();
          this.populateFilters();
          this.renderDashboard();
          this.notify(`Tenant ${name} added successfully`, 'success');
        });
      }

      editTenant(tenantId) {
        const tenant = this.tenants.find(t => t.id === tenantId);
        if (!tenant) return;

        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>Edit Tenant</h2>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Tenant Name</label>
                <input class="form-control" id="tenantName" type="text" value="${tenant.name}" />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Property</label>
                  <select class="form-control" id="property">
                    ${this.properties.map(p => `<option value="${p.id}" ${p.id === tenant.propertyId ? 'selected' : ''}>${p.address}</option>`).join('')}
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Unit Number</label>
                  <input class="form-control" id="unit" type="text" value="${tenant.unit}" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Lease Start Date</label>
                  <input class="form-control" id="leaseStart" type="date" value="${new Date(tenant.leaseStart).toISOString().split('T')[0]}" />
                </div>
                <div class="form-group">
                  <label class="form-label">Lease End Date</label>
                  <input class="form-control" id="leaseEnd" type="date" value="${new Date(tenant.leaseEnd).toISOString().split('T')[0]}" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Monthly Rent ($)</label>
                  <input class="form-control" id="rent" type="number" step="0.01" value="${tenant.rentAmount}" />
                </div>
                <div class="form-group">
                  <label class="form-label">Status</label>
                  <select class="form-control" id="status">
                    <option value="active" ${tenant.status === 'active' ? 'selected' : ''}>Active</option>
                    <option value="inactive" ${tenant.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
              <button class="btn btn-primary" id="updateTenantBtn">Update</button>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').appendChild(modal);

        document.getElementById('updateTenantBtn').addEventListener('click', () => {
          tenant.name = document.getElementById('tenantName').value.trim();
          tenant.propertyId = parseInt(document.getElementById('property').value);
          tenant.unit = document.getElementById('unit').value.trim();
          tenant.leaseStart = new Date(document.getElementById('leaseStart').value);
          tenant.leaseEnd = new Date(document.getElementById('leaseEnd').value);
          tenant.rentAmount = parseFloat(document.getElementById('rent').value);
          tenant.status = document.getElementById('status').value;

          this.saveToStorage();
          modal.remove();
          this.renderTenants();
          this.renderRentSchedule();
          this.notify('Tenant updated successfully', 'success');
        });
      }

      deleteTenant(tenantId) {
        if (confirm('Are you sure you want to delete this tenant?')) {
          const tenantIndex = this.tenants.findIndex(t => t.id === tenantId);
          if (tenantIndex > -1) {
            const name = this.tenants[tenantIndex].name;
            this.tenants.splice(tenantIndex, 1);
            this.saveToStorage();
            this.renderTenants();
            this.renderRentSchedule();
            this.renderDashboard();
            this.notify(`Tenant ${name} deleted`, 'success');
          }
        }
      }

      // ===== REPORTS =====
      renderReports() {
        const tbody = document.getElementById('primeHistoryBody');
        
        // Sort history by date descending
        const sorted = [...this.primeRateHistory].sort((a, b) => 
          new Date(b.date) - new Date(a.date)
        );

        tbody.innerHTML = sorted.map((entry, idx) => {
          const previous = sorted[idx + 1]?.rate || entry.rate;
          const change = (entry.rate - previous).toFixed(2);

          return `
            <tr>
              <td>${new Date(entry.date).toLocaleDateString()}</td>
              <td>${entry.rate.toFixed(2)}%</td>
              <td>${previous.toFixed(2)}%</td>
              <td style="color: ${change >= 0 ? 'var(--error-red)' : 'var(--success-green)'};">${change >= 0 ? '+' : ''}${change}%</td>
            </tr>
          `;
        }).join('');
      }

      renderSettings() {
        document.getElementById('settingsPrimeRate').value = this.primeRate.toFixed(2);
      }

      showUpdatePrimeRateModal() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>Update Prime Rate</h2>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Current Prime Rate: ${this.primeRate.toFixed(2)}%</label>
              </div>
              <div class="form-group">
                <label class="form-label">New Prime Rate (%)</label>
                <input class="form-control" id="newPrimeRate" type="number" step="0.01" value="${this.primeRate.toFixed(2)}" />
              </div>
              <div class="form-group">
                <label class="form-label">Notes (Optional)</label>
                <textarea class="form-control" id="primeRateNotes"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
              <button class="btn btn-primary" id="savePrimeBtn">Update Rate</button>
            </div>
          </div>
        `;

        document.getElementById('modalContainer').appendChild(modal);

        document.getElementById('savePrimeBtn').addEventListener('click', () => {
          const newRate = parseFloat(document.getElementById('newPrimeRate').value);

          if (isNaN(newRate)) {
            this.notify('Please enter a valid rate', 'error');
            return;
          }

          this.primeRate = newRate;
          this.primeRateHistory.push({
            date: new Date().toISOString(),
            rate: newRate
          });

          this.saveToStorage();
          modal.remove();
          this.updatePrimeRateDisplay();
          this.renderReports();
          this.renderSettings();
          this.notify(`Prime rate updated to ${newRate.toFixed(2)}%`, 'success');
        });
      }

      savePrimeRateFromSettings() {
        const newRate = parseFloat(document.getElementById('settingsPrimeRate').value);

        if (isNaN(newRate)) {
          this.notify('Please enter a valid rate', 'error');
          return;
        }

        this.primeRate = newRate;
        this.primeRateHistory.push({
          date: new Date().toISOString(),
          rate: newRate
        });

        this.saveToStorage();
        this.updatePrimeRateDisplay();
        this.renderReports();
        this.notify(`Prime rate updated to ${newRate.toFixed(2)}%`, 'success');
      }

      updatePrimeRateDisplay() {
        document.getElementById('primeRateValue').textContent = this.primeRate.toFixed(2);
      }

      // ===== EXPORT FUNCTIONS =====
      exportLoansExcel() {
        const data = this.loans.map(loan => ({
          'Borrower': loan.borrowerName,
          'Principal': loan.principal,
          'Balance': loan.balance || loan.principal,
          'Rate (%)': (loan.annualRate * 100).toFixed(2),
          'Frequency': loan.frequency,
          'Payment': loan.monthlyPayment.toFixed(2),
          'Term (Years)': loan.term,
          'Funding Date': new Date(loan.fundingDate).toLocaleDateString()
        }));

        this.exportToExcel(data, 'Loans');
      }

      exportPaymentScheduleExcel() {
        const data = [];

        this.loans.forEach(loan => {
          const schedule = this.amortizationSchedules[loan.id] || [];
          schedule.forEach(payment => {
            data.push({
              'Borrower': loan.borrowerName,
              'Payment #': payment.paymentNumber,
              'Date': new Date(payment.dueDate).toLocaleDateString(),
              'Principal': payment.principalPayment.toFixed(2),
              'Interest': payment.interestPayment.toFixed(2),
              'Total': (payment.principalPayment + payment.interestPayment).toFixed(2),
              'Balance': payment.balance.toFixed(2),
              'Status': payment.status
            });
          });
        });

        this.exportToExcel(data, 'Payment Schedule');
      }

      exportPropertiesExcel() {
        const data = this.properties.map(property => {
          const tenants = this.tenants.filter(t => t.propertyId === property.id);
          const monthlyRent = tenants.reduce((sum, t) => sum + t.rentAmount, 0);

          return {
            'Address': property.address,
            'Type': property.type,
            'Value': property.value,
            'Tenants': tenants.length,
            'Monthly Rent': monthlyRent.toFixed(2),
            'Description': property.description || ''
          };
        });

        this.exportToExcel(data, 'Properties');
      }

      exportTenantsExcel() {
        const data = this.tenants.map(tenant => {
          const property = this.properties.find(p => p.id === tenant.propertyId);

          return {
            'Name': tenant.name,
            'Property': property ? property.address : 'N/A',
            'Unit': tenant.unit,
            'Lease Start': new Date(tenant.leaseStart).toLocaleDateString(),
            'Lease End': new Date(tenant.leaseEnd).toLocaleDateString(),
            'Monthly Rent': tenant.rentAmount.toFixed(2),
            'Status': tenant.status
          };
        });

        this.exportToExcel(data, 'Tenants');
      }

      exportRentScheduleExcel() {
        const data = [];

        this.tenants.forEach(tenant => {
          const property = this.properties.find(p => p.id === tenant.propertyId);

          let rentDate = new Date(tenant.leaseStart);
          while (rentDate <= new Date(tenant.leaseEnd)) {
            const dateStr = rentDate.toISOString().split('T')[0];
            const paymentRecord = this.rentPayments.find(p => 
              p.tenantId === tenant.id && p.dueDate === dateStr
            );

            data.push({
              'Date': rentDate.toLocaleDateString(),
              'Tenant': tenant.name,
              'Property': property ? property.address : 'N/A',
              'Amount': tenant.rentAmount.toFixed(2),
              'Status': paymentRecord ? 'Paid' : (new Date(rentDate) < new Date() ? 'Overdue' : 'Upcoming'),
              'Paid Date': paymentRecord ? new Date(paymentRecord.dateRecorded).toLocaleDateString() : ''
            });

            rentDate = new Date(rentDate.getFullYear(), rentDate.getMonth() + 1, rentDate.getDate());
          }
        });

        this.exportToExcel(data, 'Rent Schedule');
      }

      exportToExcel(data, sheetName) {
        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
        XLSX.writeFile(workbook, `${sheetName}_${new Date().toISOString().split('T')[0]}.xlsx`);
        this.notify(`${sheetName} exported successfully`, 'success');
      }

      // ===== STORAGE =====
      saveToStorage() {
        // Use global keys so all users see the same data
        localStorage.setItem('lindan_primeRate', this.primeRate.toString());
        localStorage.setItem('lindan_primeRateHistory', JSON.stringify(this.primeRateHistory));
        localStorage.setItem('lindan_loans', JSON.stringify(this.loans));
        localStorage.setItem('lindan_loanPayments', JSON.stringify(this.loanPayments));
        localStorage.setItem('lindan_amortizationSchedules', JSON.stringify(this.amortizationSchedules));
        localStorage.setItem('lindan_properties', JSON.stringify(this.properties));
        localStorage.setItem('lindan_tenants', JSON.stringify(this.tenants));
        localStorage.setItem('lindan_rentPayments', JSON.stringify(this.rentPayments));
        localStorage.setItem('lindan_users', JSON.stringify(this.users));
      }

      // ===== NOTIFICATIONS =====
      notify(message, type = 'success') {
        const container = document.getElementById('notificationContainer');
        const notification = document.createElement('div');
        notification.className = `notification ${type === 'error' ? 'error' : ''}`;
        notification.textContent = message;

        container.appendChild(notification);

        setTimeout(() => notification.remove(), 4000);
      }
    }

    // Initialize system
    const system = new ProfessionalBankingSystem();
  </script>
</body>
</html>
